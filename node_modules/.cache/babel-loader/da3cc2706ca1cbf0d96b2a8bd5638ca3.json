{"remainingRequest":"/Users/luke/Documents/VUE/bt-starter/node_modules/thread-loader/dist/cjs.js!/Users/luke/Documents/VUE/bt-starter/node_modules/babel-loader/lib/index.js!/Users/luke/Documents/VUE/bt-starter/node_modules/moment/moment.js","dependencies":[{"path":"/Users/luke/Documents/VUE/bt-starter/node_modules/moment/moment.js","mtime":499162500000},{"path":"/Users/luke/Documents/VUE/bt-starter/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/luke/Documents/VUE/bt-starter/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/luke/Documents/VUE/bt-starter/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbC5kZXNjcmlwdGlvbiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZpbHRlciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZvci1lYWNoIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaW5kZXgtb2YiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5qb2luIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkubWFwIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc2xpY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zb21lIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuZnVuY3Rpb24ubmFtZSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm51bWJlci50by1maXhlZCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5nZXQtb3duLXByb3BlcnR5LW5hbWVzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmlzLWZyb3plbiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5rZXlzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LnRvLXN0cmluZyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5jb25zdHJ1Y3RvciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5leGVjIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLnRvLXN0cmluZyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5tYXRjaCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5yZXBsYWNlIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnNwbGl0Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvd2ViLmRvbS1jb2xsZWN0aW9ucy5mb3ItZWFjaCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi51cmwudG8tanNvbiIpOwoKdmFyIF90eXBlb2YgPSByZXF1aXJlKCIvVXNlcnMvbHVrZS9Eb2N1bWVudHMvVlVFL2J0LXN0YXJ0ZXIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvdHlwZW9mIik7CgovLyEgbW9tZW50LmpzCi8vISB2ZXJzaW9uIDogMi4yOS4xCi8vISBhdXRob3JzIDogVGltIFdvb2QsIElza3JlbiBDaGVybmV2LCBNb21lbnQuanMgY29udHJpYnV0b3JzCi8vISBsaWNlbnNlIDogTUlUCi8vISBtb21lbnRqcy5jb20KOwoKKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICAodHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKGV4cG9ydHMpKSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6IHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCA/IGRlZmluZShmYWN0b3J5KSA6IGdsb2JhbC5tb21lbnQgPSBmYWN0b3J5KCk7Cn0pKHRoaXMsIGZ1bmN0aW9uICgpIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBob29rQ2FsbGJhY2s7CgogIGZ1bmN0aW9uIGhvb2tzKCkgewogICAgcmV0dXJuIGhvb2tDYWxsYmFjay5hcHBseShudWxsLCBhcmd1bWVudHMpOwogIH0gLy8gVGhpcyBpcyBkb25lIHRvIHJlZ2lzdGVyIHRoZSBtZXRob2QgY2FsbGVkIHdpdGggbW9tZW50KCkKICAvLyB3aXRob3V0IGNyZWF0aW5nIGNpcmN1bGFyIGRlcGVuZGVuY2llcy4KCgogIGZ1bmN0aW9uIHNldEhvb2tDYWxsYmFjayhjYWxsYmFjaykgewogICAgaG9va0NhbGxiYWNrID0gY2FsbGJhY2s7CiAgfQoKICBmdW5jdGlvbiBpc0FycmF5KGlucHV0KSB7CiAgICByZXR1cm4gaW5wdXQgaW5zdGFuY2VvZiBBcnJheSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBBcnJheV0nOwogIH0KCiAgZnVuY3Rpb24gaXNPYmplY3QoaW5wdXQpIHsKICAgIC8vIElFOCB3aWxsIHRyZWF0IHVuZGVmaW5lZCBhbmQgbnVsbCBhcyBvYmplY3QgaWYgaXQgd2Fzbid0IGZvcgogICAgLy8gaW5wdXQgIT0gbnVsbAogICAgcmV0dXJuIGlucHV0ICE9IG51bGwgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgT2JqZWN0XSc7CiAgfQoKICBmdW5jdGlvbiBoYXNPd25Qcm9wKGEsIGIpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYSwgYik7CiAgfQoKICBmdW5jdGlvbiBpc09iamVjdEVtcHR5KG9iaikgewogICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhvYmopLmxlbmd0aCA9PT0gMDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBrOwoKICAgICAgZm9yIChrIGluIG9iaikgewogICAgICAgIGlmIChoYXNPd25Qcm9wKG9iaiwgaykpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNVbmRlZmluZWQoaW5wdXQpIHsKICAgIHJldHVybiBpbnB1dCA9PT0gdm9pZCAwOwogIH0KCiAgZnVuY3Rpb24gaXNOdW1iZXIoaW5wdXQpIHsKICAgIHJldHVybiB0eXBlb2YgaW5wdXQgPT09ICdudW1iZXInIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpbnB1dCkgPT09ICdbb2JqZWN0IE51bWJlcl0nOwogIH0KCiAgZnVuY3Rpb24gaXNEYXRlKGlucHV0KSB7CiAgICByZXR1cm4gaW5wdXQgaW5zdGFuY2VvZiBEYXRlIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpbnB1dCkgPT09ICdbb2JqZWN0IERhdGVdJzsKICB9CgogIGZ1bmN0aW9uIG1hcChhcnIsIGZuKSB7CiAgICB2YXIgcmVzID0gW10sCiAgICAgICAgaTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgKytpKSB7CiAgICAgIHJlcy5wdXNoKGZuKGFycltpXSwgaSkpOwogICAgfQoKICAgIHJldHVybiByZXM7CiAgfQoKICBmdW5jdGlvbiBleHRlbmQoYSwgYikgewogICAgZm9yICh2YXIgaSBpbiBiKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wKGIsIGkpKSB7CiAgICAgICAgYVtpXSA9IGJbaV07CiAgICAgIH0KICAgIH0KCiAgICBpZiAoaGFzT3duUHJvcChiLCAndG9TdHJpbmcnKSkgewogICAgICBhLnRvU3RyaW5nID0gYi50b1N0cmluZzsKICAgIH0KCiAgICBpZiAoaGFzT3duUHJvcChiLCAndmFsdWVPZicpKSB7CiAgICAgIGEudmFsdWVPZiA9IGIudmFsdWVPZjsKICAgIH0KCiAgICByZXR1cm4gYTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVVUQyhpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCkgewogICAgcmV0dXJuIGNyZWF0ZUxvY2FsT3JVVEMoaW5wdXQsIGZvcm1hdCwgbG9jYWxlLCBzdHJpY3QsIHRydWUpLnV0YygpOwogIH0KCiAgZnVuY3Rpb24gZGVmYXVsdFBhcnNpbmdGbGFncygpIHsKICAgIC8vIFdlIG5lZWQgdG8gZGVlcCBjbG9uZSB0aGlzIG9iamVjdC4KICAgIHJldHVybiB7CiAgICAgIGVtcHR5OiBmYWxzZSwKICAgICAgdW51c2VkVG9rZW5zOiBbXSwKICAgICAgdW51c2VkSW5wdXQ6IFtdLAogICAgICBvdmVyZmxvdzogLTIsCiAgICAgIGNoYXJzTGVmdE92ZXI6IDAsCiAgICAgIG51bGxJbnB1dDogZmFsc2UsCiAgICAgIGludmFsaWRFcmE6IG51bGwsCiAgICAgIGludmFsaWRNb250aDogbnVsbCwKICAgICAgaW52YWxpZEZvcm1hdDogZmFsc2UsCiAgICAgIHVzZXJJbnZhbGlkYXRlZDogZmFsc2UsCiAgICAgIGlzbzogZmFsc2UsCiAgICAgIHBhcnNlZERhdGVQYXJ0czogW10sCiAgICAgIGVyYTogbnVsbCwKICAgICAgbWVyaWRpZW06IG51bGwsCiAgICAgIHJmYzI4MjI6IGZhbHNlLAogICAgICB3ZWVrZGF5TWlzbWF0Y2g6IGZhbHNlCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZ2V0UGFyc2luZ0ZsYWdzKG0pIHsKICAgIGlmIChtLl9wZiA9PSBudWxsKSB7CiAgICAgIG0uX3BmID0gZGVmYXVsdFBhcnNpbmdGbGFncygpOwogICAgfQoKICAgIHJldHVybiBtLl9wZjsKICB9CgogIHZhciBzb21lOwoKICBpZiAoQXJyYXkucHJvdG90eXBlLnNvbWUpIHsKICAgIHNvbWUgPSBBcnJheS5wcm90b3R5cGUuc29tZTsKICB9IGVsc2UgewogICAgc29tZSA9IGZ1bmN0aW9uIHNvbWUoZnVuKSB7CiAgICAgIHZhciB0ID0gT2JqZWN0KHRoaXMpLAogICAgICAgICAgbGVuID0gdC5sZW5ndGggPj4+IDAsCiAgICAgICAgICBpOwoKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGkgaW4gdCAmJiBmdW4uY2FsbCh0aGlzLCB0W2ldLCBpLCB0KSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaXNWYWxpZChtKSB7CiAgICBpZiAobS5faXNWYWxpZCA9PSBudWxsKSB7CiAgICAgIHZhciBmbGFncyA9IGdldFBhcnNpbmdGbGFncyhtKSwKICAgICAgICAgIHBhcnNlZFBhcnRzID0gc29tZS5jYWxsKGZsYWdzLnBhcnNlZERhdGVQYXJ0cywgZnVuY3Rpb24gKGkpIHsKICAgICAgICByZXR1cm4gaSAhPSBudWxsOwogICAgICB9KSwKICAgICAgICAgIGlzTm93VmFsaWQgPSAhaXNOYU4obS5fZC5nZXRUaW1lKCkpICYmIGZsYWdzLm92ZXJmbG93IDwgMCAmJiAhZmxhZ3MuZW1wdHkgJiYgIWZsYWdzLmludmFsaWRFcmEgJiYgIWZsYWdzLmludmFsaWRNb250aCAmJiAhZmxhZ3MuaW52YWxpZFdlZWtkYXkgJiYgIWZsYWdzLndlZWtkYXlNaXNtYXRjaCAmJiAhZmxhZ3MubnVsbElucHV0ICYmICFmbGFncy5pbnZhbGlkRm9ybWF0ICYmICFmbGFncy51c2VySW52YWxpZGF0ZWQgJiYgKCFmbGFncy5tZXJpZGllbSB8fCBmbGFncy5tZXJpZGllbSAmJiBwYXJzZWRQYXJ0cyk7CgogICAgICBpZiAobS5fc3RyaWN0KSB7CiAgICAgICAgaXNOb3dWYWxpZCA9IGlzTm93VmFsaWQgJiYgZmxhZ3MuY2hhcnNMZWZ0T3ZlciA9PT0gMCAmJiBmbGFncy51bnVzZWRUb2tlbnMubGVuZ3RoID09PSAwICYmIGZsYWdzLmJpZ0hvdXIgPT09IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgaWYgKE9iamVjdC5pc0Zyb3plbiA9PSBudWxsIHx8ICFPYmplY3QuaXNGcm96ZW4obSkpIHsKICAgICAgICBtLl9pc1ZhbGlkID0gaXNOb3dWYWxpZDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaXNOb3dWYWxpZDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBtLl9pc1ZhbGlkOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlSW52YWxpZChmbGFncykgewogICAgdmFyIG0gPSBjcmVhdGVVVEMoTmFOKTsKCiAgICBpZiAoZmxhZ3MgIT0gbnVsbCkgewogICAgICBleHRlbmQoZ2V0UGFyc2luZ0ZsYWdzKG0pLCBmbGFncyk7CiAgICB9IGVsc2UgewogICAgICBnZXRQYXJzaW5nRmxhZ3MobSkudXNlckludmFsaWRhdGVkID0gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gbTsKICB9IC8vIFBsdWdpbnMgdGhhdCBhZGQgcHJvcGVydGllcyBzaG91bGQgYWxzbyBhZGQgdGhlIGtleSBoZXJlIChudWxsIHZhbHVlKSwKICAvLyBzbyB3ZSBjYW4gcHJvcGVybHkgY2xvbmUgb3Vyc2VsdmVzLgoKCiAgdmFyIG1vbWVudFByb3BlcnRpZXMgPSBob29rcy5tb21lbnRQcm9wZXJ0aWVzID0gW10sCiAgICAgIHVwZGF0ZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCiAgZnVuY3Rpb24gY29weUNvbmZpZyh0bywgZnJvbSkgewogICAgdmFyIGksIHByb3AsIHZhbDsKCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX2lzQU1vbWVudE9iamVjdCkpIHsKICAgICAgdG8uX2lzQU1vbWVudE9iamVjdCA9IGZyb20uX2lzQU1vbWVudE9iamVjdDsKICAgIH0KCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX2kpKSB7CiAgICAgIHRvLl9pID0gZnJvbS5faTsKICAgIH0KCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX2YpKSB7CiAgICAgIHRvLl9mID0gZnJvbS5fZjsKICAgIH0KCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX2wpKSB7CiAgICAgIHRvLl9sID0gZnJvbS5fbDsKICAgIH0KCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX3N0cmljdCkpIHsKICAgICAgdG8uX3N0cmljdCA9IGZyb20uX3N0cmljdDsKICAgIH0KCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX3R6bSkpIHsKICAgICAgdG8uX3R6bSA9IGZyb20uX3R6bTsKICAgIH0KCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX2lzVVRDKSkgewogICAgICB0by5faXNVVEMgPSBmcm9tLl9pc1VUQzsKICAgIH0KCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX29mZnNldCkpIHsKICAgICAgdG8uX29mZnNldCA9IGZyb20uX29mZnNldDsKICAgIH0KCiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX3BmKSkgewogICAgICB0by5fcGYgPSBnZXRQYXJzaW5nRmxhZ3MoZnJvbSk7CiAgICB9CgogICAgaWYgKCFpc1VuZGVmaW5lZChmcm9tLl9sb2NhbGUpKSB7CiAgICAgIHRvLl9sb2NhbGUgPSBmcm9tLl9sb2NhbGU7CiAgICB9CgogICAgaWYgKG1vbWVudFByb3BlcnRpZXMubGVuZ3RoID4gMCkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbW9tZW50UHJvcGVydGllcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb3AgPSBtb21lbnRQcm9wZXJ0aWVzW2ldOwogICAgICAgIHZhbCA9IGZyb21bcHJvcF07CgogICAgICAgIGlmICghaXNVbmRlZmluZWQodmFsKSkgewogICAgICAgICAgdG9bcHJvcF0gPSB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRvOwogIH0gLy8gTW9tZW50IHByb3RvdHlwZSBvYmplY3QKCgogIGZ1bmN0aW9uIE1vbWVudChjb25maWcpIHsKICAgIGNvcHlDb25maWcodGhpcywgY29uZmlnKTsKICAgIHRoaXMuX2QgPSBuZXcgRGF0ZShjb25maWcuX2QgIT0gbnVsbCA/IGNvbmZpZy5fZC5nZXRUaW1lKCkgOiBOYU4pOwoKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgdGhpcy5fZCA9IG5ldyBEYXRlKE5hTik7CiAgICB9IC8vIFByZXZlbnQgaW5maW5pdGUgbG9vcCBpbiBjYXNlIHVwZGF0ZU9mZnNldCBjcmVhdGVzIG5ldyBtb21lbnQKICAgIC8vIG9iamVjdHMuCgoKICAgIGlmICh1cGRhdGVJblByb2dyZXNzID09PSBmYWxzZSkgewogICAgICB1cGRhdGVJblByb2dyZXNzID0gdHJ1ZTsKICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMpOwogICAgICB1cGRhdGVJblByb2dyZXNzID0gZmFsc2U7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc01vbWVudChvYmopIHsKICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBNb21lbnQgfHwgb2JqICE9IG51bGwgJiYgb2JqLl9pc0FNb21lbnRPYmplY3QgIT0gbnVsbDsKICB9CgogIGZ1bmN0aW9uIHdhcm4obXNnKSB7CiAgICBpZiAoaG9va3Muc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmdzID09PSBmYWxzZSAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29uc29sZS53YXJuKSB7CiAgICAgIGNvbnNvbGUud2FybignRGVwcmVjYXRpb24gd2FybmluZzogJyArIG1zZyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZXByZWNhdGUobXNnLCBmbikgewogICAgdmFyIGZpcnN0VGltZSA9IHRydWU7CiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGhvb2tzLmRlcHJlY2F0aW9uSGFuZGxlciAhPSBudWxsKSB7CiAgICAgICAgaG9va3MuZGVwcmVjYXRpb25IYW5kbGVyKG51bGwsIG1zZyk7CiAgICAgIH0KCiAgICAgIGlmIChmaXJzdFRpbWUpIHsKICAgICAgICB2YXIgYXJncyA9IFtdLAogICAgICAgICAgICBhcmcsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGtleTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgYXJnID0gJyc7CgogICAgICAgICAgaWYgKF90eXBlb2YoYXJndW1lbnRzW2ldKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgYXJnICs9ICdcblsnICsgaSArICddICc7CgogICAgICAgICAgICBmb3IgKGtleSBpbiBhcmd1bWVudHNbMF0pIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcChhcmd1bWVudHNbMF0sIGtleSkpIHsKICAgICAgICAgICAgICAgIGFyZyArPSBrZXkgKyAnOiAnICsgYXJndW1lbnRzWzBdW2tleV0gKyAnLCAnOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXJnID0gYXJnLnNsaWNlKDAsIC0yKTsgLy8gUmVtb3ZlIHRyYWlsaW5nIGNvbW1hIGFuZCBzcGFjZQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXJnID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgfQoKICAgICAgICAgIGFyZ3MucHVzaChhcmcpOwogICAgICAgIH0KCiAgICAgICAgd2Fybihtc2cgKyAnXG5Bcmd1bWVudHM6ICcgKyBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmdzKS5qb2luKCcnKSArICdcbicgKyBuZXcgRXJyb3IoKS5zdGFjayk7CiAgICAgICAgZmlyc3RUaW1lID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwgZm4pOwogIH0KCiAgdmFyIGRlcHJlY2F0aW9ucyA9IHt9OwoKICBmdW5jdGlvbiBkZXByZWNhdGVTaW1wbGUobmFtZSwgbXNnKSB7CiAgICBpZiAoaG9va3MuZGVwcmVjYXRpb25IYW5kbGVyICE9IG51bGwpIHsKICAgICAgaG9va3MuZGVwcmVjYXRpb25IYW5kbGVyKG5hbWUsIG1zZyk7CiAgICB9CgogICAgaWYgKCFkZXByZWNhdGlvbnNbbmFtZV0pIHsKICAgICAgd2Fybihtc2cpOwogICAgICBkZXByZWNhdGlvbnNbbmFtZV0gPSB0cnVlOwogICAgfQogIH0KCiAgaG9va3Muc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmdzID0gZmFsc2U7CiAgaG9va3MuZGVwcmVjYXRpb25IYW5kbGVyID0gbnVsbDsKCiAgZnVuY3Rpb24gaXNGdW5jdGlvbihpbnB1dCkgewogICAgcmV0dXJuIHR5cGVvZiBGdW5jdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgaW5wdXQgaW5zdGFuY2VvZiBGdW5jdGlvbiB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBGdW5jdGlvbl0nOwogIH0KCiAgZnVuY3Rpb24gc2V0KGNvbmZpZykgewogICAgdmFyIHByb3AsIGk7CgogICAgZm9yIChpIGluIGNvbmZpZykgewogICAgICBpZiAoaGFzT3duUHJvcChjb25maWcsIGkpKSB7CiAgICAgICAgcHJvcCA9IGNvbmZpZ1tpXTsKCiAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvcCkpIHsKICAgICAgICAgIHRoaXNbaV0gPSBwcm9wOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzWydfJyArIGldID0gcHJvcDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9jb25maWcgPSBjb25maWc7IC8vIExlbmllbnQgb3JkaW5hbCBwYXJzaW5nIGFjY2VwdHMganVzdCBhIG51bWJlciBpbiBhZGRpdGlvbiB0bwogICAgLy8gbnVtYmVyICsgKHBvc3NpYmx5KSBzdHVmZiBjb21pbmcgZnJvbSBfZGF5T2ZNb250aE9yZGluYWxQYXJzZS4KICAgIC8vIFRPRE86IFJlbW92ZSAib3JkaW5hbFBhcnNlIiBmYWxsYmFjayBpbiBuZXh0IG1ham9yIHJlbGVhc2UuCgogICAgdGhpcy5fZGF5T2ZNb250aE9yZGluYWxQYXJzZUxlbmllbnQgPSBuZXcgUmVnRXhwKCh0aGlzLl9kYXlPZk1vbnRoT3JkaW5hbFBhcnNlLnNvdXJjZSB8fCB0aGlzLl9vcmRpbmFsUGFyc2Uuc291cmNlKSArICd8JyArIC9cZHsxLDJ9Ly5zb3VyY2UpOwogIH0KCiAgZnVuY3Rpb24gbWVyZ2VDb25maWdzKHBhcmVudENvbmZpZywgY2hpbGRDb25maWcpIHsKICAgIHZhciByZXMgPSBleHRlbmQoe30sIHBhcmVudENvbmZpZyksCiAgICAgICAgcHJvcDsKCiAgICBmb3IgKHByb3AgaW4gY2hpbGRDb25maWcpIHsKICAgICAgaWYgKGhhc093blByb3AoY2hpbGRDb25maWcsIHByb3ApKSB7CiAgICAgICAgaWYgKGlzT2JqZWN0KHBhcmVudENvbmZpZ1twcm9wXSkgJiYgaXNPYmplY3QoY2hpbGRDb25maWdbcHJvcF0pKSB7CiAgICAgICAgICByZXNbcHJvcF0gPSB7fTsKICAgICAgICAgIGV4dGVuZChyZXNbcHJvcF0sIHBhcmVudENvbmZpZ1twcm9wXSk7CiAgICAgICAgICBleHRlbmQocmVzW3Byb3BdLCBjaGlsZENvbmZpZ1twcm9wXSk7CiAgICAgICAgfSBlbHNlIGlmIChjaGlsZENvbmZpZ1twcm9wXSAhPSBudWxsKSB7CiAgICAgICAgICByZXNbcHJvcF0gPSBjaGlsZENvbmZpZ1twcm9wXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHJlc1twcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKHByb3AgaW4gcGFyZW50Q29uZmlnKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wKHBhcmVudENvbmZpZywgcHJvcCkgJiYgIWhhc093blByb3AoY2hpbGRDb25maWcsIHByb3ApICYmIGlzT2JqZWN0KHBhcmVudENvbmZpZ1twcm9wXSkpIHsKICAgICAgICAvLyBtYWtlIHN1cmUgY2hhbmdlcyB0byBwcm9wZXJ0aWVzIGRvbid0IG1vZGlmeSBwYXJlbnQgY29uZmlnCiAgICAgICAgcmVzW3Byb3BdID0gZXh0ZW5kKHt9LCByZXNbcHJvcF0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9CgogIGZ1bmN0aW9uIExvY2FsZShjb25maWcpIHsKICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICB0aGlzLnNldChjb25maWcpOwogICAgfQogIH0KCiAgdmFyIGtleXM7CgogIGlmIChPYmplY3Qua2V5cykgewogICAga2V5cyA9IE9iamVjdC5rZXlzOwogIH0gZWxzZSB7CiAgICBrZXlzID0gZnVuY3Rpb24ga2V5cyhvYmopIHsKICAgICAgdmFyIGksCiAgICAgICAgICByZXMgPSBbXTsKCiAgICAgIGZvciAoaSBpbiBvYmopIHsKICAgICAgICBpZiAoaGFzT3duUHJvcChvYmosIGkpKSB7CiAgICAgICAgICByZXMucHVzaChpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXM7CiAgICB9OwogIH0KCiAgdmFyIGRlZmF1bHRDYWxlbmRhciA9IHsKICAgIHNhbWVEYXk6ICdbVG9kYXkgYXRdIExUJywKICAgIG5leHREYXk6ICdbVG9tb3Jyb3cgYXRdIExUJywKICAgIG5leHRXZWVrOiAnZGRkZCBbYXRdIExUJywKICAgIGxhc3REYXk6ICdbWWVzdGVyZGF5IGF0XSBMVCcsCiAgICBsYXN0V2VlazogJ1tMYXN0XSBkZGRkIFthdF0gTFQnLAogICAgc2FtZUVsc2U6ICdMJwogIH07CgogIGZ1bmN0aW9uIGNhbGVuZGFyKGtleSwgbW9tLCBub3cpIHsKICAgIHZhciBvdXRwdXQgPSB0aGlzLl9jYWxlbmRhcltrZXldIHx8IHRoaXMuX2NhbGVuZGFyWydzYW1lRWxzZSddOwogICAgcmV0dXJuIGlzRnVuY3Rpb24ob3V0cHV0KSA/IG91dHB1dC5jYWxsKG1vbSwgbm93KSA6IG91dHB1dDsKICB9CgogIGZ1bmN0aW9uIHplcm9GaWxsKG51bWJlciwgdGFyZ2V0TGVuZ3RoLCBmb3JjZVNpZ24pIHsKICAgIHZhciBhYnNOdW1iZXIgPSAnJyArIE1hdGguYWJzKG51bWJlciksCiAgICAgICAgemVyb3NUb0ZpbGwgPSB0YXJnZXRMZW5ndGggLSBhYnNOdW1iZXIubGVuZ3RoLAogICAgICAgIHNpZ24gPSBudW1iZXIgPj0gMDsKICAgIHJldHVybiAoc2lnbiA/IGZvcmNlU2lnbiA/ICcrJyA6ICcnIDogJy0nKSArIE1hdGgucG93KDEwLCBNYXRoLm1heCgwLCB6ZXJvc1RvRmlsbCkpLnRvU3RyaW5nKCkuc3Vic3RyKDEpICsgYWJzTnVtYmVyOwogIH0KCiAgdmFyIGZvcm1hdHRpbmdUb2tlbnMgPSAvKFxbW15cW10qXF0pfChcXCk/KFtIaF1tbShzcyk/fE1vfE1NP00/TT98RG98REREb3xERD9EP0Q/fGRkZD9kP3xkbz98d1tvfHddP3xXW298V10/fFFvP3xOezEsNX18WVlZWVlZfFlZWVlZfFlZWVl8WVl8eXsyLDR9fHlvP3xnZyhnZ2c/KT98R0coR0dHPyk/fGV8RXxhfEF8aGg/fEhIP3xraz98bW0/fHNzP3xTezEsOX18eHxYfHp6P3xaWj98LikvZywKICAgICAgbG9jYWxGb3JtYXR0aW5nVG9rZW5zID0gLyhcW1teXFtdKlxdKXwoXFwpPyhMVFN8TFR8TEw/TD9MP3xsezEsNH0pL2csCiAgICAgIGZvcm1hdEZ1bmN0aW9ucyA9IHt9LAogICAgICBmb3JtYXRUb2tlbkZ1bmN0aW9ucyA9IHt9OyAvLyB0b2tlbjogICAgJ00nCiAgLy8gcGFkZGVkOiAgIFsnTU0nLCAyXQogIC8vIG9yZGluYWw6ICAnTW8nCiAgLy8gY2FsbGJhY2s6IGZ1bmN0aW9uICgpIHsgdGhpcy5tb250aCgpICsgMSB9CgogIGZ1bmN0aW9uIGFkZEZvcm1hdFRva2VuKHRva2VuLCBwYWRkZWQsIG9yZGluYWwsIGNhbGxiYWNrKSB7CiAgICB2YXIgZnVuYyA9IGNhbGxiYWNrOwoKICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdzdHJpbmcnKSB7CiAgICAgIGZ1bmMgPSBmdW5jdGlvbiBmdW5jKCkgewogICAgICAgIHJldHVybiB0aGlzW2NhbGxiYWNrXSgpOwogICAgICB9OwogICAgfQoKICAgIGlmICh0b2tlbikgewogICAgICBmb3JtYXRUb2tlbkZ1bmN0aW9uc1t0b2tlbl0gPSBmdW5jOwogICAgfQoKICAgIGlmIChwYWRkZWQpIHsKICAgICAgZm9ybWF0VG9rZW5GdW5jdGlvbnNbcGFkZGVkWzBdXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gemVyb0ZpbGwoZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpLCBwYWRkZWRbMV0sIHBhZGRlZFsyXSk7CiAgICAgIH07CiAgICB9CgogICAgaWYgKG9yZGluYWwpIHsKICAgICAgZm9ybWF0VG9rZW5GdW5jdGlvbnNbb3JkaW5hbF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLm9yZGluYWwoZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpLCB0b2tlbik7CiAgICAgIH07CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW1vdmVGb3JtYXR0aW5nVG9rZW5zKGlucHV0KSB7CiAgICBpZiAoaW5wdXQubWF0Y2goL1xbW1xzXFNdLykpIHsKICAgICAgcmV0dXJuIGlucHV0LnJlcGxhY2UoL15cW3xcXSQvZywgJycpOwogICAgfQoKICAgIHJldHVybiBpbnB1dC5yZXBsYWNlKC9cXC9nLCAnJyk7CiAgfQoKICBmdW5jdGlvbiBtYWtlRm9ybWF0RnVuY3Rpb24oZm9ybWF0KSB7CiAgICB2YXIgYXJyYXkgPSBmb3JtYXQubWF0Y2goZm9ybWF0dGluZ1Rva2VucyksCiAgICAgICAgaSwKICAgICAgICBsZW5ndGg7CgogICAgZm9yIChpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGZvcm1hdFRva2VuRnVuY3Rpb25zW2FycmF5W2ldXSkgewogICAgICAgIGFycmF5W2ldID0gZm9ybWF0VG9rZW5GdW5jdGlvbnNbYXJyYXlbaV1dOwogICAgICB9IGVsc2UgewogICAgICAgIGFycmF5W2ldID0gcmVtb3ZlRm9ybWF0dGluZ1Rva2VucyhhcnJheVtpXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gKG1vbSkgewogICAgICB2YXIgb3V0cHV0ID0gJycsCiAgICAgICAgICBpOwoKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgb3V0cHV0ICs9IGlzRnVuY3Rpb24oYXJyYXlbaV0pID8gYXJyYXlbaV0uY2FsbChtb20sIGZvcm1hdCkgOiBhcnJheVtpXTsKICAgICAgfQoKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH07CiAgfSAvLyBmb3JtYXQgZGF0ZSB1c2luZyBuYXRpdmUgZGF0ZSBvYmplY3QKCgogIGZ1bmN0aW9uIGZvcm1hdE1vbWVudChtLCBmb3JtYXQpIHsKICAgIGlmICghbS5pc1ZhbGlkKCkpIHsKICAgICAgcmV0dXJuIG0ubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICB9CgogICAgZm9ybWF0ID0gZXhwYW5kRm9ybWF0KGZvcm1hdCwgbS5sb2NhbGVEYXRhKCkpOwogICAgZm9ybWF0RnVuY3Rpb25zW2Zvcm1hdF0gPSBmb3JtYXRGdW5jdGlvbnNbZm9ybWF0XSB8fCBtYWtlRm9ybWF0RnVuY3Rpb24oZm9ybWF0KTsKICAgIHJldHVybiBmb3JtYXRGdW5jdGlvbnNbZm9ybWF0XShtKTsKICB9CgogIGZ1bmN0aW9uIGV4cGFuZEZvcm1hdChmb3JtYXQsIGxvY2FsZSkgewogICAgdmFyIGkgPSA1OwoKICAgIGZ1bmN0aW9uIHJlcGxhY2VMb25nRGF0ZUZvcm1hdFRva2VucyhpbnB1dCkgewogICAgICByZXR1cm4gbG9jYWxlLmxvbmdEYXRlRm9ybWF0KGlucHV0KSB8fCBpbnB1dDsKICAgIH0KCiAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMubGFzdEluZGV4ID0gMDsKCiAgICB3aGlsZSAoaSA+PSAwICYmIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy50ZXN0KGZvcm1hdCkpIHsKICAgICAgZm9ybWF0ID0gZm9ybWF0LnJlcGxhY2UobG9jYWxGb3JtYXR0aW5nVG9rZW5zLCByZXBsYWNlTG9uZ0RhdGVGb3JtYXRUb2tlbnMpOwogICAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMubGFzdEluZGV4ID0gMDsKICAgICAgaSAtPSAxOwogICAgfQoKICAgIHJldHVybiBmb3JtYXQ7CiAgfQoKICB2YXIgZGVmYXVsdExvbmdEYXRlRm9ybWF0ID0gewogICAgTFRTOiAnaDptbTpzcyBBJywKICAgIExUOiAnaDptbSBBJywKICAgIEw6ICdNTS9ERC9ZWVlZJywKICAgIExMOiAnTU1NTSBELCBZWVlZJywKICAgIExMTDogJ01NTU0gRCwgWVlZWSBoOm1tIEEnLAogICAgTExMTDogJ2RkZGQsIE1NTU0gRCwgWVlZWSBoOm1tIEEnCiAgfTsKCiAgZnVuY3Rpb24gbG9uZ0RhdGVGb3JtYXQoa2V5KSB7CiAgICB2YXIgZm9ybWF0ID0gdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5XSwKICAgICAgICBmb3JtYXRVcHBlciA9IHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleS50b1VwcGVyQ2FzZSgpXTsKCiAgICBpZiAoZm9ybWF0IHx8ICFmb3JtYXRVcHBlcikgewogICAgICByZXR1cm4gZm9ybWF0OwogICAgfQoKICAgIHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleV0gPSBmb3JtYXRVcHBlci5tYXRjaChmb3JtYXR0aW5nVG9rZW5zKS5tYXAoZnVuY3Rpb24gKHRvaykgewogICAgICBpZiAodG9rID09PSAnTU1NTScgfHwgdG9rID09PSAnTU0nIHx8IHRvayA9PT0gJ0REJyB8fCB0b2sgPT09ICdkZGRkJykgewogICAgICAgIHJldHVybiB0b2suc2xpY2UoMSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0b2s7CiAgICB9KS5qb2luKCcnKTsKICAgIHJldHVybiB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXldOwogIH0KCiAgdmFyIGRlZmF1bHRJbnZhbGlkRGF0ZSA9ICdJbnZhbGlkIGRhdGUnOwoKICBmdW5jdGlvbiBpbnZhbGlkRGF0ZSgpIHsKICAgIHJldHVybiB0aGlzLl9pbnZhbGlkRGF0ZTsKICB9CgogIHZhciBkZWZhdWx0T3JkaW5hbCA9ICclZCcsCiAgICAgIGRlZmF1bHREYXlPZk1vbnRoT3JkaW5hbFBhcnNlID0gL1xkezEsMn0vOwoKICBmdW5jdGlvbiBvcmRpbmFsKG51bWJlcikgewogICAgcmV0dXJuIHRoaXMuX29yZGluYWwucmVwbGFjZSgnJWQnLCBudW1iZXIpOwogIH0KCiAgdmFyIGRlZmF1bHRSZWxhdGl2ZVRpbWUgPSB7CiAgICBmdXR1cmU6ICdpbiAlcycsCiAgICBwYXN0OiAnJXMgYWdvJywKICAgIHM6ICdhIGZldyBzZWNvbmRzJywKICAgIHNzOiAnJWQgc2Vjb25kcycsCiAgICBtOiAnYSBtaW51dGUnLAogICAgbW06ICclZCBtaW51dGVzJywKICAgIGg6ICdhbiBob3VyJywKICAgIGhoOiAnJWQgaG91cnMnLAogICAgZDogJ2EgZGF5JywKICAgIGRkOiAnJWQgZGF5cycsCiAgICB3OiAnYSB3ZWVrJywKICAgIHd3OiAnJWQgd2Vla3MnLAogICAgTTogJ2EgbW9udGgnLAogICAgTU06ICclZCBtb250aHMnLAogICAgeTogJ2EgeWVhcicsCiAgICB5eTogJyVkIHllYXJzJwogIH07CgogIGZ1bmN0aW9uIHJlbGF0aXZlVGltZShudW1iZXIsIHdpdGhvdXRTdWZmaXgsIHN0cmluZywgaXNGdXR1cmUpIHsKICAgIHZhciBvdXRwdXQgPSB0aGlzLl9yZWxhdGl2ZVRpbWVbc3RyaW5nXTsKICAgIHJldHVybiBpc0Z1bmN0aW9uKG91dHB1dCkgPyBvdXRwdXQobnVtYmVyLCB3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKSA6IG91dHB1dC5yZXBsYWNlKC8lZC9pLCBudW1iZXIpOwogIH0KCiAgZnVuY3Rpb24gcGFzdEZ1dHVyZShkaWZmLCBvdXRwdXQpIHsKICAgIHZhciBmb3JtYXQgPSB0aGlzLl9yZWxhdGl2ZVRpbWVbZGlmZiA+IDAgPyAnZnV0dXJlJyA6ICdwYXN0J107CiAgICByZXR1cm4gaXNGdW5jdGlvbihmb3JtYXQpID8gZm9ybWF0KG91dHB1dCkgOiBmb3JtYXQucmVwbGFjZSgvJXMvaSwgb3V0cHV0KTsKICB9CgogIHZhciBhbGlhc2VzID0ge307CgogIGZ1bmN0aW9uIGFkZFVuaXRBbGlhcyh1bml0LCBzaG9ydGhhbmQpIHsKICAgIHZhciBsb3dlckNhc2UgPSB1bml0LnRvTG93ZXJDYXNlKCk7CiAgICBhbGlhc2VzW2xvd2VyQ2FzZV0gPSBhbGlhc2VzW2xvd2VyQ2FzZSArICdzJ10gPSBhbGlhc2VzW3Nob3J0aGFuZF0gPSB1bml0OwogIH0KCiAgZnVuY3Rpb24gbm9ybWFsaXplVW5pdHModW5pdHMpIHsKICAgIHJldHVybiB0eXBlb2YgdW5pdHMgPT09ICdzdHJpbmcnID8gYWxpYXNlc1t1bml0c10gfHwgYWxpYXNlc1t1bml0cy50b0xvd2VyQ2FzZSgpXSA6IHVuZGVmaW5lZDsKICB9CgogIGZ1bmN0aW9uIG5vcm1hbGl6ZU9iamVjdFVuaXRzKGlucHV0T2JqZWN0KSB7CiAgICB2YXIgbm9ybWFsaXplZElucHV0ID0ge30sCiAgICAgICAgbm9ybWFsaXplZFByb3AsCiAgICAgICAgcHJvcDsKCiAgICBmb3IgKHByb3AgaW4gaW5wdXRPYmplY3QpIHsKICAgICAgaWYgKGhhc093blByb3AoaW5wdXRPYmplY3QsIHByb3ApKSB7CiAgICAgICAgbm9ybWFsaXplZFByb3AgPSBub3JtYWxpemVVbml0cyhwcm9wKTsKCiAgICAgICAgaWYgKG5vcm1hbGl6ZWRQcm9wKSB7CiAgICAgICAgICBub3JtYWxpemVkSW5wdXRbbm9ybWFsaXplZFByb3BdID0gaW5wdXRPYmplY3RbcHJvcF07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG5vcm1hbGl6ZWRJbnB1dDsKICB9CgogIHZhciBwcmlvcml0aWVzID0ge307CgogIGZ1bmN0aW9uIGFkZFVuaXRQcmlvcml0eSh1bml0LCBwcmlvcml0eSkgewogICAgcHJpb3JpdGllc1t1bml0XSA9IHByaW9yaXR5OwogIH0KCiAgZnVuY3Rpb24gZ2V0UHJpb3JpdGl6ZWRVbml0cyh1bml0c09iaikgewogICAgdmFyIHVuaXRzID0gW10sCiAgICAgICAgdTsKCiAgICBmb3IgKHUgaW4gdW5pdHNPYmopIHsKICAgICAgaWYgKGhhc093blByb3AodW5pdHNPYmosIHUpKSB7CiAgICAgICAgdW5pdHMucHVzaCh7CiAgICAgICAgICB1bml0OiB1LAogICAgICAgICAgcHJpb3JpdHk6IHByaW9yaXRpZXNbdV0KICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIHVuaXRzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGEucHJpb3JpdHkgLSBiLnByaW9yaXR5OwogICAgfSk7CiAgICByZXR1cm4gdW5pdHM7CiAgfQoKICBmdW5jdGlvbiBpc0xlYXBZZWFyKHllYXIpIHsKICAgIHJldHVybiB5ZWFyICUgNCA9PT0gMCAmJiB5ZWFyICUgMTAwICE9PSAwIHx8IHllYXIgJSA0MDAgPT09IDA7CiAgfQoKICBmdW5jdGlvbiBhYnNGbG9vcihudW1iZXIpIHsKICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgIC8vIC0wIC0+IDAKICAgICAgcmV0dXJuIE1hdGguY2VpbChudW1iZXIpIHx8IDA7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gTWF0aC5mbG9vcihudW1iZXIpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdG9JbnQoYXJndW1lbnRGb3JDb2VyY2lvbikgewogICAgdmFyIGNvZXJjZWROdW1iZXIgPSArYXJndW1lbnRGb3JDb2VyY2lvbiwKICAgICAgICB2YWx1ZSA9IDA7CgogICAgaWYgKGNvZXJjZWROdW1iZXIgIT09IDAgJiYgaXNGaW5pdGUoY29lcmNlZE51bWJlcikpIHsKICAgICAgdmFsdWUgPSBhYnNGbG9vcihjb2VyY2VkTnVtYmVyKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICBmdW5jdGlvbiBtYWtlR2V0U2V0KHVuaXQsIGtlZXBUaW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgc2V0JDEodGhpcywgdW5pdCwgdmFsdWUpOwogICAgICAgIGhvb2tzLnVwZGF0ZU9mZnNldCh0aGlzLCBrZWVwVGltZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGdldCh0aGlzLCB1bml0KTsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGdldChtb20sIHVuaXQpIHsKICAgIHJldHVybiBtb20uaXNWYWxpZCgpID8gbW9tLl9kWydnZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArIHVuaXRdKCkgOiBOYU47CiAgfQoKICBmdW5jdGlvbiBzZXQkMShtb20sIHVuaXQsIHZhbHVlKSB7CiAgICBpZiAobW9tLmlzVmFsaWQoKSAmJiAhaXNOYU4odmFsdWUpKSB7CiAgICAgIGlmICh1bml0ID09PSAnRnVsbFllYXInICYmIGlzTGVhcFllYXIobW9tLnllYXIoKSkgJiYgbW9tLm1vbnRoKCkgPT09IDEgJiYgbW9tLmRhdGUoKSA9PT0gMjkpIHsKICAgICAgICB2YWx1ZSA9IHRvSW50KHZhbHVlKTsKCiAgICAgICAgbW9tLl9kWydzZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArIHVuaXRdKHZhbHVlLCBtb20ubW9udGgoKSwgZGF5c0luTW9udGgodmFsdWUsIG1vbS5tb250aCgpKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbW9tLl9kWydzZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArIHVuaXRdKHZhbHVlKTsKICAgICAgfQogICAgfQogIH0gLy8gTU9NRU5UUwoKCiAgZnVuY3Rpb24gc3RyaW5nR2V0KHVuaXRzKSB7CiAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKCiAgICBpZiAoaXNGdW5jdGlvbih0aGlzW3VuaXRzXSkpIHsKICAgICAgcmV0dXJuIHRoaXNbdW5pdHNdKCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBmdW5jdGlvbiBzdHJpbmdTZXQodW5pdHMsIHZhbHVlKSB7CiAgICBpZiAoX3R5cGVvZih1bml0cykgPT09ICdvYmplY3QnKSB7CiAgICAgIHVuaXRzID0gbm9ybWFsaXplT2JqZWN0VW5pdHModW5pdHMpOwogICAgICB2YXIgcHJpb3JpdGl6ZWQgPSBnZXRQcmlvcml0aXplZFVuaXRzKHVuaXRzKSwKICAgICAgICAgIGk7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgcHJpb3JpdGl6ZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzW3ByaW9yaXRpemVkW2ldLnVuaXRdKHVuaXRzW3ByaW9yaXRpemVkW2ldLnVuaXRdKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CgogICAgICBpZiAoaXNGdW5jdGlvbih0aGlzW3VuaXRzXSkpIHsKICAgICAgICByZXR1cm4gdGhpc1t1bml0c10odmFsdWUpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfQoKICB2YXIgbWF0Y2gxID0gL1xkLywKICAgICAgLy8gICAgICAgMCAtIDkKICBtYXRjaDIgPSAvXGRcZC8sCiAgICAgIC8vICAgICAgMDAgLSA5OQogIG1hdGNoMyA9IC9cZHszfS8sCiAgICAgIC8vICAgICAwMDAgLSA5OTkKICBtYXRjaDQgPSAvXGR7NH0vLAogICAgICAvLyAgICAwMDAwIC0gOTk5OQogIG1hdGNoNiA9IC9bKy1dP1xkezZ9LywKICAgICAgLy8gLTk5OTk5OSAtIDk5OTk5OQogIG1hdGNoMXRvMiA9IC9cZFxkPy8sCiAgICAgIC8vICAgICAgIDAgLSA5OQogIG1hdGNoM3RvNCA9IC9cZFxkXGRcZD8vLAogICAgICAvLyAgICAgOTk5IC0gOTk5OQogIG1hdGNoNXRvNiA9IC9cZFxkXGRcZFxkXGQ/LywKICAgICAgLy8gICA5OTk5OSAtIDk5OTk5OQogIG1hdGNoMXRvMyA9IC9cZHsxLDN9LywKICAgICAgLy8gICAgICAgMCAtIDk5OQogIG1hdGNoMXRvNCA9IC9cZHsxLDR9LywKICAgICAgLy8gICAgICAgMCAtIDk5OTkKICBtYXRjaDF0bzYgPSAvWystXT9cZHsxLDZ9LywKICAgICAgLy8gLTk5OTk5OSAtIDk5OTk5OQogIG1hdGNoVW5zaWduZWQgPSAvXGQrLywKICAgICAgLy8gICAgICAgMCAtIGluZgogIG1hdGNoU2lnbmVkID0gL1srLV0/XGQrLywKICAgICAgLy8gICAgLWluZiAtIGluZgogIG1hdGNoT2Zmc2V0ID0gL1p8WystXVxkXGQ6P1xkXGQvZ2ksCiAgICAgIC8vICswMDowMCAtMDA6MDAgKzAwMDAgLTAwMDAgb3IgWgogIG1hdGNoU2hvcnRPZmZzZXQgPSAvWnxbKy1dXGRcZCg/Ojo/XGRcZCk/L2dpLAogICAgICAvLyArMDAgLTAwICswMDowMCAtMDA6MDAgKzAwMDAgLTAwMDAgb3IgWgogIG1hdGNoVGltZXN0YW1wID0gL1srLV0/XGQrKFwuXGR7MSwzfSk/LywKICAgICAgLy8gMTIzNDU2Nzg5IDEyMzQ1Njc4OS4xMjMKICAvLyBhbnkgd29yZCAob3IgdHdvKSBjaGFyYWN0ZXJzIG9yIG51bWJlcnMgaW5jbHVkaW5nIHR3by90aHJlZSB3b3JkIG1vbnRoIGluIGFyYWJpYy4KICAvLyBpbmNsdWRlcyBzY290dGlzaCBnYWVsaWMgdHdvIHdvcmQgYW5kIGh5cGhlbmF0ZWQgbW9udGhzCiAgbWF0Y2hXb3JkID0gL1swLTldezAsMjU2fVsnYS16XHUwMEEwLVx1MDVGRlx1MDcwMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkYwN1x1RkYxMC1cdUZGRUZdezEsMjU2fXxbXHUwNjAwLVx1MDZGRlwvXXsxLDI1Nn0oXHMqP1tcdTA2MDAtXHUwNkZGXXsxLDI1Nn0pezEsMn0vaSwKICAgICAgcmVnZXhlczsKICByZWdleGVzID0ge307CgogIGZ1bmN0aW9uIGFkZFJlZ2V4VG9rZW4odG9rZW4sIHJlZ2V4LCBzdHJpY3RSZWdleCkgewogICAgcmVnZXhlc1t0b2tlbl0gPSBpc0Z1bmN0aW9uKHJlZ2V4KSA/IHJlZ2V4IDogZnVuY3Rpb24gKGlzU3RyaWN0LCBsb2NhbGVEYXRhKSB7CiAgICAgIHJldHVybiBpc1N0cmljdCAmJiBzdHJpY3RSZWdleCA/IHN0cmljdFJlZ2V4IDogcmVnZXg7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZ2V0UGFyc2VSZWdleEZvclRva2VuKHRva2VuLCBjb25maWcpIHsKICAgIGlmICghaGFzT3duUHJvcChyZWdleGVzLCB0b2tlbikpIHsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAodW5lc2NhcGVGb3JtYXQodG9rZW4pKTsKICAgIH0KCiAgICByZXR1cm4gcmVnZXhlc1t0b2tlbl0oY29uZmlnLl9zdHJpY3QsIGNvbmZpZy5fbG9jYWxlKTsKICB9IC8vIENvZGUgZnJvbSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM1NjE0OTMvaXMtdGhlcmUtYS1yZWdleHAtZXNjYXBlLWZ1bmN0aW9uLWluLWphdmFzY3JpcHQKCgogIGZ1bmN0aW9uIHVuZXNjYXBlRm9ybWF0KHMpIHsKICAgIHJldHVybiByZWdleEVzY2FwZShzLnJlcGxhY2UoJ1xcJywgJycpLnJlcGxhY2UoL1xcKFxbKXxcXChcXSl8XFsoW15cXVxbXSopXF18XFwoLikvZywgZnVuY3Rpb24gKG1hdGNoZWQsIHAxLCBwMiwgcDMsIHA0KSB7CiAgICAgIHJldHVybiBwMSB8fCBwMiB8fCBwMyB8fCBwNDsKICAgIH0pKTsKICB9CgogIGZ1bmN0aW9uIHJlZ2V4RXNjYXBlKHMpIHsKICAgIHJldHVybiBzLnJlcGxhY2UoL1stXC9cXF4kKis/LigpfFtcXXt9XS9nLCAnXFwkJicpOwogIH0KCiAgdmFyIHRva2VucyA9IHt9OwoKICBmdW5jdGlvbiBhZGRQYXJzZVRva2VuKHRva2VuLCBjYWxsYmFjaykgewogICAgdmFyIGksCiAgICAgICAgZnVuYyA9IGNhbGxiYWNrOwoKICAgIGlmICh0eXBlb2YgdG9rZW4gPT09ICdzdHJpbmcnKSB7CiAgICAgIHRva2VuID0gW3Rva2VuXTsKICAgIH0KCiAgICBpZiAoaXNOdW1iZXIoY2FsbGJhY2spKSB7CiAgICAgIGZ1bmMgPSBmdW5jdGlvbiBmdW5jKGlucHV0LCBhcnJheSkgewogICAgICAgIGFycmF5W2NhbGxiYWNrXSA9IHRvSW50KGlucHV0KTsKICAgICAgfTsKICAgIH0KCiAgICBmb3IgKGkgPSAwOyBpIDwgdG9rZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgdG9rZW5zW3Rva2VuW2ldXSA9IGZ1bmM7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhZGRXZWVrUGFyc2VUb2tlbih0b2tlbiwgY2FsbGJhY2spIHsKICAgIGFkZFBhcnNlVG9rZW4odG9rZW4sIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZywgdG9rZW4pIHsKICAgICAgY29uZmlnLl93ID0gY29uZmlnLl93IHx8IHt9OwogICAgICBjYWxsYmFjayhpbnB1dCwgY29uZmlnLl93LCBjb25maWcsIHRva2VuKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gYWRkVGltZVRvQXJyYXlGcm9tVG9rZW4odG9rZW4sIGlucHV0LCBjb25maWcpIHsKICAgIGlmIChpbnB1dCAhPSBudWxsICYmIGhhc093blByb3AodG9rZW5zLCB0b2tlbikpIHsKICAgICAgdG9rZW5zW3Rva2VuXShpbnB1dCwgY29uZmlnLl9hLCBjb25maWcsIHRva2VuKTsKICAgIH0KICB9CgogIHZhciBZRUFSID0gMCwKICAgICAgTU9OVEggPSAxLAogICAgICBEQVRFID0gMiwKICAgICAgSE9VUiA9IDMsCiAgICAgIE1JTlVURSA9IDQsCiAgICAgIFNFQ09ORCA9IDUsCiAgICAgIE1JTExJU0VDT05EID0gNiwKICAgICAgV0VFSyA9IDcsCiAgICAgIFdFRUtEQVkgPSA4OwoKICBmdW5jdGlvbiBtb2QobiwgeCkgewogICAgcmV0dXJuIChuICUgeCArIHgpICUgeDsKICB9CgogIHZhciBpbmRleE9mOwoKICBpZiAoQXJyYXkucHJvdG90eXBlLmluZGV4T2YpIHsKICAgIGluZGV4T2YgPSBBcnJheS5wcm90b3R5cGUuaW5kZXhPZjsKICB9IGVsc2UgewogICAgaW5kZXhPZiA9IGZ1bmN0aW9uIGluZGV4T2YobykgewogICAgICAvLyBJIGtub3cKICAgICAgdmFyIGk7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7ICsraSkgewogICAgICAgIGlmICh0aGlzW2ldID09PSBvKSB7CiAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiAtMTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBkYXlzSW5Nb250aCh5ZWFyLCBtb250aCkgewogICAgaWYgKGlzTmFOKHllYXIpIHx8IGlzTmFOKG1vbnRoKSkgewogICAgICByZXR1cm4gTmFOOwogICAgfQoKICAgIHZhciBtb2RNb250aCA9IG1vZChtb250aCwgMTIpOwogICAgeWVhciArPSAobW9udGggLSBtb2RNb250aCkgLyAxMjsKICAgIHJldHVybiBtb2RNb250aCA9PT0gMSA/IGlzTGVhcFllYXIoeWVhcikgPyAyOSA6IDI4IDogMzEgLSBtb2RNb250aCAlIDcgJSAyOwogIH0gLy8gRk9STUFUVElORwoKCiAgYWRkRm9ybWF0VG9rZW4oJ00nLCBbJ01NJywgMl0sICdNbycsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLm1vbnRoKCkgKyAxOwogIH0pOwogIGFkZEZvcm1hdFRva2VuKCdNTU0nLCAwLCAwLCBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkubW9udGhzU2hvcnQodGhpcywgZm9ybWF0KTsKICB9KTsKICBhZGRGb3JtYXRUb2tlbignTU1NTScsIDAsIDAsIGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5tb250aHModGhpcywgZm9ybWF0KTsKICB9KTsgLy8gQUxJQVNFUwoKICBhZGRVbml0QWxpYXMoJ21vbnRoJywgJ00nKTsgLy8gUFJJT1JJVFkKCiAgYWRkVW5pdFByaW9yaXR5KCdtb250aCcsIDgpOyAvLyBQQVJTSU5HCgogIGFkZFJlZ2V4VG9rZW4oJ00nLCBtYXRjaDF0bzIpOwogIGFkZFJlZ2V4VG9rZW4oJ01NJywgbWF0Y2gxdG8yLCBtYXRjaDIpOwogIGFkZFJlZ2V4VG9rZW4oJ01NTScsIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLm1vbnRoc1Nob3J0UmVnZXgoaXNTdHJpY3QpOwogIH0pOwogIGFkZFJlZ2V4VG9rZW4oJ01NTU0nLCBmdW5jdGlvbiAoaXNTdHJpY3QsIGxvY2FsZSkgewogICAgcmV0dXJuIGxvY2FsZS5tb250aHNSZWdleChpc1N0cmljdCk7CiAgfSk7CiAgYWRkUGFyc2VUb2tlbihbJ00nLCAnTU0nXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSkgewogICAgYXJyYXlbTU9OVEhdID0gdG9JbnQoaW5wdXQpIC0gMTsKICB9KTsKICBhZGRQYXJzZVRva2VuKFsnTU1NJywgJ01NTU0nXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnLCB0b2tlbikgewogICAgdmFyIG1vbnRoID0gY29uZmlnLl9sb2NhbGUubW9udGhzUGFyc2UoaW5wdXQsIHRva2VuLCBjb25maWcuX3N0cmljdCk7IC8vIGlmIHdlIGRpZG4ndCBmaW5kIGEgbW9udGggbmFtZSwgbWFyayB0aGUgZGF0ZSBhcyBpbnZhbGlkLgoKCiAgICBpZiAobW9udGggIT0gbnVsbCkgewogICAgICBhcnJheVtNT05USF0gPSBtb250aDsKICAgIH0gZWxzZSB7CiAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLmludmFsaWRNb250aCA9IGlucHV0OwogICAgfQogIH0pOyAvLyBMT0NBTEVTCgogIHZhciBkZWZhdWx0TG9jYWxlTW9udGhzID0gJ0phbnVhcnlfRmVicnVhcnlfTWFyY2hfQXByaWxfTWF5X0p1bmVfSnVseV9BdWd1c3RfU2VwdGVtYmVyX09jdG9iZXJfTm92ZW1iZXJfRGVjZW1iZXInLnNwbGl0KCdfJyksCiAgICAgIGRlZmF1bHRMb2NhbGVNb250aHNTaG9ydCA9ICdKYW5fRmViX01hcl9BcHJfTWF5X0p1bl9KdWxfQXVnX1NlcF9PY3RfTm92X0RlYycuc3BsaXQoJ18nKSwKICAgICAgTU9OVEhTX0lOX0ZPUk1BVCA9IC9EW29EXT8oXFtbXlxbXF1dKlxdfFxzKStNTU1NPy8sCiAgICAgIGRlZmF1bHRNb250aHNTaG9ydFJlZ2V4ID0gbWF0Y2hXb3JkLAogICAgICBkZWZhdWx0TW9udGhzUmVnZXggPSBtYXRjaFdvcmQ7CgogIGZ1bmN0aW9uIGxvY2FsZU1vbnRocyhtLCBmb3JtYXQpIHsKICAgIGlmICghbSkgewogICAgICByZXR1cm4gaXNBcnJheSh0aGlzLl9tb250aHMpID8gdGhpcy5fbW9udGhzIDogdGhpcy5fbW9udGhzWydzdGFuZGFsb25lJ107CiAgICB9CgogICAgcmV0dXJuIGlzQXJyYXkodGhpcy5fbW9udGhzKSA/IHRoaXMuX21vbnRoc1ttLm1vbnRoKCldIDogdGhpcy5fbW9udGhzWyh0aGlzLl9tb250aHMuaXNGb3JtYXQgfHwgTU9OVEhTX0lOX0ZPUk1BVCkudGVzdChmb3JtYXQpID8gJ2Zvcm1hdCcgOiAnc3RhbmRhbG9uZSddW20ubW9udGgoKV07CiAgfQoKICBmdW5jdGlvbiBsb2NhbGVNb250aHNTaG9ydChtLCBmb3JtYXQpIHsKICAgIGlmICghbSkgewogICAgICByZXR1cm4gaXNBcnJheSh0aGlzLl9tb250aHNTaG9ydCkgPyB0aGlzLl9tb250aHNTaG9ydCA6IHRoaXMuX21vbnRoc1Nob3J0WydzdGFuZGFsb25lJ107CiAgICB9CgogICAgcmV0dXJuIGlzQXJyYXkodGhpcy5fbW9udGhzU2hvcnQpID8gdGhpcy5fbW9udGhzU2hvcnRbbS5tb250aCgpXSA6IHRoaXMuX21vbnRoc1Nob3J0W01PTlRIU19JTl9GT1JNQVQudGVzdChmb3JtYXQpID8gJ2Zvcm1hdCcgOiAnc3RhbmRhbG9uZSddW20ubW9udGgoKV07CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVTdHJpY3RQYXJzZShtb250aE5hbWUsIGZvcm1hdCwgc3RyaWN0KSB7CiAgICB2YXIgaSwKICAgICAgICBpaSwKICAgICAgICBtb20sCiAgICAgICAgbGxjID0gbW9udGhOYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCk7CgogICAgaWYgKCF0aGlzLl9tb250aHNQYXJzZSkgewogICAgICAvLyB0aGlzIGlzIG5vdCB1c2VkCiAgICAgIHRoaXMuX21vbnRoc1BhcnNlID0gW107CiAgICAgIHRoaXMuX2xvbmdNb250aHNQYXJzZSA9IFtdOwogICAgICB0aGlzLl9zaG9ydE1vbnRoc1BhcnNlID0gW107CgogICAgICBmb3IgKGkgPSAwOyBpIDwgMTI7ICsraSkgewogICAgICAgIG1vbSA9IGNyZWF0ZVVUQyhbMjAwMCwgaV0pOwogICAgICAgIHRoaXMuX3Nob3J0TW9udGhzUGFyc2VbaV0gPSB0aGlzLm1vbnRoc1Nob3J0KG1vbSwgJycpLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICAgICAgdGhpcy5fbG9uZ01vbnRoc1BhcnNlW2ldID0gdGhpcy5tb250aHMobW9tLCAnJykudG9Mb2NhbGVMb3dlckNhc2UoKTsKICAgICAgfQogICAgfQoKICAgIGlmIChzdHJpY3QpIHsKICAgICAgaWYgKGZvcm1hdCA9PT0gJ01NTScpIHsKICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9zaG9ydE1vbnRoc1BhcnNlLCBsbGMpOwogICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fbG9uZ01vbnRoc1BhcnNlLCBsbGMpOwogICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChmb3JtYXQgPT09ICdNTU0nKSB7CiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRNb250aHNQYXJzZSwgbGxjKTsKCiAgICAgICAgaWYgKGlpICE9PSAtMSkgewogICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgIH0KCiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fbG9uZ01vbnRoc1BhcnNlLCBsbGMpOwogICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fbG9uZ01vbnRoc1BhcnNlLCBsbGMpOwoKICAgICAgICBpZiAoaWkgIT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgfQoKICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9zaG9ydE1vbnRoc1BhcnNlLCBsbGMpOwogICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvY2FsZU1vbnRoc1BhcnNlKG1vbnRoTmFtZSwgZm9ybWF0LCBzdHJpY3QpIHsKICAgIHZhciBpLCBtb20sIHJlZ2V4OwoKICAgIGlmICh0aGlzLl9tb250aHNQYXJzZUV4YWN0KSB7CiAgICAgIHJldHVybiBoYW5kbGVTdHJpY3RQYXJzZS5jYWxsKHRoaXMsIG1vbnRoTmFtZSwgZm9ybWF0LCBzdHJpY3QpOwogICAgfQoKICAgIGlmICghdGhpcy5fbW9udGhzUGFyc2UpIHsKICAgICAgdGhpcy5fbW9udGhzUGFyc2UgPSBbXTsKICAgICAgdGhpcy5fbG9uZ01vbnRoc1BhcnNlID0gW107CiAgICAgIHRoaXMuX3Nob3J0TW9udGhzUGFyc2UgPSBbXTsKICAgIH0gLy8gVE9ETzogYWRkIHNvcnRpbmcKICAgIC8vIFNvcnRpbmcgbWFrZXMgc3VyZSBpZiBvbmUgbW9udGggKG9yIGFiYnIpIGlzIGEgcHJlZml4IG9mIGFub3RoZXIKICAgIC8vIHNlZSBzb3J0aW5nIGluIGNvbXB1dGVNb250aHNQYXJzZQoKCiAgICBmb3IgKGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICAvLyBtYWtlIHRoZSByZWdleCBpZiB3ZSBkb24ndCBoYXZlIGl0IGFscmVhZHkKICAgICAgbW9tID0gY3JlYXRlVVRDKFsyMDAwLCBpXSk7CgogICAgICBpZiAoc3RyaWN0ICYmICF0aGlzLl9sb25nTW9udGhzUGFyc2VbaV0pIHsKICAgICAgICB0aGlzLl9sb25nTW9udGhzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKCdeJyArIHRoaXMubW9udGhzKG1vbSwgJycpLnJlcGxhY2UoJy4nLCAnJykgKyAnJCcsICdpJyk7CiAgICAgICAgdGhpcy5fc2hvcnRNb250aHNQYXJzZVtpXSA9IG5ldyBSZWdFeHAoJ14nICsgdGhpcy5tb250aHNTaG9ydChtb20sICcnKS5yZXBsYWNlKCcuJywgJycpICsgJyQnLCAnaScpOwogICAgICB9CgogICAgICBpZiAoIXN0cmljdCAmJiAhdGhpcy5fbW9udGhzUGFyc2VbaV0pIHsKICAgICAgICByZWdleCA9ICdeJyArIHRoaXMubW9udGhzKG1vbSwgJycpICsgJ3xeJyArIHRoaXMubW9udGhzU2hvcnQobW9tLCAnJyk7CiAgICAgICAgdGhpcy5fbW9udGhzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKHJlZ2V4LnJlcGxhY2UoJy4nLCAnJyksICdpJyk7CiAgICAgIH0gLy8gdGVzdCB0aGUgcmVnZXgKCgogICAgICBpZiAoc3RyaWN0ICYmIGZvcm1hdCA9PT0gJ01NTU0nICYmIHRoaXMuX2xvbmdNb250aHNQYXJzZVtpXS50ZXN0KG1vbnRoTmFtZSkpIHsKICAgICAgICByZXR1cm4gaTsKICAgICAgfSBlbHNlIGlmIChzdHJpY3QgJiYgZm9ybWF0ID09PSAnTU1NJyAmJiB0aGlzLl9zaG9ydE1vbnRoc1BhcnNlW2ldLnRlc3QobW9udGhOYW1lKSkgewogICAgICAgIHJldHVybiBpOwogICAgICB9IGVsc2UgaWYgKCFzdHJpY3QgJiYgdGhpcy5fbW9udGhzUGFyc2VbaV0udGVzdChtb250aE5hbWUpKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICB9IC8vIE1PTUVOVFMKCgogIGZ1bmN0aW9uIHNldE1vbnRoKG1vbSwgdmFsdWUpIHsKICAgIHZhciBkYXlPZk1vbnRoOwoKICAgIGlmICghbW9tLmlzVmFsaWQoKSkgewogICAgICAvLyBObyBvcAogICAgICByZXR1cm4gbW9tOwogICAgfQoKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIGlmICgvXlxkKyQvLnRlc3QodmFsdWUpKSB7CiAgICAgICAgdmFsdWUgPSB0b0ludCh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgPSBtb20ubG9jYWxlRGF0YSgpLm1vbnRoc1BhcnNlKHZhbHVlKTsgLy8gVE9ETzogQW5vdGhlciBzaWxlbnQgZmFpbHVyZT8KCiAgICAgICAgaWYgKCFpc051bWJlcih2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBtb207CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZGF5T2ZNb250aCA9IE1hdGgubWluKG1vbS5kYXRlKCksIGRheXNJbk1vbnRoKG1vbS55ZWFyKCksIHZhbHVlKSk7CgogICAgbW9tLl9kWydzZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArICdNb250aCddKHZhbHVlLCBkYXlPZk1vbnRoKTsKCiAgICByZXR1cm4gbW9tOwogIH0KCiAgZnVuY3Rpb24gZ2V0U2V0TW9udGgodmFsdWUpIHsKICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgIHNldE1vbnRoKHRoaXMsIHZhbHVlKTsKICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMsIHRydWUpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZXQodGhpcywgJ01vbnRoJyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZXREYXlzSW5Nb250aCgpIHsKICAgIHJldHVybiBkYXlzSW5Nb250aCh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpKTsKICB9CgogIGZ1bmN0aW9uIG1vbnRoc1Nob3J0UmVnZXgoaXNTdHJpY3QpIHsKICAgIGlmICh0aGlzLl9tb250aHNQYXJzZUV4YWN0KSB7CiAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX21vbnRoc1JlZ2V4JykpIHsKICAgICAgICBjb21wdXRlTW9udGhzUGFyc2UuY2FsbCh0aGlzKTsKICAgICAgfQoKICAgICAgaWYgKGlzU3RyaWN0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1Nob3J0U3RyaWN0UmVnZXg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1Nob3J0UmVnZXg7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX21vbnRoc1Nob3J0UmVnZXgnKSkgewogICAgICAgIHRoaXMuX21vbnRoc1Nob3J0UmVnZXggPSBkZWZhdWx0TW9udGhzU2hvcnRSZWdleDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1Nob3J0U3RyaWN0UmVnZXggJiYgaXNTdHJpY3QgPyB0aGlzLl9tb250aHNTaG9ydFN0cmljdFJlZ2V4IDogdGhpcy5fbW9udGhzU2hvcnRSZWdleDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG1vbnRoc1JlZ2V4KGlzU3RyaWN0KSB7CiAgICBpZiAodGhpcy5fbW9udGhzUGFyc2VFeGFjdCkgewogICAgICBpZiAoIWhhc093blByb3AodGhpcywgJ19tb250aHNSZWdleCcpKSB7CiAgICAgICAgY29tcHV0ZU1vbnRoc1BhcnNlLmNhbGwodGhpcyk7CiAgICAgIH0KCiAgICAgIGlmIChpc1N0cmljdCkgewogICAgICAgIHJldHVybiB0aGlzLl9tb250aHNTdHJpY3RSZWdleDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzUmVnZXg7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX21vbnRoc1JlZ2V4JykpIHsKICAgICAgICB0aGlzLl9tb250aHNSZWdleCA9IGRlZmF1bHRNb250aHNSZWdleDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1N0cmljdFJlZ2V4ICYmIGlzU3RyaWN0ID8gdGhpcy5fbW9udGhzU3RyaWN0UmVnZXggOiB0aGlzLl9tb250aHNSZWdleDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNvbXB1dGVNb250aHNQYXJzZSgpIHsKICAgIGZ1bmN0aW9uIGNtcExlblJldihhLCBiKSB7CiAgICAgIHJldHVybiBiLmxlbmd0aCAtIGEubGVuZ3RoOwogICAgfQoKICAgIHZhciBzaG9ydFBpZWNlcyA9IFtdLAogICAgICAgIGxvbmdQaWVjZXMgPSBbXSwKICAgICAgICBtaXhlZFBpZWNlcyA9IFtdLAogICAgICAgIGksCiAgICAgICAgbW9tOwoKICAgIGZvciAoaSA9IDA7IGkgPCAxMjsgaSsrKSB7CiAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQogICAgICBtb20gPSBjcmVhdGVVVEMoWzIwMDAsIGldKTsKICAgICAgc2hvcnRQaWVjZXMucHVzaCh0aGlzLm1vbnRoc1Nob3J0KG1vbSwgJycpKTsKICAgICAgbG9uZ1BpZWNlcy5wdXNoKHRoaXMubW9udGhzKG1vbSwgJycpKTsKICAgICAgbWl4ZWRQaWVjZXMucHVzaCh0aGlzLm1vbnRocyhtb20sICcnKSk7CiAgICAgIG1peGVkUGllY2VzLnB1c2godGhpcy5tb250aHNTaG9ydChtb20sICcnKSk7CiAgICB9IC8vIFNvcnRpbmcgbWFrZXMgc3VyZSBpZiBvbmUgbW9udGggKG9yIGFiYnIpIGlzIGEgcHJlZml4IG9mIGFub3RoZXIgaXQKICAgIC8vIHdpbGwgbWF0Y2ggdGhlIGxvbmdlciBwaWVjZS4KCgogICAgc2hvcnRQaWVjZXMuc29ydChjbXBMZW5SZXYpOwogICAgbG9uZ1BpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICBtaXhlZFBpZWNlcy5zb3J0KGNtcExlblJldik7CgogICAgZm9yIChpID0gMDsgaSA8IDEyOyBpKyspIHsKICAgICAgc2hvcnRQaWVjZXNbaV0gPSByZWdleEVzY2FwZShzaG9ydFBpZWNlc1tpXSk7CiAgICAgIGxvbmdQaWVjZXNbaV0gPSByZWdleEVzY2FwZShsb25nUGllY2VzW2ldKTsKICAgIH0KCiAgICBmb3IgKGkgPSAwOyBpIDwgMjQ7IGkrKykgewogICAgICBtaXhlZFBpZWNlc1tpXSA9IHJlZ2V4RXNjYXBlKG1peGVkUGllY2VzW2ldKTsKICAgIH0KCiAgICB0aGlzLl9tb250aHNSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIG1peGVkUGllY2VzLmpvaW4oJ3wnKSArICcpJywgJ2knKTsKICAgIHRoaXMuX21vbnRoc1Nob3J0UmVnZXggPSB0aGlzLl9tb250aHNSZWdleDsKICAgIHRoaXMuX21vbnRoc1N0cmljdFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgbG9uZ1BpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7CiAgICB0aGlzLl9tb250aHNTaG9ydFN0cmljdFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgc2hvcnRQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogIH0gLy8gRk9STUFUVElORwoKCiAgYWRkRm9ybWF0VG9rZW4oJ1knLCAwLCAwLCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgeSA9IHRoaXMueWVhcigpOwogICAgcmV0dXJuIHkgPD0gOTk5OSA/IHplcm9GaWxsKHksIDQpIDogJysnICsgeTsKICB9KTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ1lZJywgMl0sIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnllYXIoKSAlIDEwMDsKICB9KTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ1lZWVknLCA0XSwgMCwgJ3llYXInKTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ1lZWVlZJywgNV0sIDAsICd5ZWFyJyk7CiAgYWRkRm9ybWF0VG9rZW4oMCwgWydZWVlZWVknLCA2LCB0cnVlXSwgMCwgJ3llYXInKTsgLy8gQUxJQVNFUwoKICBhZGRVbml0QWxpYXMoJ3llYXInLCAneScpOyAvLyBQUklPUklUSUVTCgogIGFkZFVuaXRQcmlvcml0eSgneWVhcicsIDEpOyAvLyBQQVJTSU5HCgogIGFkZFJlZ2V4VG9rZW4oJ1knLCBtYXRjaFNpZ25lZCk7CiAgYWRkUmVnZXhUb2tlbignWVknLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgYWRkUmVnZXhUb2tlbignWVlZWScsIG1hdGNoMXRvNCwgbWF0Y2g0KTsKICBhZGRSZWdleFRva2VuKCdZWVlZWScsIG1hdGNoMXRvNiwgbWF0Y2g2KTsKICBhZGRSZWdleFRva2VuKCdZWVlZWVknLCBtYXRjaDF0bzYsIG1hdGNoNik7CiAgYWRkUGFyc2VUb2tlbihbJ1lZWVlZJywgJ1lZWVlZWSddLCBZRUFSKTsKICBhZGRQYXJzZVRva2VuKCdZWVlZJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSkgewogICAgYXJyYXlbWUVBUl0gPSBpbnB1dC5sZW5ndGggPT09IDIgPyBob29rcy5wYXJzZVR3b0RpZ2l0WWVhcihpbnB1dCkgOiB0b0ludChpbnB1dCk7CiAgfSk7CiAgYWRkUGFyc2VUb2tlbignWVknLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICBhcnJheVtZRUFSXSA9IGhvb2tzLnBhcnNlVHdvRGlnaXRZZWFyKGlucHV0KTsKICB9KTsKICBhZGRQYXJzZVRva2VuKCdZJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSkgewogICAgYXJyYXlbWUVBUl0gPSBwYXJzZUludChpbnB1dCwgMTApOwogIH0pOyAvLyBIRUxQRVJTCgogIGZ1bmN0aW9uIGRheXNJblllYXIoeWVhcikgewogICAgcmV0dXJuIGlzTGVhcFllYXIoeWVhcikgPyAzNjYgOiAzNjU7CiAgfSAvLyBIT09LUwoKCiAgaG9va3MucGFyc2VUd29EaWdpdFllYXIgPSBmdW5jdGlvbiAoaW5wdXQpIHsKICAgIHJldHVybiB0b0ludChpbnB1dCkgKyAodG9JbnQoaW5wdXQpID4gNjggPyAxOTAwIDogMjAwMCk7CiAgfTsgLy8gTU9NRU5UUwoKCiAgdmFyIGdldFNldFllYXIgPSBtYWtlR2V0U2V0KCdGdWxsWWVhcicsIHRydWUpOwoKICBmdW5jdGlvbiBnZXRJc0xlYXBZZWFyKCkgewogICAgcmV0dXJuIGlzTGVhcFllYXIodGhpcy55ZWFyKCkpOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRGF0ZSh5LCBtLCBkLCBoLCBNLCBzLCBtcykgewogICAgLy8gY2FuJ3QganVzdCBhcHBseSgpIHRvIGNyZWF0ZSBhIGRhdGU6CiAgICAvLyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3EvMTgxMzQ4CiAgICB2YXIgZGF0ZTsgLy8gdGhlIGRhdGUgY29uc3RydWN0b3IgcmVtYXBzIHllYXJzIDAtOTkgdG8gMTkwMC0xOTk5CgogICAgaWYgKHkgPCAxMDAgJiYgeSA+PSAwKSB7CiAgICAgIC8vIHByZXNlcnZlIGxlYXAgeWVhcnMgdXNpbmcgYSBmdWxsIDQwMCB5ZWFyIGN5Y2xlLCB0aGVuIHJlc2V0CiAgICAgIGRhdGUgPSBuZXcgRGF0ZSh5ICsgNDAwLCBtLCBkLCBoLCBNLCBzLCBtcyk7CgogICAgICBpZiAoaXNGaW5pdGUoZGF0ZS5nZXRGdWxsWWVhcigpKSkgewogICAgICAgIGRhdGUuc2V0RnVsbFllYXIoeSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGRhdGUgPSBuZXcgRGF0ZSh5LCBtLCBkLCBoLCBNLCBzLCBtcyk7CiAgICB9CgogICAgcmV0dXJuIGRhdGU7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVVVENEYXRlKHkpIHsKICAgIHZhciBkYXRlLCBhcmdzOyAvLyB0aGUgRGF0ZS5VVEMgZnVuY3Rpb24gcmVtYXBzIHllYXJzIDAtOTkgdG8gMTkwMC0xOTk5CgogICAgaWYgKHkgPCAxMDAgJiYgeSA+PSAwKSB7CiAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOyAvLyBwcmVzZXJ2ZSBsZWFwIHllYXJzIHVzaW5nIGEgZnVsbCA0MDAgeWVhciBjeWNsZSwgdGhlbiByZXNldAoKICAgICAgYXJnc1swXSA9IHkgKyA0MDA7CiAgICAgIGRhdGUgPSBuZXcgRGF0ZShEYXRlLlVUQy5hcHBseShudWxsLCBhcmdzKSk7CgogICAgICBpZiAoaXNGaW5pdGUoZGF0ZS5nZXRVVENGdWxsWWVhcigpKSkgewogICAgICAgIGRhdGUuc2V0VVRDRnVsbFllYXIoeSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGRhdGUgPSBuZXcgRGF0ZShEYXRlLlVUQy5hcHBseShudWxsLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICByZXR1cm4gZGF0ZTsKICB9IC8vIHN0YXJ0LW9mLWZpcnN0LXdlZWsgLSBzdGFydC1vZi15ZWFyCgoKICBmdW5jdGlvbiBmaXJzdFdlZWtPZmZzZXQoeWVhciwgZG93LCBkb3kpIHsKICAgIHZhciAvLyBmaXJzdC13ZWVrIGRheSAtLSB3aGljaCBqYW51YXJ5IGlzIGFsd2F5cyBpbiB0aGUgZmlyc3Qgd2VlayAoNCBmb3IgaXNvLCAxIGZvciBvdGhlcikKICAgIGZ3ZCA9IDcgKyBkb3cgLSBkb3ksCiAgICAgICAgLy8gZmlyc3Qtd2VlayBkYXkgbG9jYWwgd2Vla2RheSAtLSB3aGljaCBsb2NhbCB3ZWVrZGF5IGlzIGZ3ZAogICAgZndkbHcgPSAoNyArIGNyZWF0ZVVUQ0RhdGUoeWVhciwgMCwgZndkKS5nZXRVVENEYXkoKSAtIGRvdykgJSA3OwogICAgcmV0dXJuIC1md2RsdyArIGZ3ZCAtIDE7CiAgfSAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9JU09fd2Vla19kYXRlI0NhbGN1bGF0aW5nX2FfZGF0ZV9naXZlbl90aGVfeWVhci4yQ193ZWVrX251bWJlcl9hbmRfd2Vla2RheQoKCiAgZnVuY3Rpb24gZGF5T2ZZZWFyRnJvbVdlZWtzKHllYXIsIHdlZWssIHdlZWtkYXksIGRvdywgZG95KSB7CiAgICB2YXIgbG9jYWxXZWVrZGF5ID0gKDcgKyB3ZWVrZGF5IC0gZG93KSAlIDcsCiAgICAgICAgd2Vla09mZnNldCA9IGZpcnN0V2Vla09mZnNldCh5ZWFyLCBkb3csIGRveSksCiAgICAgICAgZGF5T2ZZZWFyID0gMSArIDcgKiAod2VlayAtIDEpICsgbG9jYWxXZWVrZGF5ICsgd2Vla09mZnNldCwKICAgICAgICByZXNZZWFyLAogICAgICAgIHJlc0RheU9mWWVhcjsKCiAgICBpZiAoZGF5T2ZZZWFyIDw9IDApIHsKICAgICAgcmVzWWVhciA9IHllYXIgLSAxOwogICAgICByZXNEYXlPZlllYXIgPSBkYXlzSW5ZZWFyKHJlc1llYXIpICsgZGF5T2ZZZWFyOwogICAgfSBlbHNlIGlmIChkYXlPZlllYXIgPiBkYXlzSW5ZZWFyKHllYXIpKSB7CiAgICAgIHJlc1llYXIgPSB5ZWFyICsgMTsKICAgICAgcmVzRGF5T2ZZZWFyID0gZGF5T2ZZZWFyIC0gZGF5c0luWWVhcih5ZWFyKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc1llYXIgPSB5ZWFyOwogICAgICByZXNEYXlPZlllYXIgPSBkYXlPZlllYXI7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgeWVhcjogcmVzWWVhciwKICAgICAgZGF5T2ZZZWFyOiByZXNEYXlPZlllYXIKICAgIH07CiAgfQoKICBmdW5jdGlvbiB3ZWVrT2ZZZWFyKG1vbSwgZG93LCBkb3kpIHsKICAgIHZhciB3ZWVrT2Zmc2V0ID0gZmlyc3RXZWVrT2Zmc2V0KG1vbS55ZWFyKCksIGRvdywgZG95KSwKICAgICAgICB3ZWVrID0gTWF0aC5mbG9vcigobW9tLmRheU9mWWVhcigpIC0gd2Vla09mZnNldCAtIDEpIC8gNykgKyAxLAogICAgICAgIHJlc1dlZWssCiAgICAgICAgcmVzWWVhcjsKCiAgICBpZiAod2VlayA8IDEpIHsKICAgICAgcmVzWWVhciA9IG1vbS55ZWFyKCkgLSAxOwogICAgICByZXNXZWVrID0gd2VlayArIHdlZWtzSW5ZZWFyKHJlc1llYXIsIGRvdywgZG95KTsKICAgIH0gZWxzZSBpZiAod2VlayA+IHdlZWtzSW5ZZWFyKG1vbS55ZWFyKCksIGRvdywgZG95KSkgewogICAgICByZXNXZWVrID0gd2VlayAtIHdlZWtzSW5ZZWFyKG1vbS55ZWFyKCksIGRvdywgZG95KTsKICAgICAgcmVzWWVhciA9IG1vbS55ZWFyKCkgKyAxOwogICAgfSBlbHNlIHsKICAgICAgcmVzWWVhciA9IG1vbS55ZWFyKCk7CiAgICAgIHJlc1dlZWsgPSB3ZWVrOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHdlZWs6IHJlc1dlZWssCiAgICAgIHllYXI6IHJlc1llYXIKICAgIH07CiAgfQoKICBmdW5jdGlvbiB3ZWVrc0luWWVhcih5ZWFyLCBkb3csIGRveSkgewogICAgdmFyIHdlZWtPZmZzZXQgPSBmaXJzdFdlZWtPZmZzZXQoeWVhciwgZG93LCBkb3kpLAogICAgICAgIHdlZWtPZmZzZXROZXh0ID0gZmlyc3RXZWVrT2Zmc2V0KHllYXIgKyAxLCBkb3csIGRveSk7CiAgICByZXR1cm4gKGRheXNJblllYXIoeWVhcikgLSB3ZWVrT2Zmc2V0ICsgd2Vla09mZnNldE5leHQpIC8gNzsKICB9IC8vIEZPUk1BVFRJTkcKCgogIGFkZEZvcm1hdFRva2VuKCd3JywgWyd3dycsIDJdLCAnd28nLCAnd2VlaycpOwogIGFkZEZvcm1hdFRva2VuKCdXJywgWydXVycsIDJdLCAnV28nLCAnaXNvV2VlaycpOyAvLyBBTElBU0VTCgogIGFkZFVuaXRBbGlhcygnd2VlaycsICd3Jyk7CiAgYWRkVW5pdEFsaWFzKCdpc29XZWVrJywgJ1cnKTsgLy8gUFJJT1JJVElFUwoKICBhZGRVbml0UHJpb3JpdHkoJ3dlZWsnLCA1KTsKICBhZGRVbml0UHJpb3JpdHkoJ2lzb1dlZWsnLCA1KTsgLy8gUEFSU0lORwoKICBhZGRSZWdleFRva2VuKCd3JywgbWF0Y2gxdG8yKTsKICBhZGRSZWdleFRva2VuKCd3dycsIG1hdGNoMXRvMiwgbWF0Y2gyKTsKICBhZGRSZWdleFRva2VuKCdXJywgbWF0Y2gxdG8yKTsKICBhZGRSZWdleFRva2VuKCdXVycsIG1hdGNoMXRvMiwgbWF0Y2gyKTsKICBhZGRXZWVrUGFyc2VUb2tlbihbJ3cnLCAnd3cnLCAnVycsICdXVyddLCBmdW5jdGlvbiAoaW5wdXQsIHdlZWssIGNvbmZpZywgdG9rZW4pIHsKICAgIHdlZWtbdG9rZW4uc3Vic3RyKDAsIDEpXSA9IHRvSW50KGlucHV0KTsKICB9KTsgLy8gSEVMUEVSUwogIC8vIExPQ0FMRVMKCiAgZnVuY3Rpb24gbG9jYWxlV2Vlayhtb20pIHsKICAgIHJldHVybiB3ZWVrT2ZZZWFyKG1vbSwgdGhpcy5fd2Vlay5kb3csIHRoaXMuX3dlZWsuZG95KS53ZWVrOwogIH0KCiAgdmFyIGRlZmF1bHRMb2NhbGVXZWVrID0gewogICAgZG93OiAwLAogICAgLy8gU3VuZGF5IGlzIHRoZSBmaXJzdCBkYXkgb2YgdGhlIHdlZWsuCiAgICBkb3k6IDYgLy8gVGhlIHdlZWsgdGhhdCBjb250YWlucyBKYW4gNnRoIGlzIHRoZSBmaXJzdCB3ZWVrIG9mIHRoZSB5ZWFyLgoKICB9OwoKICBmdW5jdGlvbiBsb2NhbGVGaXJzdERheU9mV2VlaygpIHsKICAgIHJldHVybiB0aGlzLl93ZWVrLmRvdzsKICB9CgogIGZ1bmN0aW9uIGxvY2FsZUZpcnN0RGF5T2ZZZWFyKCkgewogICAgcmV0dXJuIHRoaXMuX3dlZWsuZG95OwogIH0gLy8gTU9NRU5UUwoKCiAgZnVuY3Rpb24gZ2V0U2V0V2VlayhpbnB1dCkgewogICAgdmFyIHdlZWsgPSB0aGlzLmxvY2FsZURhdGEoKS53ZWVrKHRoaXMpOwogICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrIDogdGhpcy5hZGQoKGlucHV0IC0gd2VlaykgKiA3LCAnZCcpOwogIH0KCiAgZnVuY3Rpb24gZ2V0U2V0SVNPV2VlayhpbnB1dCkgewogICAgdmFyIHdlZWsgPSB3ZWVrT2ZZZWFyKHRoaXMsIDEsIDQpLndlZWs7CiAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IHdlZWsgOiB0aGlzLmFkZCgoaW5wdXQgLSB3ZWVrKSAqIDcsICdkJyk7CiAgfSAvLyBGT1JNQVRUSU5HCgoKICBhZGRGb3JtYXRUb2tlbignZCcsIDAsICdkbycsICdkYXknKTsKICBhZGRGb3JtYXRUb2tlbignZGQnLCAwLCAwLCBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkud2Vla2RheXNNaW4odGhpcywgZm9ybWF0KTsKICB9KTsKICBhZGRGb3JtYXRUb2tlbignZGRkJywgMCwgMCwgZnVuY3Rpb24gKGZvcm1hdCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLndlZWtkYXlzU2hvcnQodGhpcywgZm9ybWF0KTsKICB9KTsKICBhZGRGb3JtYXRUb2tlbignZGRkZCcsIDAsIDAsIGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS53ZWVrZGF5cyh0aGlzLCBmb3JtYXQpOwogIH0pOwogIGFkZEZvcm1hdFRva2VuKCdlJywgMCwgMCwgJ3dlZWtkYXknKTsKICBhZGRGb3JtYXRUb2tlbignRScsIDAsIDAsICdpc29XZWVrZGF5Jyk7IC8vIEFMSUFTRVMKCiAgYWRkVW5pdEFsaWFzKCdkYXknLCAnZCcpOwogIGFkZFVuaXRBbGlhcygnd2Vla2RheScsICdlJyk7CiAgYWRkVW5pdEFsaWFzKCdpc29XZWVrZGF5JywgJ0UnKTsgLy8gUFJJT1JJVFkKCiAgYWRkVW5pdFByaW9yaXR5KCdkYXknLCAxMSk7CiAgYWRkVW5pdFByaW9yaXR5KCd3ZWVrZGF5JywgMTEpOwogIGFkZFVuaXRQcmlvcml0eSgnaXNvV2Vla2RheScsIDExKTsgLy8gUEFSU0lORwoKICBhZGRSZWdleFRva2VuKCdkJywgbWF0Y2gxdG8yKTsKICBhZGRSZWdleFRva2VuKCdlJywgbWF0Y2gxdG8yKTsKICBhZGRSZWdleFRva2VuKCdFJywgbWF0Y2gxdG8yKTsKICBhZGRSZWdleFRva2VuKCdkZCcsIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLndlZWtkYXlzTWluUmVnZXgoaXNTdHJpY3QpOwogIH0pOwogIGFkZFJlZ2V4VG9rZW4oJ2RkZCcsIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLndlZWtkYXlzU2hvcnRSZWdleChpc1N0cmljdCk7CiAgfSk7CiAgYWRkUmVnZXhUb2tlbignZGRkZCcsIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLndlZWtkYXlzUmVnZXgoaXNTdHJpY3QpOwogIH0pOwogIGFkZFdlZWtQYXJzZVRva2VuKFsnZGQnLCAnZGRkJywgJ2RkZGQnXSwgZnVuY3Rpb24gKGlucHV0LCB3ZWVrLCBjb25maWcsIHRva2VuKSB7CiAgICB2YXIgd2Vla2RheSA9IGNvbmZpZy5fbG9jYWxlLndlZWtkYXlzUGFyc2UoaW5wdXQsIHRva2VuLCBjb25maWcuX3N0cmljdCk7IC8vIGlmIHdlIGRpZG4ndCBnZXQgYSB3ZWVrZGF5IG5hbWUsIG1hcmsgdGhlIGRhdGUgYXMgaW52YWxpZAoKCiAgICBpZiAod2Vla2RheSAhPSBudWxsKSB7CiAgICAgIHdlZWsuZCA9IHdlZWtkYXk7CiAgICB9IGVsc2UgewogICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5pbnZhbGlkV2Vla2RheSA9IGlucHV0OwogICAgfQogIH0pOwogIGFkZFdlZWtQYXJzZVRva2VuKFsnZCcsICdlJywgJ0UnXSwgZnVuY3Rpb24gKGlucHV0LCB3ZWVrLCBjb25maWcsIHRva2VuKSB7CiAgICB3ZWVrW3Rva2VuXSA9IHRvSW50KGlucHV0KTsKICB9KTsgLy8gSEVMUEVSUwoKICBmdW5jdGlvbiBwYXJzZVdlZWtkYXkoaW5wdXQsIGxvY2FsZSkgewogICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIGlucHV0OwogICAgfQoKICAgIGlmICghaXNOYU4oaW5wdXQpKSB7CiAgICAgIHJldHVybiBwYXJzZUludChpbnB1dCwgMTApOwogICAgfQoKICAgIGlucHV0ID0gbG9jYWxlLndlZWtkYXlzUGFyc2UoaW5wdXQpOwoKICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdudW1iZXInKSB7CiAgICAgIHJldHVybiBpbnB1dDsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9CgogIGZ1bmN0aW9uIHBhcnNlSXNvV2Vla2RheShpbnB1dCwgbG9jYWxlKSB7CiAgICBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gbG9jYWxlLndlZWtkYXlzUGFyc2UoaW5wdXQpICUgNyB8fCA3OwogICAgfQoKICAgIHJldHVybiBpc05hTihpbnB1dCkgPyBudWxsIDogaW5wdXQ7CiAgfSAvLyBMT0NBTEVTCgoKICBmdW5jdGlvbiBzaGlmdFdlZWtkYXlzKHdzLCBuKSB7CiAgICByZXR1cm4gd3Muc2xpY2UobiwgNykuY29uY2F0KHdzLnNsaWNlKDAsIG4pKTsKICB9CgogIHZhciBkZWZhdWx0TG9jYWxlV2Vla2RheXMgPSAnU3VuZGF5X01vbmRheV9UdWVzZGF5X1dlZG5lc2RheV9UaHVyc2RheV9GcmlkYXlfU2F0dXJkYXknLnNwbGl0KCdfJyksCiAgICAgIGRlZmF1bHRMb2NhbGVXZWVrZGF5c1Nob3J0ID0gJ1N1bl9Nb25fVHVlX1dlZF9UaHVfRnJpX1NhdCcuc3BsaXQoJ18nKSwKICAgICAgZGVmYXVsdExvY2FsZVdlZWtkYXlzTWluID0gJ1N1X01vX1R1X1dlX1RoX0ZyX1NhJy5zcGxpdCgnXycpLAogICAgICBkZWZhdWx0V2Vla2RheXNSZWdleCA9IG1hdGNoV29yZCwKICAgICAgZGVmYXVsdFdlZWtkYXlzU2hvcnRSZWdleCA9IG1hdGNoV29yZCwKICAgICAgZGVmYXVsdFdlZWtkYXlzTWluUmVnZXggPSBtYXRjaFdvcmQ7CgogIGZ1bmN0aW9uIGxvY2FsZVdlZWtkYXlzKG0sIGZvcm1hdCkgewogICAgdmFyIHdlZWtkYXlzID0gaXNBcnJheSh0aGlzLl93ZWVrZGF5cykgPyB0aGlzLl93ZWVrZGF5cyA6IHRoaXMuX3dlZWtkYXlzW20gJiYgbSAhPT0gdHJ1ZSAmJiB0aGlzLl93ZWVrZGF5cy5pc0Zvcm1hdC50ZXN0KGZvcm1hdCkgPyAnZm9ybWF0JyA6ICdzdGFuZGFsb25lJ107CiAgICByZXR1cm4gbSA9PT0gdHJ1ZSA/IHNoaWZ0V2Vla2RheXMod2Vla2RheXMsIHRoaXMuX3dlZWsuZG93KSA6IG0gPyB3ZWVrZGF5c1ttLmRheSgpXSA6IHdlZWtkYXlzOwogIH0KCiAgZnVuY3Rpb24gbG9jYWxlV2Vla2RheXNTaG9ydChtKSB7CiAgICByZXR1cm4gbSA9PT0gdHJ1ZSA/IHNoaWZ0V2Vla2RheXModGhpcy5fd2Vla2RheXNTaG9ydCwgdGhpcy5fd2Vlay5kb3cpIDogbSA/IHRoaXMuX3dlZWtkYXlzU2hvcnRbbS5kYXkoKV0gOiB0aGlzLl93ZWVrZGF5c1Nob3J0OwogIH0KCiAgZnVuY3Rpb24gbG9jYWxlV2Vla2RheXNNaW4obSkgewogICAgcmV0dXJuIG0gPT09IHRydWUgPyBzaGlmdFdlZWtkYXlzKHRoaXMuX3dlZWtkYXlzTWluLCB0aGlzLl93ZWVrLmRvdykgOiBtID8gdGhpcy5fd2Vla2RheXNNaW5bbS5kYXkoKV0gOiB0aGlzLl93ZWVrZGF5c01pbjsKICB9CgogIGZ1bmN0aW9uIGhhbmRsZVN0cmljdFBhcnNlJDEod2Vla2RheU5hbWUsIGZvcm1hdCwgc3RyaWN0KSB7CiAgICB2YXIgaSwKICAgICAgICBpaSwKICAgICAgICBtb20sCiAgICAgICAgbGxjID0gd2Vla2RheU5hbWUudG9Mb2NhbGVMb3dlckNhc2UoKTsKCiAgICBpZiAoIXRoaXMuX3dlZWtkYXlzUGFyc2UpIHsKICAgICAgdGhpcy5fd2Vla2RheXNQYXJzZSA9IFtdOwogICAgICB0aGlzLl9zaG9ydFdlZWtkYXlzUGFyc2UgPSBbXTsKICAgICAgdGhpcy5fbWluV2Vla2RheXNQYXJzZSA9IFtdOwoKICAgICAgZm9yIChpID0gMDsgaSA8IDc7ICsraSkgewogICAgICAgIG1vbSA9IGNyZWF0ZVVUQyhbMjAwMCwgMV0pLmRheShpKTsKICAgICAgICB0aGlzLl9taW5XZWVrZGF5c1BhcnNlW2ldID0gdGhpcy53ZWVrZGF5c01pbihtb20sICcnKS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgICAgIHRoaXMuX3Nob3J0V2Vla2RheXNQYXJzZVtpXSA9IHRoaXMud2Vla2RheXNTaG9ydChtb20sICcnKS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0gPSB0aGlzLndlZWtkYXlzKG1vbSwgJycpLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3RyaWN0KSB7CiAgICAgIGlmIChmb3JtYXQgPT09ICdkZGRkJykgewogICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX3dlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgfSBlbHNlIGlmIChmb3JtYXQgPT09ICdkZGQnKSB7CiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fbWluV2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoZm9ybWF0ID09PSAnZGRkZCcpIHsKICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl93ZWVrZGF5c1BhcnNlLCBsbGMpOwoKICAgICAgICBpZiAoaWkgIT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgfQoKICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9zaG9ydFdlZWtkYXlzUGFyc2UsIGxsYyk7CgogICAgICAgIGlmIChpaSAhPT0gLTEpIHsKICAgICAgICAgIHJldHVybiBpaTsKICAgICAgICB9CgogICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX21pbldlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgfSBlbHNlIGlmIChmb3JtYXQgPT09ICdkZGQnKSB7CiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlLCBsbGMpOwoKICAgICAgICBpZiAoaWkgIT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgfQoKICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl93ZWVrZGF5c1BhcnNlLCBsbGMpOwoKICAgICAgICBpZiAoaWkgIT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgfQoKICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9taW5XZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fbWluV2Vla2RheXNQYXJzZSwgbGxjKTsKCiAgICAgICAgaWYgKGlpICE9PSAtMSkgewogICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgIH0KCiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fd2Vla2RheXNQYXJzZSwgbGxjKTsKCiAgICAgICAgaWYgKGlpICE9PSAtMSkgewogICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgIH0KCiAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvY2FsZVdlZWtkYXlzUGFyc2Uod2Vla2RheU5hbWUsIGZvcm1hdCwgc3RyaWN0KSB7CiAgICB2YXIgaSwgbW9tLCByZWdleDsKCiAgICBpZiAodGhpcy5fd2Vla2RheXNQYXJzZUV4YWN0KSB7CiAgICAgIHJldHVybiBoYW5kbGVTdHJpY3RQYXJzZSQxLmNhbGwodGhpcywgd2Vla2RheU5hbWUsIGZvcm1hdCwgc3RyaWN0KTsKICAgIH0KCiAgICBpZiAoIXRoaXMuX3dlZWtkYXlzUGFyc2UpIHsKICAgICAgdGhpcy5fd2Vla2RheXNQYXJzZSA9IFtdOwogICAgICB0aGlzLl9taW5XZWVrZGF5c1BhcnNlID0gW107CiAgICAgIHRoaXMuX3Nob3J0V2Vla2RheXNQYXJzZSA9IFtdOwogICAgICB0aGlzLl9mdWxsV2Vla2RheXNQYXJzZSA9IFtdOwogICAgfQoKICAgIGZvciAoaSA9IDA7IGkgPCA3OyBpKyspIHsKICAgICAgLy8gbWFrZSB0aGUgcmVnZXggaWYgd2UgZG9uJ3QgaGF2ZSBpdCBhbHJlYWR5CiAgICAgIG1vbSA9IGNyZWF0ZVVUQyhbMjAwMCwgMV0pLmRheShpKTsKCiAgICAgIGlmIChzdHJpY3QgJiYgIXRoaXMuX2Z1bGxXZWVrZGF5c1BhcnNlW2ldKSB7CiAgICAgICAgdGhpcy5fZnVsbFdlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKCdeJyArIHRoaXMud2Vla2RheXMobW9tLCAnJykucmVwbGFjZSgnLicsICdcXC4/JykgKyAnJCcsICdpJyk7CiAgICAgICAgdGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlW2ldID0gbmV3IFJlZ0V4cCgnXicgKyB0aGlzLndlZWtkYXlzU2hvcnQobW9tLCAnJykucmVwbGFjZSgnLicsICdcXC4/JykgKyAnJCcsICdpJyk7CiAgICAgICAgdGhpcy5fbWluV2Vla2RheXNQYXJzZVtpXSA9IG5ldyBSZWdFeHAoJ14nICsgdGhpcy53ZWVrZGF5c01pbihtb20sICcnKS5yZXBsYWNlKCcuJywgJ1xcLj8nKSArICckJywgJ2knKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLl93ZWVrZGF5c1BhcnNlW2ldKSB7CiAgICAgICAgcmVnZXggPSAnXicgKyB0aGlzLndlZWtkYXlzKG1vbSwgJycpICsgJ3xeJyArIHRoaXMud2Vla2RheXNTaG9ydChtb20sICcnKSArICd8XicgKyB0aGlzLndlZWtkYXlzTWluKG1vbSwgJycpOwogICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKHJlZ2V4LnJlcGxhY2UoJy4nLCAnJyksICdpJyk7CiAgICAgIH0gLy8gdGVzdCB0aGUgcmVnZXgKCgogICAgICBpZiAoc3RyaWN0ICYmIGZvcm1hdCA9PT0gJ2RkZGQnICYmIHRoaXMuX2Z1bGxXZWVrZGF5c1BhcnNlW2ldLnRlc3Qod2Vla2RheU5hbWUpKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0gZWxzZSBpZiAoc3RyaWN0ICYmIGZvcm1hdCA9PT0gJ2RkZCcgJiYgdGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlW2ldLnRlc3Qod2Vla2RheU5hbWUpKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0gZWxzZSBpZiAoc3RyaWN0ICYmIGZvcm1hdCA9PT0gJ2RkJyAmJiB0aGlzLl9taW5XZWVrZGF5c1BhcnNlW2ldLnRlc3Qod2Vla2RheU5hbWUpKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0gZWxzZSBpZiAoIXN0cmljdCAmJiB0aGlzLl93ZWVrZGF5c1BhcnNlW2ldLnRlc3Qod2Vla2RheU5hbWUpKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICB9IC8vIE1PTUVOVFMKCgogIGZ1bmN0aW9uIGdldFNldERheU9mV2VlayhpbnB1dCkgewogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCA/IHRoaXMgOiBOYU47CiAgICB9CgogICAgdmFyIGRheSA9IHRoaXMuX2lzVVRDID8gdGhpcy5fZC5nZXRVVENEYXkoKSA6IHRoaXMuX2QuZ2V0RGF5KCk7CgogICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgaW5wdXQgPSBwYXJzZVdlZWtkYXkoaW5wdXQsIHRoaXMubG9jYWxlRGF0YSgpKTsKICAgICAgcmV0dXJuIHRoaXMuYWRkKGlucHV0IC0gZGF5LCAnZCcpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGRheTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldFNldExvY2FsZURheU9mV2VlayhpbnB1dCkgewogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCA/IHRoaXMgOiBOYU47CiAgICB9CgogICAgdmFyIHdlZWtkYXkgPSAodGhpcy5kYXkoKSArIDcgLSB0aGlzLmxvY2FsZURhdGEoKS5fd2Vlay5kb3cpICUgNzsKICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gd2Vla2RheSA6IHRoaXMuYWRkKGlucHV0IC0gd2Vla2RheSwgJ2QnKTsKICB9CgogIGZ1bmN0aW9uIGdldFNldElTT0RheU9mV2VlayhpbnB1dCkgewogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCA/IHRoaXMgOiBOYU47CiAgICB9IC8vIGJlaGF2ZXMgdGhlIHNhbWUgYXMgbW9tZW50I2RheSBleGNlcHQKICAgIC8vIGFzIGEgZ2V0dGVyLCByZXR1cm5zIDcgaW5zdGVhZCBvZiAwICgxLTcgcmFuZ2UgaW5zdGVhZCBvZiAwLTYpCiAgICAvLyBhcyBhIHNldHRlciwgc3VuZGF5IHNob3VsZCBiZWxvbmcgdG8gdGhlIHByZXZpb3VzIHdlZWsuCgoKICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgIHZhciB3ZWVrZGF5ID0gcGFyc2VJc29XZWVrZGF5KGlucHV0LCB0aGlzLmxvY2FsZURhdGEoKSk7CiAgICAgIHJldHVybiB0aGlzLmRheSh0aGlzLmRheSgpICUgNyA/IHdlZWtkYXkgOiB3ZWVrZGF5IC0gNyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5kYXkoKSB8fCA3OwogICAgfQogIH0KCiAgZnVuY3Rpb24gd2Vla2RheXNSZWdleChpc1N0cmljdCkgewogICAgaWYgKHRoaXMuX3dlZWtkYXlzUGFyc2VFeGFjdCkgewogICAgICBpZiAoIWhhc093blByb3AodGhpcywgJ193ZWVrZGF5c1JlZ2V4JykpIHsKICAgICAgICBjb21wdXRlV2Vla2RheXNQYXJzZS5jYWxsKHRoaXMpOwogICAgICB9CgogICAgICBpZiAoaXNTdHJpY3QpIHsKICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNTdHJpY3RSZWdleDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNSZWdleDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfd2Vla2RheXNSZWdleCcpKSB7CiAgICAgICAgdGhpcy5fd2Vla2RheXNSZWdleCA9IGRlZmF1bHRXZWVrZGF5c1JlZ2V4OwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNTdHJpY3RSZWdleCAmJiBpc1N0cmljdCA/IHRoaXMuX3dlZWtkYXlzU3RyaWN0UmVnZXggOiB0aGlzLl93ZWVrZGF5c1JlZ2V4OwogICAgfQogIH0KCiAgZnVuY3Rpb24gd2Vla2RheXNTaG9ydFJlZ2V4KGlzU3RyaWN0KSB7CiAgICBpZiAodGhpcy5fd2Vla2RheXNQYXJzZUV4YWN0KSB7CiAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX3dlZWtkYXlzUmVnZXgnKSkgewogICAgICAgIGNvbXB1dGVXZWVrZGF5c1BhcnNlLmNhbGwodGhpcyk7CiAgICAgIH0KCiAgICAgIGlmIChpc1N0cmljdCkgewogICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1Nob3J0U3RyaWN0UmVnZXg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzU2hvcnRSZWdleDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfd2Vla2RheXNTaG9ydFJlZ2V4JykpIHsKICAgICAgICB0aGlzLl93ZWVrZGF5c1Nob3J0UmVnZXggPSBkZWZhdWx0V2Vla2RheXNTaG9ydFJlZ2V4OwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNTaG9ydFN0cmljdFJlZ2V4ICYmIGlzU3RyaWN0ID8gdGhpcy5fd2Vla2RheXNTaG9ydFN0cmljdFJlZ2V4IDogdGhpcy5fd2Vla2RheXNTaG9ydFJlZ2V4OwogICAgfQogIH0KCiAgZnVuY3Rpb24gd2Vla2RheXNNaW5SZWdleChpc1N0cmljdCkgewogICAgaWYgKHRoaXMuX3dlZWtkYXlzUGFyc2VFeGFjdCkgewogICAgICBpZiAoIWhhc093blByb3AodGhpcywgJ193ZWVrZGF5c1JlZ2V4JykpIHsKICAgICAgICBjb21wdXRlV2Vla2RheXNQYXJzZS5jYWxsKHRoaXMpOwogICAgICB9CgogICAgICBpZiAoaXNTdHJpY3QpIHsKICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNNaW5TdHJpY3RSZWdleDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNNaW5SZWdleDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfd2Vla2RheXNNaW5SZWdleCcpKSB7CiAgICAgICAgdGhpcy5fd2Vla2RheXNNaW5SZWdleCA9IGRlZmF1bHRXZWVrZGF5c01pblJlZ2V4OwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNNaW5TdHJpY3RSZWdleCAmJiBpc1N0cmljdCA/IHRoaXMuX3dlZWtkYXlzTWluU3RyaWN0UmVnZXggOiB0aGlzLl93ZWVrZGF5c01pblJlZ2V4OwogICAgfQogIH0KCiAgZnVuY3Rpb24gY29tcHV0ZVdlZWtkYXlzUGFyc2UoKSB7CiAgICBmdW5jdGlvbiBjbXBMZW5SZXYoYSwgYikgewogICAgICByZXR1cm4gYi5sZW5ndGggLSBhLmxlbmd0aDsKICAgIH0KCiAgICB2YXIgbWluUGllY2VzID0gW10sCiAgICAgICAgc2hvcnRQaWVjZXMgPSBbXSwKICAgICAgICBsb25nUGllY2VzID0gW10sCiAgICAgICAgbWl4ZWRQaWVjZXMgPSBbXSwKICAgICAgICBpLAogICAgICAgIG1vbSwKICAgICAgICBtaW5wLAogICAgICAgIHNob3J0cCwKICAgICAgICBsb25ncDsKCiAgICBmb3IgKGkgPSAwOyBpIDwgNzsgaSsrKSB7CiAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQogICAgICBtb20gPSBjcmVhdGVVVEMoWzIwMDAsIDFdKS5kYXkoaSk7CiAgICAgIG1pbnAgPSByZWdleEVzY2FwZSh0aGlzLndlZWtkYXlzTWluKG1vbSwgJycpKTsKICAgICAgc2hvcnRwID0gcmVnZXhFc2NhcGUodGhpcy53ZWVrZGF5c1Nob3J0KG1vbSwgJycpKTsKICAgICAgbG9uZ3AgPSByZWdleEVzY2FwZSh0aGlzLndlZWtkYXlzKG1vbSwgJycpKTsKICAgICAgbWluUGllY2VzLnB1c2gobWlucCk7CiAgICAgIHNob3J0UGllY2VzLnB1c2goc2hvcnRwKTsKICAgICAgbG9uZ1BpZWNlcy5wdXNoKGxvbmdwKTsKICAgICAgbWl4ZWRQaWVjZXMucHVzaChtaW5wKTsKICAgICAgbWl4ZWRQaWVjZXMucHVzaChzaG9ydHApOwogICAgICBtaXhlZFBpZWNlcy5wdXNoKGxvbmdwKTsKICAgIH0gLy8gU29ydGluZyBtYWtlcyBzdXJlIGlmIG9uZSB3ZWVrZGF5IChvciBhYmJyKSBpcyBhIHByZWZpeCBvZiBhbm90aGVyIGl0CiAgICAvLyB3aWxsIG1hdGNoIHRoZSBsb25nZXIgcGllY2UuCgoKICAgIG1pblBpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICBzaG9ydFBpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICBsb25nUGllY2VzLnNvcnQoY21wTGVuUmV2KTsKICAgIG1peGVkUGllY2VzLnNvcnQoY21wTGVuUmV2KTsKICAgIHRoaXMuX3dlZWtkYXlzUmVnZXggPSBuZXcgUmVnRXhwKCdeKCcgKyBtaXhlZFBpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7CiAgICB0aGlzLl93ZWVrZGF5c1Nob3J0UmVnZXggPSB0aGlzLl93ZWVrZGF5c1JlZ2V4OwogICAgdGhpcy5fd2Vla2RheXNNaW5SZWdleCA9IHRoaXMuX3dlZWtkYXlzUmVnZXg7CiAgICB0aGlzLl93ZWVrZGF5c1N0cmljdFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgbG9uZ1BpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7CiAgICB0aGlzLl93ZWVrZGF5c1Nob3J0U3RyaWN0UmVnZXggPSBuZXcgUmVnRXhwKCdeKCcgKyBzaG9ydFBpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7CiAgICB0aGlzLl93ZWVrZGF5c01pblN0cmljdFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgbWluUGllY2VzLmpvaW4oJ3wnKSArICcpJywgJ2knKTsKICB9IC8vIEZPUk1BVFRJTkcKCgogIGZ1bmN0aW9uIGhGb3JtYXQoKSB7CiAgICByZXR1cm4gdGhpcy5ob3VycygpICUgMTIgfHwgMTI7CiAgfQoKICBmdW5jdGlvbiBrRm9ybWF0KCkgewogICAgcmV0dXJuIHRoaXMuaG91cnMoKSB8fCAyNDsKICB9CgogIGFkZEZvcm1hdFRva2VuKCdIJywgWydISCcsIDJdLCAwLCAnaG91cicpOwogIGFkZEZvcm1hdFRva2VuKCdoJywgWydoaCcsIDJdLCAwLCBoRm9ybWF0KTsKICBhZGRGb3JtYXRUb2tlbignaycsIFsna2snLCAyXSwgMCwga0Zvcm1hdCk7CiAgYWRkRm9ybWF0VG9rZW4oJ2htbScsIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAnJyArIGhGb3JtYXQuYXBwbHkodGhpcykgKyB6ZXJvRmlsbCh0aGlzLm1pbnV0ZXMoKSwgMik7CiAgfSk7CiAgYWRkRm9ybWF0VG9rZW4oJ2htbXNzJywgMCwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICcnICsgaEZvcm1hdC5hcHBseSh0aGlzKSArIHplcm9GaWxsKHRoaXMubWludXRlcygpLCAyKSArIHplcm9GaWxsKHRoaXMuc2Vjb25kcygpLCAyKTsKICB9KTsKICBhZGRGb3JtYXRUb2tlbignSG1tJywgMCwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICcnICsgdGhpcy5ob3VycygpICsgemVyb0ZpbGwodGhpcy5taW51dGVzKCksIDIpOwogIH0pOwogIGFkZEZvcm1hdFRva2VuKCdIbW1zcycsIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAnJyArIHRoaXMuaG91cnMoKSArIHplcm9GaWxsKHRoaXMubWludXRlcygpLCAyKSArIHplcm9GaWxsKHRoaXMuc2Vjb25kcygpLCAyKTsKICB9KTsKCiAgZnVuY3Rpb24gbWVyaWRpZW0odG9rZW4sIGxvd2VyY2FzZSkgewogICAgYWRkRm9ybWF0VG9rZW4odG9rZW4sIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLm1lcmlkaWVtKHRoaXMuaG91cnMoKSwgdGhpcy5taW51dGVzKCksIGxvd2VyY2FzZSk7CiAgICB9KTsKICB9CgogIG1lcmlkaWVtKCdhJywgdHJ1ZSk7CiAgbWVyaWRpZW0oJ0EnLCBmYWxzZSk7IC8vIEFMSUFTRVMKCiAgYWRkVW5pdEFsaWFzKCdob3VyJywgJ2gnKTsgLy8gUFJJT1JJVFkKCiAgYWRkVW5pdFByaW9yaXR5KCdob3VyJywgMTMpOyAvLyBQQVJTSU5HCgogIGZ1bmN0aW9uIG1hdGNoTWVyaWRpZW0oaXNTdHJpY3QsIGxvY2FsZSkgewogICAgcmV0dXJuIGxvY2FsZS5fbWVyaWRpZW1QYXJzZTsKICB9CgogIGFkZFJlZ2V4VG9rZW4oJ2EnLCBtYXRjaE1lcmlkaWVtKTsKICBhZGRSZWdleFRva2VuKCdBJywgbWF0Y2hNZXJpZGllbSk7CiAgYWRkUmVnZXhUb2tlbignSCcsIG1hdGNoMXRvMik7CiAgYWRkUmVnZXhUb2tlbignaCcsIG1hdGNoMXRvMik7CiAgYWRkUmVnZXhUb2tlbignaycsIG1hdGNoMXRvMik7CiAgYWRkUmVnZXhUb2tlbignSEgnLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgYWRkUmVnZXhUb2tlbignaGgnLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgYWRkUmVnZXhUb2tlbigna2snLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgYWRkUmVnZXhUb2tlbignaG1tJywgbWF0Y2gzdG80KTsKICBhZGRSZWdleFRva2VuKCdobW1zcycsIG1hdGNoNXRvNik7CiAgYWRkUmVnZXhUb2tlbignSG1tJywgbWF0Y2gzdG80KTsKICBhZGRSZWdleFRva2VuKCdIbW1zcycsIG1hdGNoNXRvNik7CiAgYWRkUGFyc2VUb2tlbihbJ0gnLCAnSEgnXSwgSE9VUik7CiAgYWRkUGFyc2VUb2tlbihbJ2snLCAna2snXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICB2YXIga0lucHV0ID0gdG9JbnQoaW5wdXQpOwogICAgYXJyYXlbSE9VUl0gPSBrSW5wdXQgPT09IDI0ID8gMCA6IGtJbnB1dDsKICB9KTsKICBhZGRQYXJzZVRva2VuKFsnYScsICdBJ10sIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgY29uZmlnLl9pc1BtID0gY29uZmlnLl9sb2NhbGUuaXNQTShpbnB1dCk7CiAgICBjb25maWcuX21lcmlkaWVtID0gaW5wdXQ7CiAgfSk7CiAgYWRkUGFyc2VUb2tlbihbJ2gnLCAnaGgnXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICBhcnJheVtIT1VSXSA9IHRvSW50KGlucHV0KTsKICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLmJpZ0hvdXIgPSB0cnVlOwogIH0pOwogIGFkZFBhcnNlVG9rZW4oJ2htbScsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgdmFyIHBvcyA9IGlucHV0Lmxlbmd0aCAtIDI7CiAgICBhcnJheVtIT1VSXSA9IHRvSW50KGlucHV0LnN1YnN0cigwLCBwb3MpKTsKICAgIGFycmF5W01JTlVURV0gPSB0b0ludChpbnB1dC5zdWJzdHIocG9zKSk7CiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5iaWdIb3VyID0gdHJ1ZTsKICB9KTsKICBhZGRQYXJzZVRva2VuKCdobW1zcycsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgdmFyIHBvczEgPSBpbnB1dC5sZW5ndGggLSA0LAogICAgICAgIHBvczIgPSBpbnB1dC5sZW5ndGggLSAyOwogICAgYXJyYXlbSE9VUl0gPSB0b0ludChpbnB1dC5zdWJzdHIoMCwgcG9zMSkpOwogICAgYXJyYXlbTUlOVVRFXSA9IHRvSW50KGlucHV0LnN1YnN0cihwb3MxLCAyKSk7CiAgICBhcnJheVtTRUNPTkRdID0gdG9JbnQoaW5wdXQuc3Vic3RyKHBvczIpKTsKICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLmJpZ0hvdXIgPSB0cnVlOwogIH0pOwogIGFkZFBhcnNlVG9rZW4oJ0htbScsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgdmFyIHBvcyA9IGlucHV0Lmxlbmd0aCAtIDI7CiAgICBhcnJheVtIT1VSXSA9IHRvSW50KGlucHV0LnN1YnN0cigwLCBwb3MpKTsKICAgIGFycmF5W01JTlVURV0gPSB0b0ludChpbnB1dC5zdWJzdHIocG9zKSk7CiAgfSk7CiAgYWRkUGFyc2VUb2tlbignSG1tc3MnLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcpIHsKICAgIHZhciBwb3MxID0gaW5wdXQubGVuZ3RoIC0gNCwKICAgICAgICBwb3MyID0gaW5wdXQubGVuZ3RoIC0gMjsKICAgIGFycmF5W0hPVVJdID0gdG9JbnQoaW5wdXQuc3Vic3RyKDAsIHBvczEpKTsKICAgIGFycmF5W01JTlVURV0gPSB0b0ludChpbnB1dC5zdWJzdHIocG9zMSwgMikpOwogICAgYXJyYXlbU0VDT05EXSA9IHRvSW50KGlucHV0LnN1YnN0cihwb3MyKSk7CiAgfSk7IC8vIExPQ0FMRVMKCiAgZnVuY3Rpb24gbG9jYWxlSXNQTShpbnB1dCkgewogICAgLy8gSUU4IFF1aXJrcyBNb2RlICYgSUU3IFN0YW5kYXJkcyBNb2RlIGRvIG5vdCBhbGxvdyBhY2Nlc3Npbmcgc3RyaW5ncyBsaWtlIGFycmF5cwogICAgLy8gVXNpbmcgY2hhckF0IHNob3VsZCBiZSBtb3JlIGNvbXBhdGlibGUuCiAgICByZXR1cm4gKGlucHV0ICsgJycpLnRvTG93ZXJDYXNlKCkuY2hhckF0KDApID09PSAncCc7CiAgfQoKICB2YXIgZGVmYXVsdExvY2FsZU1lcmlkaWVtUGFyc2UgPSAvW2FwXVwuP20/XC4/L2ksCiAgICAgIC8vIFNldHRpbmcgdGhlIGhvdXIgc2hvdWxkIGtlZXAgdGhlIHRpbWUsIGJlY2F1c2UgdGhlIHVzZXIgZXhwbGljaXRseQogIC8vIHNwZWNpZmllZCB3aGljaCBob3VyIHRoZXkgd2FudC4gU28gdHJ5aW5nIHRvIG1haW50YWluIHRoZSBzYW1lIGhvdXIgKGluCiAgLy8gYSBuZXcgdGltZXpvbmUpIG1ha2VzIHNlbnNlLiBBZGRpbmcvc3VidHJhY3RpbmcgaG91cnMgZG9lcyBub3QgZm9sbG93CiAgLy8gdGhpcyBydWxlLgogIGdldFNldEhvdXIgPSBtYWtlR2V0U2V0KCdIb3VycycsIHRydWUpOwoKICBmdW5jdGlvbiBsb2NhbGVNZXJpZGllbShob3VycywgbWludXRlcywgaXNMb3dlcikgewogICAgaWYgKGhvdXJzID4gMTEpIHsKICAgICAgcmV0dXJuIGlzTG93ZXIgPyAncG0nIDogJ1BNJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpc0xvd2VyID8gJ2FtJyA6ICdBTSc7CiAgICB9CiAgfQoKICB2YXIgYmFzZUNvbmZpZyA9IHsKICAgIGNhbGVuZGFyOiBkZWZhdWx0Q2FsZW5kYXIsCiAgICBsb25nRGF0ZUZvcm1hdDogZGVmYXVsdExvbmdEYXRlRm9ybWF0LAogICAgaW52YWxpZERhdGU6IGRlZmF1bHRJbnZhbGlkRGF0ZSwKICAgIG9yZGluYWw6IGRlZmF1bHRPcmRpbmFsLAogICAgZGF5T2ZNb250aE9yZGluYWxQYXJzZTogZGVmYXVsdERheU9mTW9udGhPcmRpbmFsUGFyc2UsCiAgICByZWxhdGl2ZVRpbWU6IGRlZmF1bHRSZWxhdGl2ZVRpbWUsCiAgICBtb250aHM6IGRlZmF1bHRMb2NhbGVNb250aHMsCiAgICBtb250aHNTaG9ydDogZGVmYXVsdExvY2FsZU1vbnRoc1Nob3J0LAogICAgd2VlazogZGVmYXVsdExvY2FsZVdlZWssCiAgICB3ZWVrZGF5czogZGVmYXVsdExvY2FsZVdlZWtkYXlzLAogICAgd2Vla2RheXNNaW46IGRlZmF1bHRMb2NhbGVXZWVrZGF5c01pbiwKICAgIHdlZWtkYXlzU2hvcnQ6IGRlZmF1bHRMb2NhbGVXZWVrZGF5c1Nob3J0LAogICAgbWVyaWRpZW1QYXJzZTogZGVmYXVsdExvY2FsZU1lcmlkaWVtUGFyc2UKICB9OyAvLyBpbnRlcm5hbCBzdG9yYWdlIGZvciBsb2NhbGUgY29uZmlnIGZpbGVzCgogIHZhciBsb2NhbGVzID0ge30sCiAgICAgIGxvY2FsZUZhbWlsaWVzID0ge30sCiAgICAgIGdsb2JhbExvY2FsZTsKCiAgZnVuY3Rpb24gY29tbW9uUHJlZml4KGFycjEsIGFycjIpIHsKICAgIHZhciBpLAogICAgICAgIG1pbmwgPSBNYXRoLm1pbihhcnIxLmxlbmd0aCwgYXJyMi5sZW5ndGgpOwoKICAgIGZvciAoaSA9IDA7IGkgPCBtaW5sOyBpICs9IDEpIHsKICAgICAgaWYgKGFycjFbaV0gIT09IGFycjJbaV0pIHsKICAgICAgICByZXR1cm4gaTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBtaW5sOwogIH0KCiAgZnVuY3Rpb24gbm9ybWFsaXplTG9jYWxlKGtleSkgewogICAgcmV0dXJuIGtleSA/IGtleS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJ18nLCAnLScpIDoga2V5OwogIH0gLy8gcGljayB0aGUgbG9jYWxlIGZyb20gdGhlIGFycmF5CiAgLy8gdHJ5IFsnZW4tYXUnLCAnZW4tZ2InXSBhcyAnZW4tYXUnLCAnZW4tZ2InLCAnZW4nLCBhcyBpbiBtb3ZlIHRocm91Z2ggdGhlIGxpc3QgdHJ5aW5nIGVhY2gKICAvLyBzdWJzdHJpbmcgZnJvbSBtb3N0IHNwZWNpZmljIHRvIGxlYXN0LCBidXQgbW92ZSB0byB0aGUgbmV4dCBhcnJheSBpdGVtIGlmIGl0J3MgYSBtb3JlIHNwZWNpZmljIHZhcmlhbnQgdGhhbiB0aGUgY3VycmVudCByb290CgoKICBmdW5jdGlvbiBjaG9vc2VMb2NhbGUobmFtZXMpIHsKICAgIHZhciBpID0gMCwKICAgICAgICBqLAogICAgICAgIG5leHQsCiAgICAgICAgbG9jYWxlLAogICAgICAgIHNwbGl0OwoKICAgIHdoaWxlIChpIDwgbmFtZXMubGVuZ3RoKSB7CiAgICAgIHNwbGl0ID0gbm9ybWFsaXplTG9jYWxlKG5hbWVzW2ldKS5zcGxpdCgnLScpOwogICAgICBqID0gc3BsaXQubGVuZ3RoOwogICAgICBuZXh0ID0gbm9ybWFsaXplTG9jYWxlKG5hbWVzW2kgKyAxXSk7CiAgICAgIG5leHQgPSBuZXh0ID8gbmV4dC5zcGxpdCgnLScpIDogbnVsbDsKCiAgICAgIHdoaWxlIChqID4gMCkgewogICAgICAgIGxvY2FsZSA9IGxvYWRMb2NhbGUoc3BsaXQuc2xpY2UoMCwgaikuam9pbignLScpKTsKCiAgICAgICAgaWYgKGxvY2FsZSkgewogICAgICAgICAgcmV0dXJuIGxvY2FsZTsKICAgICAgICB9CgogICAgICAgIGlmIChuZXh0ICYmIG5leHQubGVuZ3RoID49IGogJiYgY29tbW9uUHJlZml4KHNwbGl0LCBuZXh0KSA+PSBqIC0gMSkgewogICAgICAgICAgLy90aGUgbmV4dCBhcnJheSBpdGVtIGlzIGJldHRlciB0aGFuIGEgc2hhbGxvd2VyIHN1YnN0cmluZyBvZiB0aGlzIG9uZQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBqLS07CiAgICAgIH0KCiAgICAgIGkrKzsKICAgIH0KCiAgICByZXR1cm4gZ2xvYmFsTG9jYWxlOwogIH0KCiAgZnVuY3Rpb24gbG9hZExvY2FsZShuYW1lKSB7CiAgICB2YXIgb2xkTG9jYWxlID0gbnVsbCwKICAgICAgICBhbGlhc2VkUmVxdWlyZTsgLy8gVE9ETzogRmluZCBhIGJldHRlciB3YXkgdG8gcmVnaXN0ZXIgYW5kIGxvYWQgYWxsIHRoZSBsb2NhbGVzIGluIE5vZGUKCiAgICBpZiAobG9jYWxlc1tuYW1lXSA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZSAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICB0cnkgewogICAgICAgIG9sZExvY2FsZSA9IGdsb2JhbExvY2FsZS5fYWJicjsKICAgICAgICBhbGlhc2VkUmVxdWlyZSA9IHJlcXVpcmU7CiAgICAgICAgYWxpYXNlZFJlcXVpcmUoJy4vbG9jYWxlLycgKyBuYW1lKTsKICAgICAgICBnZXRTZXRHbG9iYWxMb2NhbGUob2xkTG9jYWxlKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIG1hcmsgYXMgbm90IGZvdW5kIHRvIGF2b2lkIHJlcGVhdGluZyBleHBlbnNpdmUgZmlsZSByZXF1aXJlIGNhbGwgY2F1c2luZyBoaWdoIENQVQogICAgICAgIC8vIHdoZW4gdHJ5aW5nIHRvIGZpbmQgZW4tVVMsIGVuX1VTLCBlbi11cyBmb3IgZXZlcnkgZm9ybWF0IGNhbGwKICAgICAgICBsb2NhbGVzW25hbWVdID0gbnVsbDsgLy8gbnVsbCBtZWFucyBub3QgZm91bmQKICAgICAgfQogICAgfQoKICAgIHJldHVybiBsb2NhbGVzW25hbWVdOwogIH0gLy8gVGhpcyBmdW5jdGlvbiB3aWxsIGxvYWQgbG9jYWxlIGFuZCB0aGVuIHNldCB0aGUgZ2xvYmFsIGxvY2FsZS4gIElmCiAgLy8gbm8gYXJndW1lbnRzIGFyZSBwYXNzZWQgaW4sIGl0IHdpbGwgc2ltcGx5IHJldHVybiB0aGUgY3VycmVudCBnbG9iYWwKICAvLyBsb2NhbGUga2V5LgoKCiAgZnVuY3Rpb24gZ2V0U2V0R2xvYmFsTG9jYWxlKGtleSwgdmFsdWVzKSB7CiAgICB2YXIgZGF0YTsKCiAgICBpZiAoa2V5KSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZXMpKSB7CiAgICAgICAgZGF0YSA9IGdldExvY2FsZShrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEgPSBkZWZpbmVMb2NhbGUoa2V5LCB2YWx1ZXMpOwogICAgICB9CgogICAgICBpZiAoZGF0YSkgewogICAgICAgIC8vIG1vbWVudC5kdXJhdGlvbi5fbG9jYWxlID0gbW9tZW50Ll9sb2NhbGUgPSBkYXRhOwogICAgICAgIGdsb2JhbExvY2FsZSA9IGRhdGE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJyAmJiBjb25zb2xlLndhcm4pIHsKICAgICAgICAgIC8vd2FybiB1c2VyIGlmIGFyZ3VtZW50cyBhcmUgcGFzc2VkIGJ1dCB0aGUgbG9jYWxlIGNvdWxkIG5vdCBiZSBzZXQKICAgICAgICAgIGNvbnNvbGUud2FybignTG9jYWxlICcgKyBrZXkgKyAnIG5vdCBmb3VuZC4gRGlkIHlvdSBmb3JnZXQgdG8gbG9hZCBpdD8nKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZ2xvYmFsTG9jYWxlLl9hYmJyOwogIH0KCiAgZnVuY3Rpb24gZGVmaW5lTG9jYWxlKG5hbWUsIGNvbmZpZykgewogICAgaWYgKGNvbmZpZyAhPT0gbnVsbCkgewogICAgICB2YXIgbG9jYWxlLAogICAgICAgICAgcGFyZW50Q29uZmlnID0gYmFzZUNvbmZpZzsKICAgICAgY29uZmlnLmFiYnIgPSBuYW1lOwoKICAgICAgaWYgKGxvY2FsZXNbbmFtZV0gIT0gbnVsbCkgewogICAgICAgIGRlcHJlY2F0ZVNpbXBsZSgnZGVmaW5lTG9jYWxlT3ZlcnJpZGUnLCAndXNlIG1vbWVudC51cGRhdGVMb2NhbGUobG9jYWxlTmFtZSwgY29uZmlnKSB0byBjaGFuZ2UgJyArICdhbiBleGlzdGluZyBsb2NhbGUuIG1vbWVudC5kZWZpbmVMb2NhbGUobG9jYWxlTmFtZSwgJyArICdjb25maWcpIHNob3VsZCBvbmx5IGJlIHVzZWQgZm9yIGNyZWF0aW5nIGEgbmV3IGxvY2FsZSAnICsgJ1NlZSBodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL2RlZmluZS1sb2NhbGUvIGZvciBtb3JlIGluZm8uJyk7CiAgICAgICAgcGFyZW50Q29uZmlnID0gbG9jYWxlc1tuYW1lXS5fY29uZmlnOwogICAgICB9IGVsc2UgaWYgKGNvbmZpZy5wYXJlbnRMb2NhbGUgIT0gbnVsbCkgewogICAgICAgIGlmIChsb2NhbGVzW2NvbmZpZy5wYXJlbnRMb2NhbGVdICE9IG51bGwpIHsKICAgICAgICAgIHBhcmVudENvbmZpZyA9IGxvY2FsZXNbY29uZmlnLnBhcmVudExvY2FsZV0uX2NvbmZpZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbG9jYWxlID0gbG9hZExvY2FsZShjb25maWcucGFyZW50TG9jYWxlKTsKCiAgICAgICAgICBpZiAobG9jYWxlICE9IG51bGwpIHsKICAgICAgICAgICAgcGFyZW50Q29uZmlnID0gbG9jYWxlLl9jb25maWc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIWxvY2FsZUZhbWlsaWVzW2NvbmZpZy5wYXJlbnRMb2NhbGVdKSB7CiAgICAgICAgICAgICAgbG9jYWxlRmFtaWxpZXNbY29uZmlnLnBhcmVudExvY2FsZV0gPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbG9jYWxlRmFtaWxpZXNbY29uZmlnLnBhcmVudExvY2FsZV0ucHVzaCh7CiAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBsb2NhbGVzW25hbWVdID0gbmV3IExvY2FsZShtZXJnZUNvbmZpZ3MocGFyZW50Q29uZmlnLCBjb25maWcpKTsKCiAgICAgIGlmIChsb2NhbGVGYW1pbGllc1tuYW1lXSkgewogICAgICAgIGxvY2FsZUZhbWlsaWVzW25hbWVdLmZvckVhY2goZnVuY3Rpb24gKHgpIHsKICAgICAgICAgIGRlZmluZUxvY2FsZSh4Lm5hbWUsIHguY29uZmlnKTsKICAgICAgICB9KTsKICAgICAgfSAvLyBiYWNrd2FyZHMgY29tcGF0IGZvciBub3c6IGFsc28gc2V0IHRoZSBsb2NhbGUKICAgICAgLy8gbWFrZSBzdXJlIHdlIHNldCB0aGUgbG9jYWxlIEFGVEVSIGFsbCBjaGlsZCBsb2NhbGVzIGhhdmUgYmVlbgogICAgICAvLyBjcmVhdGVkLCBzbyB3ZSB3b24ndCBlbmQgdXAgd2l0aCB0aGUgY2hpbGQgbG9jYWxlIHNldC4KCgogICAgICBnZXRTZXRHbG9iYWxMb2NhbGUobmFtZSk7CiAgICAgIHJldHVybiBsb2NhbGVzW25hbWVdOwogICAgfSBlbHNlIHsKICAgICAgLy8gdXNlZnVsIGZvciB0ZXN0aW5nCiAgICAgIGRlbGV0ZSBsb2NhbGVzW25hbWVdOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUxvY2FsZShuYW1lLCBjb25maWcpIHsKICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICB2YXIgbG9jYWxlLAogICAgICAgICAgdG1wTG9jYWxlLAogICAgICAgICAgcGFyZW50Q29uZmlnID0gYmFzZUNvbmZpZzsKCiAgICAgIGlmIChsb2NhbGVzW25hbWVdICE9IG51bGwgJiYgbG9jYWxlc1tuYW1lXS5wYXJlbnRMb2NhbGUgIT0gbnVsbCkgewogICAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyBjaGlsZCBsb2NhbGUgaW4tcGxhY2UgdG8gYXZvaWQgbWVtb3J5LWxlYWtzCiAgICAgICAgbG9jYWxlc1tuYW1lXS5zZXQobWVyZ2VDb25maWdzKGxvY2FsZXNbbmFtZV0uX2NvbmZpZywgY29uZmlnKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTUVSR0UKICAgICAgICB0bXBMb2NhbGUgPSBsb2FkTG9jYWxlKG5hbWUpOwoKICAgICAgICBpZiAodG1wTG9jYWxlICE9IG51bGwpIHsKICAgICAgICAgIHBhcmVudENvbmZpZyA9IHRtcExvY2FsZS5fY29uZmlnOwogICAgICAgIH0KCiAgICAgICAgY29uZmlnID0gbWVyZ2VDb25maWdzKHBhcmVudENvbmZpZywgY29uZmlnKTsKCiAgICAgICAgaWYgKHRtcExvY2FsZSA9PSBudWxsKSB7CiAgICAgICAgICAvLyB1cGRhdGVMb2NhbGUgaXMgY2FsbGVkIGZvciBjcmVhdGluZyBhIG5ldyBsb2NhbGUKICAgICAgICAgIC8vIFNldCBhYmJyIHNvIGl0IHdpbGwgaGF2ZSBhIG5hbWUgKGdldHRlcnMgcmV0dXJuCiAgICAgICAgICAvLyB1bmRlZmluZWQgb3RoZXJ3aXNlKS4KICAgICAgICAgIGNvbmZpZy5hYmJyID0gbmFtZTsKICAgICAgICB9CgogICAgICAgIGxvY2FsZSA9IG5ldyBMb2NhbGUoY29uZmlnKTsKICAgICAgICBsb2NhbGUucGFyZW50TG9jYWxlID0gbG9jYWxlc1tuYW1lXTsKICAgICAgICBsb2NhbGVzW25hbWVdID0gbG9jYWxlOwogICAgICB9IC8vIGJhY2t3YXJkcyBjb21wYXQgZm9yIG5vdzogYWxzbyBzZXQgdGhlIGxvY2FsZQoKCiAgICAgIGdldFNldEdsb2JhbExvY2FsZShuYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHBhc3MgbnVsbCBmb3IgY29uZmlnIHRvIHVudXBkYXRlLCB1c2VmdWwgZm9yIHRlc3RzCiAgICAgIGlmIChsb2NhbGVzW25hbWVdICE9IG51bGwpIHsKICAgICAgICBpZiAobG9jYWxlc1tuYW1lXS5wYXJlbnRMb2NhbGUgIT0gbnVsbCkgewogICAgICAgICAgbG9jYWxlc1tuYW1lXSA9IGxvY2FsZXNbbmFtZV0ucGFyZW50TG9jYWxlOwoKICAgICAgICAgIGlmIChuYW1lID09PSBnZXRTZXRHbG9iYWxMb2NhbGUoKSkgewogICAgICAgICAgICBnZXRTZXRHbG9iYWxMb2NhbGUobmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChsb2NhbGVzW25hbWVdICE9IG51bGwpIHsKICAgICAgICAgIGRlbGV0ZSBsb2NhbGVzW25hbWVdOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBsb2NhbGVzW25hbWVdOwogIH0gLy8gcmV0dXJucyBsb2NhbGUgZGF0YQoKCiAgZnVuY3Rpb24gZ2V0TG9jYWxlKGtleSkgewogICAgdmFyIGxvY2FsZTsKCiAgICBpZiAoa2V5ICYmIGtleS5fbG9jYWxlICYmIGtleS5fbG9jYWxlLl9hYmJyKSB7CiAgICAgIGtleSA9IGtleS5fbG9jYWxlLl9hYmJyOwogICAgfQoKICAgIGlmICgha2V5KSB7CiAgICAgIHJldHVybiBnbG9iYWxMb2NhbGU7CiAgICB9CgogICAgaWYgKCFpc0FycmF5KGtleSkpIHsKICAgICAgLy9zaG9ydC1jaXJjdWl0IGV2ZXJ5dGhpbmcgZWxzZQogICAgICBsb2NhbGUgPSBsb2FkTG9jYWxlKGtleSk7CgogICAgICBpZiAobG9jYWxlKSB7CiAgICAgICAgcmV0dXJuIGxvY2FsZTsKICAgICAgfQoKICAgICAga2V5ID0gW2tleV07CiAgICB9CgogICAgcmV0dXJuIGNob29zZUxvY2FsZShrZXkpOwogIH0KCiAgZnVuY3Rpb24gbGlzdExvY2FsZXMoKSB7CiAgICByZXR1cm4ga2V5cyhsb2NhbGVzKTsKICB9CgogIGZ1bmN0aW9uIGNoZWNrT3ZlcmZsb3cobSkgewogICAgdmFyIG92ZXJmbG93LAogICAgICAgIGEgPSBtLl9hOwoKICAgIGlmIChhICYmIGdldFBhcnNpbmdGbGFncyhtKS5vdmVyZmxvdyA9PT0gLTIpIHsKICAgICAgb3ZlcmZsb3cgPSBhW01PTlRIXSA8IDAgfHwgYVtNT05USF0gPiAxMSA/IE1PTlRIIDogYVtEQVRFXSA8IDEgfHwgYVtEQVRFXSA+IGRheXNJbk1vbnRoKGFbWUVBUl0sIGFbTU9OVEhdKSA/IERBVEUgOiBhW0hPVVJdIDwgMCB8fCBhW0hPVVJdID4gMjQgfHwgYVtIT1VSXSA9PT0gMjQgJiYgKGFbTUlOVVRFXSAhPT0gMCB8fCBhW1NFQ09ORF0gIT09IDAgfHwgYVtNSUxMSVNFQ09ORF0gIT09IDApID8gSE9VUiA6IGFbTUlOVVRFXSA8IDAgfHwgYVtNSU5VVEVdID4gNTkgPyBNSU5VVEUgOiBhW1NFQ09ORF0gPCAwIHx8IGFbU0VDT05EXSA+IDU5ID8gU0VDT05EIDogYVtNSUxMSVNFQ09ORF0gPCAwIHx8IGFbTUlMTElTRUNPTkRdID4gOTk5ID8gTUlMTElTRUNPTkQgOiAtMTsKCiAgICAgIGlmIChnZXRQYXJzaW5nRmxhZ3MobSkuX292ZXJmbG93RGF5T2ZZZWFyICYmIChvdmVyZmxvdyA8IFlFQVIgfHwgb3ZlcmZsb3cgPiBEQVRFKSkgewogICAgICAgIG92ZXJmbG93ID0gREFURTsKICAgICAgfQoKICAgICAgaWYgKGdldFBhcnNpbmdGbGFncyhtKS5fb3ZlcmZsb3dXZWVrcyAmJiBvdmVyZmxvdyA9PT0gLTEpIHsKICAgICAgICBvdmVyZmxvdyA9IFdFRUs7CiAgICAgIH0KCiAgICAgIGlmIChnZXRQYXJzaW5nRmxhZ3MobSkuX292ZXJmbG93V2Vla2RheSAmJiBvdmVyZmxvdyA9PT0gLTEpIHsKICAgICAgICBvdmVyZmxvdyA9IFdFRUtEQVk7CiAgICAgIH0KCiAgICAgIGdldFBhcnNpbmdGbGFncyhtKS5vdmVyZmxvdyA9IG92ZXJmbG93OwogICAgfQoKICAgIHJldHVybiBtOwogIH0gLy8gaXNvIDg2MDEgcmVnZXgKICAvLyAwMDAwLTAwLTAwIDAwMDAtVzAwIG9yIDAwMDAtVzAwLTAgKyBUICsgMDAgb3IgMDA6MDAgb3IgMDA6MDA6MDAgb3IgMDA6MDA6MDAuMDAwICsgKzAwOjAwIG9yICswMDAwIG9yICswMCkKCgogIHZhciBleHRlbmRlZElzb1JlZ2V4ID0gL15ccyooKD86WystXVxkezZ9fFxkezR9KS0oPzpcZFxkLVxkXGR8V1xkXGQtXGR8V1xkXGR8XGRcZFxkfFxkXGQpKSg/OihUfCApKFxkXGQoPzo6XGRcZCg/OjpcZFxkKD86Wy4sXVxkKyk/KT8pPykoWystXVxkXGQoPzo6P1xkXGQpP3xccypaKT8pPyQvLAogICAgICBiYXNpY0lzb1JlZ2V4ID0gL15ccyooKD86WystXVxkezZ9fFxkezR9KSg/OlxkXGRcZFxkfFdcZFxkXGR8V1xkXGR8XGRcZFxkfFxkXGR8KSkoPzooVHwgKShcZFxkKD86XGRcZCg/OlxkXGQoPzpbLixdXGQrKT8pPyk/KShbKy1dXGRcZCg/Ojo/XGRcZCk/fFxzKlopPyk/JC8sCiAgICAgIHR6UmVnZXggPSAvWnxbKy1dXGRcZCg/Ojo/XGRcZCk/LywKICAgICAgaXNvRGF0ZXMgPSBbWydZWVlZWVktTU0tREQnLCAvWystXVxkezZ9LVxkXGQtXGRcZC9dLCBbJ1lZWVktTU0tREQnLCAvXGR7NH0tXGRcZC1cZFxkL10sIFsnR0dHRy1bV11XVy1FJywgL1xkezR9LVdcZFxkLVxkL10sIFsnR0dHRy1bV11XVycsIC9cZHs0fS1XXGRcZC8sIGZhbHNlXSwgWydZWVlZLURERCcsIC9cZHs0fS1cZHszfS9dLCBbJ1lZWVktTU0nLCAvXGR7NH0tXGRcZC8sIGZhbHNlXSwgWydZWVlZWVlNTUREJywgL1srLV1cZHsxMH0vXSwgWydZWVlZTU1ERCcsIC9cZHs4fS9dLCBbJ0dHR0dbV11XV0UnLCAvXGR7NH1XXGR7M30vXSwgWydHR0dHW1ddV1cnLCAvXGR7NH1XXGR7Mn0vLCBmYWxzZV0sIFsnWVlZWURERCcsIC9cZHs3fS9dLCBbJ1lZWVlNTScsIC9cZHs2fS8sIGZhbHNlXSwgWydZWVlZJywgL1xkezR9LywgZmFsc2VdXSwKICAgICAgLy8gaXNvIHRpbWUgZm9ybWF0cyBhbmQgcmVnZXhlcwogIGlzb1RpbWVzID0gW1snSEg6bW06c3MuU1NTUycsIC9cZFxkOlxkXGQ6XGRcZFwuXGQrL10sIFsnSEg6bW06c3MsU1NTUycsIC9cZFxkOlxkXGQ6XGRcZCxcZCsvXSwgWydISDptbTpzcycsIC9cZFxkOlxkXGQ6XGRcZC9dLCBbJ0hIOm1tJywgL1xkXGQ6XGRcZC9dLCBbJ0hIbW1zcy5TU1NTJywgL1xkXGRcZFxkXGRcZFwuXGQrL10sIFsnSEhtbXNzLFNTU1MnLCAvXGRcZFxkXGRcZFxkLFxkKy9dLCBbJ0hIbW1zcycsIC9cZFxkXGRcZFxkXGQvXSwgWydISG1tJywgL1xkXGRcZFxkL10sIFsnSEgnLCAvXGRcZC9dXSwKICAgICAgYXNwTmV0SnNvblJlZ2V4ID0gL15cLz9EYXRlXCgoLT9cZCspL2ksCiAgICAgIC8vIFJGQyAyODIyIHJlZ2V4OiBGb3IgZGV0YWlscyBzZWUgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzI4MjIjc2VjdGlvbi0zLjMKICByZmMyODIyID0gL14oPzooTW9ufFR1ZXxXZWR8VGh1fEZyaXxTYXR8U3VuKSw/XHMpPyhcZHsxLDJ9KVxzKEphbnxGZWJ8TWFyfEFwcnxNYXl8SnVufEp1bHxBdWd8U2VwfE9jdHxOb3Z8RGVjKVxzKFxkezIsNH0pXHMoXGRcZCk6KFxkXGQpKD86OihcZFxkKSk/XHMoPzooVVR8R01UfFtFQ01QXVtTRF1UKXwoW1p6XSl8KFsrLV1cZHs0fSkpJC8sCiAgICAgIG9ic09mZnNldHMgPSB7CiAgICBVVDogMCwKICAgIEdNVDogMCwKICAgIEVEVDogLTQgKiA2MCwKICAgIEVTVDogLTUgKiA2MCwKICAgIENEVDogLTUgKiA2MCwKICAgIENTVDogLTYgKiA2MCwKICAgIE1EVDogLTYgKiA2MCwKICAgIE1TVDogLTcgKiA2MCwKICAgIFBEVDogLTcgKiA2MCwKICAgIFBTVDogLTggKiA2MAogIH07IC8vIGRhdGUgZnJvbSBpc28gZm9ybWF0CgogIGZ1bmN0aW9uIGNvbmZpZ0Zyb21JU08oY29uZmlnKSB7CiAgICB2YXIgaSwKICAgICAgICBsLAogICAgICAgIHN0cmluZyA9IGNvbmZpZy5faSwKICAgICAgICBtYXRjaCA9IGV4dGVuZGVkSXNvUmVnZXguZXhlYyhzdHJpbmcpIHx8IGJhc2ljSXNvUmVnZXguZXhlYyhzdHJpbmcpLAogICAgICAgIGFsbG93VGltZSwKICAgICAgICBkYXRlRm9ybWF0LAogICAgICAgIHRpbWVGb3JtYXQsCiAgICAgICAgdHpGb3JtYXQ7CgogICAgaWYgKG1hdGNoKSB7CiAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLmlzbyA9IHRydWU7CgogICAgICBmb3IgKGkgPSAwLCBsID0gaXNvRGF0ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGlzb0RhdGVzW2ldWzFdLmV4ZWMobWF0Y2hbMV0pKSB7CiAgICAgICAgICBkYXRlRm9ybWF0ID0gaXNvRGF0ZXNbaV1bMF07CiAgICAgICAgICBhbGxvd1RpbWUgPSBpc29EYXRlc1tpXVsyXSAhPT0gZmFsc2U7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChkYXRlRm9ybWF0ID09IG51bGwpIHsKICAgICAgICBjb25maWcuX2lzVmFsaWQgPSBmYWxzZTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChtYXRjaFszXSkgewogICAgICAgIGZvciAoaSA9IDAsIGwgPSBpc29UaW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGlmIChpc29UaW1lc1tpXVsxXS5leGVjKG1hdGNoWzNdKSkgewogICAgICAgICAgICAvLyBtYXRjaFsyXSBzaG91bGQgYmUgJ1QnIG9yIHNwYWNlCiAgICAgICAgICAgIHRpbWVGb3JtYXQgPSAobWF0Y2hbMl0gfHwgJyAnKSArIGlzb1RpbWVzW2ldWzBdOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aW1lRm9ybWF0ID09IG51bGwpIHsKICAgICAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFhbGxvd1RpbWUgJiYgdGltZUZvcm1hdCAhPSBudWxsKSB7CiAgICAgICAgY29uZmlnLl9pc1ZhbGlkID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAobWF0Y2hbNF0pIHsKICAgICAgICBpZiAodHpSZWdleC5leGVjKG1hdGNoWzRdKSkgewogICAgICAgICAgdHpGb3JtYXQgPSAnWic7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uZmlnLl9mID0gZGF0ZUZvcm1hdCArICh0aW1lRm9ybWF0IHx8ICcnKSArICh0ekZvcm1hdCB8fCAnJyk7CiAgICAgIGNvbmZpZ0Zyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZXh0cmFjdEZyb21SRkMyODIyU3RyaW5ncyh5ZWFyU3RyLCBtb250aFN0ciwgZGF5U3RyLCBob3VyU3RyLCBtaW51dGVTdHIsIHNlY29uZFN0cikgewogICAgdmFyIHJlc3VsdCA9IFt1bnRydW5jYXRlWWVhcih5ZWFyU3RyKSwgZGVmYXVsdExvY2FsZU1vbnRoc1Nob3J0LmluZGV4T2YobW9udGhTdHIpLCBwYXJzZUludChkYXlTdHIsIDEwKSwgcGFyc2VJbnQoaG91clN0ciwgMTApLCBwYXJzZUludChtaW51dGVTdHIsIDEwKV07CgogICAgaWYgKHNlY29uZFN0cikgewogICAgICByZXN1bHQucHVzaChwYXJzZUludChzZWNvbmRTdHIsIDEwKSk7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIHVudHJ1bmNhdGVZZWFyKHllYXJTdHIpIHsKICAgIHZhciB5ZWFyID0gcGFyc2VJbnQoeWVhclN0ciwgMTApOwoKICAgIGlmICh5ZWFyIDw9IDQ5KSB7CiAgICAgIHJldHVybiAyMDAwICsgeWVhcjsKICAgIH0gZWxzZSBpZiAoeWVhciA8PSA5OTkpIHsKICAgICAgcmV0dXJuIDE5MDAgKyB5ZWFyOwogICAgfQoKICAgIHJldHVybiB5ZWFyOwogIH0KCiAgZnVuY3Rpb24gcHJlcHJvY2Vzc1JGQzI4MjIocykgewogICAgLy8gUmVtb3ZlIGNvbW1lbnRzIGFuZCBmb2xkaW5nIHdoaXRlc3BhY2UgYW5kIHJlcGxhY2UgbXVsdGlwbGUtc3BhY2VzIHdpdGggYSBzaW5nbGUgc3BhY2UKICAgIHJldHVybiBzLnJlcGxhY2UoL1woW14pXSpcKXxbXG5cdF0vZywgJyAnKS5yZXBsYWNlKC8oXHNccyspL2csICcgJykucmVwbGFjZSgvXlxzXHMqLywgJycpLnJlcGxhY2UoL1xzXHMqJC8sICcnKTsKICB9CgogIGZ1bmN0aW9uIGNoZWNrV2Vla2RheSh3ZWVrZGF5U3RyLCBwYXJzZWRJbnB1dCwgY29uZmlnKSB7CiAgICBpZiAod2Vla2RheVN0cikgewogICAgICAvLyBUT0RPOiBSZXBsYWNlIHRoZSB2YW5pbGxhIEpTIERhdGUgb2JqZWN0IHdpdGggYW4gaW5kZXBlbmRlbnQgZGF5LW9mLXdlZWsgY2hlY2suCiAgICAgIHZhciB3ZWVrZGF5UHJvdmlkZWQgPSBkZWZhdWx0TG9jYWxlV2Vla2RheXNTaG9ydC5pbmRleE9mKHdlZWtkYXlTdHIpLAogICAgICAgICAgd2Vla2RheUFjdHVhbCA9IG5ldyBEYXRlKHBhcnNlZElucHV0WzBdLCBwYXJzZWRJbnB1dFsxXSwgcGFyc2VkSW5wdXRbMl0pLmdldERheSgpOwoKICAgICAgaWYgKHdlZWtkYXlQcm92aWRlZCAhPT0gd2Vla2RheUFjdHVhbCkgewogICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLndlZWtkYXlNaXNtYXRjaCA9IHRydWU7CiAgICAgICAgY29uZmlnLl9pc1ZhbGlkID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiBjYWxjdWxhdGVPZmZzZXQob2JzT2Zmc2V0LCBtaWxpdGFyeU9mZnNldCwgbnVtT2Zmc2V0KSB7CiAgICBpZiAob2JzT2Zmc2V0KSB7CiAgICAgIHJldHVybiBvYnNPZmZzZXRzW29ic09mZnNldF07CiAgICB9IGVsc2UgaWYgKG1pbGl0YXJ5T2Zmc2V0KSB7CiAgICAgIC8vIHRoZSBvbmx5IGFsbG93ZWQgbWlsaXRhcnkgdHogaXMgWgogICAgICByZXR1cm4gMDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBobSA9IHBhcnNlSW50KG51bU9mZnNldCwgMTApLAogICAgICAgICAgbSA9IGhtICUgMTAwLAogICAgICAgICAgaCA9IChobSAtIG0pIC8gMTAwOwogICAgICByZXR1cm4gaCAqIDYwICsgbTsKICAgIH0KICB9IC8vIGRhdGUgYW5kIHRpbWUgZnJvbSByZWYgMjgyMiBmb3JtYXQKCgogIGZ1bmN0aW9uIGNvbmZpZ0Zyb21SRkMyODIyKGNvbmZpZykgewogICAgdmFyIG1hdGNoID0gcmZjMjgyMi5leGVjKHByZXByb2Nlc3NSRkMyODIyKGNvbmZpZy5faSkpLAogICAgICAgIHBhcnNlZEFycmF5OwoKICAgIGlmIChtYXRjaCkgewogICAgICBwYXJzZWRBcnJheSA9IGV4dHJhY3RGcm9tUkZDMjgyMlN0cmluZ3MobWF0Y2hbNF0sIG1hdGNoWzNdLCBtYXRjaFsyXSwgbWF0Y2hbNV0sIG1hdGNoWzZdLCBtYXRjaFs3XSk7CgogICAgICBpZiAoIWNoZWNrV2Vla2RheShtYXRjaFsxXSwgcGFyc2VkQXJyYXksIGNvbmZpZykpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbmZpZy5fYSA9IHBhcnNlZEFycmF5OwogICAgICBjb25maWcuX3R6bSA9IGNhbGN1bGF0ZU9mZnNldChtYXRjaFs4XSwgbWF0Y2hbOV0sIG1hdGNoWzEwXSk7CiAgICAgIGNvbmZpZy5fZCA9IGNyZWF0ZVVUQ0RhdGUuYXBwbHkobnVsbCwgY29uZmlnLl9hKTsKCiAgICAgIGNvbmZpZy5fZC5zZXRVVENNaW51dGVzKGNvbmZpZy5fZC5nZXRVVENNaW51dGVzKCkgLSBjb25maWcuX3R6bSk7CgogICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5yZmMyODIyID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgfQogIH0gLy8gZGF0ZSBmcm9tIDEpIEFTUC5ORVQsIDIpIElTTywgMykgUkZDIDI4MjIgZm9ybWF0cywgb3IgNCkgb3B0aW9uYWwgZmFsbGJhY2sgaWYgcGFyc2luZyBpc24ndCBzdHJpY3QKCgogIGZ1bmN0aW9uIGNvbmZpZ0Zyb21TdHJpbmcoY29uZmlnKSB7CiAgICB2YXIgbWF0Y2hlZCA9IGFzcE5ldEpzb25SZWdleC5leGVjKGNvbmZpZy5faSk7CgogICAgaWYgKG1hdGNoZWQgIT09IG51bGwpIHsKICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoK21hdGNoZWRbMV0pOwogICAgICByZXR1cm47CiAgICB9CgogICAgY29uZmlnRnJvbUlTTyhjb25maWcpOwoKICAgIGlmIChjb25maWcuX2lzVmFsaWQgPT09IGZhbHNlKSB7CiAgICAgIGRlbGV0ZSBjb25maWcuX2lzVmFsaWQ7CiAgICB9IGVsc2UgewogICAgICByZXR1cm47CiAgICB9CgogICAgY29uZmlnRnJvbVJGQzI4MjIoY29uZmlnKTsKCiAgICBpZiAoY29uZmlnLl9pc1ZhbGlkID09PSBmYWxzZSkgewogICAgICBkZWxldGUgY29uZmlnLl9pc1ZhbGlkOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChjb25maWcuX3N0cmljdCkgewogICAgICBjb25maWcuX2lzVmFsaWQgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEZpbmFsIGF0dGVtcHQsIHVzZSBJbnB1dCBGYWxsYmFjawogICAgICBob29rcy5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayhjb25maWcpOwogICAgfQogIH0KCiAgaG9va3MuY3JlYXRlRnJvbUlucHV0RmFsbGJhY2sgPSBkZXByZWNhdGUoJ3ZhbHVlIHByb3ZpZGVkIGlzIG5vdCBpbiBhIHJlY29nbml6ZWQgUkZDMjgyMiBvciBJU08gZm9ybWF0LiBtb21lbnQgY29uc3RydWN0aW9uIGZhbGxzIGJhY2sgdG8ganMgRGF0ZSgpLCAnICsgJ3doaWNoIGlzIG5vdCByZWxpYWJsZSBhY3Jvc3MgYWxsIGJyb3dzZXJzIGFuZCB2ZXJzaW9ucy4gTm9uIFJGQzI4MjIvSVNPIGRhdGUgZm9ybWF0cyBhcmUgJyArICdkaXNjb3VyYWdlZC4gUGxlYXNlIHJlZmVyIHRvIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvanMtZGF0ZS8gZm9yIG1vcmUgaW5mby4nLCBmdW5jdGlvbiAoY29uZmlnKSB7CiAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShjb25maWcuX2kgKyAoY29uZmlnLl91c2VVVEMgPyAnIFVUQycgOiAnJykpOwogIH0pOyAvLyBQaWNrIHRoZSBmaXJzdCBkZWZpbmVkIG9mIHR3byBvciB0aHJlZSBhcmd1bWVudHMuCgogIGZ1bmN0aW9uIGRlZmF1bHRzKGEsIGIsIGMpIHsKICAgIGlmIChhICE9IG51bGwpIHsKICAgICAgcmV0dXJuIGE7CiAgICB9CgogICAgaWYgKGIgIT0gbnVsbCkgewogICAgICByZXR1cm4gYjsKICAgIH0KCiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIGN1cnJlbnREYXRlQXJyYXkoY29uZmlnKSB7CiAgICAvLyBob29rcyBpcyBhY3R1YWxseSB0aGUgZXhwb3J0ZWQgbW9tZW50IG9iamVjdAogICAgdmFyIG5vd1ZhbHVlID0gbmV3IERhdGUoaG9va3Mubm93KCkpOwoKICAgIGlmIChjb25maWcuX3VzZVVUQykgewogICAgICByZXR1cm4gW25vd1ZhbHVlLmdldFVUQ0Z1bGxZZWFyKCksIG5vd1ZhbHVlLmdldFVUQ01vbnRoKCksIG5vd1ZhbHVlLmdldFVUQ0RhdGUoKV07CiAgICB9CgogICAgcmV0dXJuIFtub3dWYWx1ZS5nZXRGdWxsWWVhcigpLCBub3dWYWx1ZS5nZXRNb250aCgpLCBub3dWYWx1ZS5nZXREYXRlKCldOwogIH0gLy8gY29udmVydCBhbiBhcnJheSB0byBhIGRhdGUuCiAgLy8gdGhlIGFycmF5IHNob3VsZCBtaXJyb3IgdGhlIHBhcmFtZXRlcnMgYmVsb3cKICAvLyBub3RlOiBhbGwgdmFsdWVzIHBhc3QgdGhlIHllYXIgYXJlIG9wdGlvbmFsIGFuZCB3aWxsIGRlZmF1bHQgdG8gdGhlIGxvd2VzdCBwb3NzaWJsZSB2YWx1ZS4KICAvLyBbeWVhciwgbW9udGgsIGRheSAsIGhvdXIsIG1pbnV0ZSwgc2Vjb25kLCBtaWxsaXNlY29uZF0KCgogIGZ1bmN0aW9uIGNvbmZpZ0Zyb21BcnJheShjb25maWcpIHsKICAgIHZhciBpLAogICAgICAgIGRhdGUsCiAgICAgICAgaW5wdXQgPSBbXSwKICAgICAgICBjdXJyZW50RGF0ZSwKICAgICAgICBleHBlY3RlZFdlZWtkYXksCiAgICAgICAgeWVhclRvVXNlOwoKICAgIGlmIChjb25maWcuX2QpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGN1cnJlbnREYXRlID0gY3VycmVudERhdGVBcnJheShjb25maWcpOyAvL2NvbXB1dGUgZGF5IG9mIHRoZSB5ZWFyIGZyb20gd2Vla3MgYW5kIHdlZWtkYXlzCgogICAgaWYgKGNvbmZpZy5fdyAmJiBjb25maWcuX2FbREFURV0gPT0gbnVsbCAmJiBjb25maWcuX2FbTU9OVEhdID09IG51bGwpIHsKICAgICAgZGF5T2ZZZWFyRnJvbVdlZWtJbmZvKGNvbmZpZyk7CiAgICB9IC8vaWYgdGhlIGRheSBvZiB0aGUgeWVhciBpcyBzZXQsIGZpZ3VyZSBvdXQgd2hhdCBpdCBpcwoKCiAgICBpZiAoY29uZmlnLl9kYXlPZlllYXIgIT0gbnVsbCkgewogICAgICB5ZWFyVG9Vc2UgPSBkZWZhdWx0cyhjb25maWcuX2FbWUVBUl0sIGN1cnJlbnREYXRlW1lFQVJdKTsKCiAgICAgIGlmIChjb25maWcuX2RheU9mWWVhciA+IGRheXNJblllYXIoeWVhclRvVXNlKSB8fCBjb25maWcuX2RheU9mWWVhciA9PT0gMCkgewogICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLl9vdmVyZmxvd0RheU9mWWVhciA9IHRydWU7CiAgICAgIH0KCiAgICAgIGRhdGUgPSBjcmVhdGVVVENEYXRlKHllYXJUb1VzZSwgMCwgY29uZmlnLl9kYXlPZlllYXIpOwogICAgICBjb25maWcuX2FbTU9OVEhdID0gZGF0ZS5nZXRVVENNb250aCgpOwogICAgICBjb25maWcuX2FbREFURV0gPSBkYXRlLmdldFVUQ0RhdGUoKTsKICAgIH0gLy8gRGVmYXVsdCB0byBjdXJyZW50IGRhdGUuCiAgICAvLyAqIGlmIG5vIHllYXIsIG1vbnRoLCBkYXkgb2YgbW9udGggYXJlIGdpdmVuLCBkZWZhdWx0IHRvIHRvZGF5CiAgICAvLyAqIGlmIGRheSBvZiBtb250aCBpcyBnaXZlbiwgZGVmYXVsdCBtb250aCBhbmQgeWVhcgogICAgLy8gKiBpZiBtb250aCBpcyBnaXZlbiwgZGVmYXVsdCBvbmx5IHllYXIKICAgIC8vICogaWYgeWVhciBpcyBnaXZlbiwgZG9uJ3QgZGVmYXVsdCBhbnl0aGluZwoKCiAgICBmb3IgKGkgPSAwOyBpIDwgMyAmJiBjb25maWcuX2FbaV0gPT0gbnVsbDsgKytpKSB7CiAgICAgIGNvbmZpZy5fYVtpXSA9IGlucHV0W2ldID0gY3VycmVudERhdGVbaV07CiAgICB9IC8vIFplcm8gb3V0IHdoYXRldmVyIHdhcyBub3QgZGVmYXVsdGVkLCBpbmNsdWRpbmcgdGltZQoKCiAgICBmb3IgKDsgaSA8IDc7IGkrKykgewogICAgICBjb25maWcuX2FbaV0gPSBpbnB1dFtpXSA9IGNvbmZpZy5fYVtpXSA9PSBudWxsID8gaSA9PT0gMiA/IDEgOiAwIDogY29uZmlnLl9hW2ldOwogICAgfSAvLyBDaGVjayBmb3IgMjQ6MDA6MDAuMDAwCgoKICAgIGlmIChjb25maWcuX2FbSE9VUl0gPT09IDI0ICYmIGNvbmZpZy5fYVtNSU5VVEVdID09PSAwICYmIGNvbmZpZy5fYVtTRUNPTkRdID09PSAwICYmIGNvbmZpZy5fYVtNSUxMSVNFQ09ORF0gPT09IDApIHsKICAgICAgY29uZmlnLl9uZXh0RGF5ID0gdHJ1ZTsKICAgICAgY29uZmlnLl9hW0hPVVJdID0gMDsKICAgIH0KCiAgICBjb25maWcuX2QgPSAoY29uZmlnLl91c2VVVEMgPyBjcmVhdGVVVENEYXRlIDogY3JlYXRlRGF0ZSkuYXBwbHkobnVsbCwgaW5wdXQpOwogICAgZXhwZWN0ZWRXZWVrZGF5ID0gY29uZmlnLl91c2VVVEMgPyBjb25maWcuX2QuZ2V0VVRDRGF5KCkgOiBjb25maWcuX2QuZ2V0RGF5KCk7IC8vIEFwcGx5IHRpbWV6b25lIG9mZnNldCBmcm9tIGlucHV0LiBUaGUgYWN0dWFsIHV0Y09mZnNldCBjYW4gYmUgY2hhbmdlZAogICAgLy8gd2l0aCBwYXJzZVpvbmUuCgogICAgaWYgKGNvbmZpZy5fdHptICE9IG51bGwpIHsKICAgICAgY29uZmlnLl9kLnNldFVUQ01pbnV0ZXMoY29uZmlnLl9kLmdldFVUQ01pbnV0ZXMoKSAtIGNvbmZpZy5fdHptKTsKICAgIH0KCiAgICBpZiAoY29uZmlnLl9uZXh0RGF5KSB7CiAgICAgIGNvbmZpZy5fYVtIT1VSXSA9IDI0OwogICAgfSAvLyBjaGVjayBmb3IgbWlzbWF0Y2hpbmcgZGF5IG9mIHdlZWsKCgogICAgaWYgKGNvbmZpZy5fdyAmJiB0eXBlb2YgY29uZmlnLl93LmQgIT09ICd1bmRlZmluZWQnICYmIGNvbmZpZy5fdy5kICE9PSBleHBlY3RlZFdlZWtkYXkpIHsKICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykud2Vla2RheU1pc21hdGNoID0gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGRheU9mWWVhckZyb21XZWVrSW5mbyhjb25maWcpIHsKICAgIHZhciB3LCB3ZWVrWWVhciwgd2Vlaywgd2Vla2RheSwgZG93LCBkb3ksIHRlbXAsIHdlZWtkYXlPdmVyZmxvdywgY3VyV2VlazsKICAgIHcgPSBjb25maWcuX3c7CgogICAgaWYgKHcuR0cgIT0gbnVsbCB8fCB3LlcgIT0gbnVsbCB8fCB3LkUgIT0gbnVsbCkgewogICAgICBkb3cgPSAxOwogICAgICBkb3kgPSA0OyAvLyBUT0RPOiBXZSBuZWVkIHRvIHRha2UgdGhlIGN1cnJlbnQgaXNvV2Vla1llYXIsIGJ1dCB0aGF0IGRlcGVuZHMgb24KICAgICAgLy8gaG93IHdlIGludGVycHJldCBub3cgKGxvY2FsLCB1dGMsIGZpeGVkIG9mZnNldCkuIFNvIGNyZWF0ZQogICAgICAvLyBhIG5vdyB2ZXJzaW9uIG9mIGN1cnJlbnQgY29uZmlnICh0YWtlIGxvY2FsL3V0Yy9vZmZzZXQgZmxhZ3MsIGFuZAogICAgICAvLyBjcmVhdGUgbm93KS4KCiAgICAgIHdlZWtZZWFyID0gZGVmYXVsdHMody5HRywgY29uZmlnLl9hW1lFQVJdLCB3ZWVrT2ZZZWFyKGNyZWF0ZUxvY2FsKCksIDEsIDQpLnllYXIpOwogICAgICB3ZWVrID0gZGVmYXVsdHMody5XLCAxKTsKICAgICAgd2Vla2RheSA9IGRlZmF1bHRzKHcuRSwgMSk7CgogICAgICBpZiAod2Vla2RheSA8IDEgfHwgd2Vla2RheSA+IDcpIHsKICAgICAgICB3ZWVrZGF5T3ZlcmZsb3cgPSB0cnVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBkb3cgPSBjb25maWcuX2xvY2FsZS5fd2Vlay5kb3c7CiAgICAgIGRveSA9IGNvbmZpZy5fbG9jYWxlLl93ZWVrLmRveTsKICAgICAgY3VyV2VlayA9IHdlZWtPZlllYXIoY3JlYXRlTG9jYWwoKSwgZG93LCBkb3kpOwogICAgICB3ZWVrWWVhciA9IGRlZmF1bHRzKHcuZ2csIGNvbmZpZy5fYVtZRUFSXSwgY3VyV2Vlay55ZWFyKTsgLy8gRGVmYXVsdCB0byBjdXJyZW50IHdlZWsuCgogICAgICB3ZWVrID0gZGVmYXVsdHMody53LCBjdXJXZWVrLndlZWspOwoKICAgICAgaWYgKHcuZCAhPSBudWxsKSB7CiAgICAgICAgLy8gd2Vla2RheSAtLSBsb3cgZGF5IG51bWJlcnMgYXJlIGNvbnNpZGVyZWQgbmV4dCB3ZWVrCiAgICAgICAgd2Vla2RheSA9IHcuZDsKCiAgICAgICAgaWYgKHdlZWtkYXkgPCAwIHx8IHdlZWtkYXkgPiA2KSB7CiAgICAgICAgICB3ZWVrZGF5T3ZlcmZsb3cgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh3LmUgIT0gbnVsbCkgewogICAgICAgIC8vIGxvY2FsIHdlZWtkYXkgLS0gY291bnRpbmcgc3RhcnRzIGZyb20gYmVnaW5uaW5nIG9mIHdlZWsKICAgICAgICB3ZWVrZGF5ID0gdy5lICsgZG93OwoKICAgICAgICBpZiAody5lIDwgMCB8fCB3LmUgPiA2KSB7CiAgICAgICAgICB3ZWVrZGF5T3ZlcmZsb3cgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkZWZhdWx0IHRvIGJlZ2lubmluZyBvZiB3ZWVrCiAgICAgICAgd2Vla2RheSA9IGRvdzsKICAgICAgfQogICAgfQoKICAgIGlmICh3ZWVrIDwgMSB8fCB3ZWVrID4gd2Vla3NJblllYXIod2Vla1llYXIsIGRvdywgZG95KSkgewogICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5fb3ZlcmZsb3dXZWVrcyA9IHRydWU7CiAgICB9IGVsc2UgaWYgKHdlZWtkYXlPdmVyZmxvdyAhPSBudWxsKSB7CiAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLl9vdmVyZmxvd1dlZWtkYXkgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgdGVtcCA9IGRheU9mWWVhckZyb21XZWVrcyh3ZWVrWWVhciwgd2Vlaywgd2Vla2RheSwgZG93LCBkb3kpOwogICAgICBjb25maWcuX2FbWUVBUl0gPSB0ZW1wLnllYXI7CiAgICAgIGNvbmZpZy5fZGF5T2ZZZWFyID0gdGVtcC5kYXlPZlllYXI7CiAgICB9CiAgfSAvLyBjb25zdGFudCB0aGF0IHJlZmVycyB0byB0aGUgSVNPIHN0YW5kYXJkCgoKICBob29rcy5JU09fODYwMSA9IGZ1bmN0aW9uICgpIHt9OyAvLyBjb25zdGFudCB0aGF0IHJlZmVycyB0byB0aGUgUkZDIDI4MjIgZm9ybQoKCiAgaG9va3MuUkZDXzI4MjIgPSBmdW5jdGlvbiAoKSB7fTsgLy8gZGF0ZSBmcm9tIHN0cmluZyBhbmQgZm9ybWF0IHN0cmluZwoKCiAgZnVuY3Rpb24gY29uZmlnRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpIHsKICAgIC8vIFRPRE86IE1vdmUgdGhpcyB0byBhbm90aGVyIHBhcnQgb2YgdGhlIGNyZWF0aW9uIGZsb3cgdG8gcHJldmVudCBjaXJjdWxhciBkZXBzCiAgICBpZiAoY29uZmlnLl9mID09PSBob29rcy5JU09fODYwMSkgewogICAgICBjb25maWdGcm9tSVNPKGNvbmZpZyk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoY29uZmlnLl9mID09PSBob29rcy5SRkNfMjgyMikgewogICAgICBjb25maWdGcm9tUkZDMjgyMihjb25maWcpOwogICAgICByZXR1cm47CiAgICB9CgogICAgY29uZmlnLl9hID0gW107CiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5lbXB0eSA9IHRydWU7IC8vIFRoaXMgYXJyYXkgaXMgdXNlZCB0byBtYWtlIGEgRGF0ZSwgZWl0aGVyIHdpdGggYG5ldyBEYXRlYCBvciBgRGF0ZS5VVENgCgogICAgdmFyIHN0cmluZyA9ICcnICsgY29uZmlnLl9pLAogICAgICAgIGksCiAgICAgICAgcGFyc2VkSW5wdXQsCiAgICAgICAgdG9rZW5zLAogICAgICAgIHRva2VuLAogICAgICAgIHNraXBwZWQsCiAgICAgICAgc3RyaW5nTGVuZ3RoID0gc3RyaW5nLmxlbmd0aCwKICAgICAgICB0b3RhbFBhcnNlZElucHV0TGVuZ3RoID0gMCwKICAgICAgICBlcmE7CiAgICB0b2tlbnMgPSBleHBhbmRGb3JtYXQoY29uZmlnLl9mLCBjb25maWcuX2xvY2FsZSkubWF0Y2goZm9ybWF0dGluZ1Rva2VucykgfHwgW107CgogICAgZm9yIChpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykgewogICAgICB0b2tlbiA9IHRva2Vuc1tpXTsKICAgICAgcGFyc2VkSW5wdXQgPSAoc3RyaW5nLm1hdGNoKGdldFBhcnNlUmVnZXhGb3JUb2tlbih0b2tlbiwgY29uZmlnKSkgfHwgW10pWzBdOwoKICAgICAgaWYgKHBhcnNlZElucHV0KSB7CiAgICAgICAgc2tpcHBlZCA9IHN0cmluZy5zdWJzdHIoMCwgc3RyaW5nLmluZGV4T2YocGFyc2VkSW5wdXQpKTsKCiAgICAgICAgaWYgKHNraXBwZWQubGVuZ3RoID4gMCkgewogICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykudW51c2VkSW5wdXQucHVzaChza2lwcGVkKTsKICAgICAgICB9CgogICAgICAgIHN0cmluZyA9IHN0cmluZy5zbGljZShzdHJpbmcuaW5kZXhPZihwYXJzZWRJbnB1dCkgKyBwYXJzZWRJbnB1dC5sZW5ndGgpOwogICAgICAgIHRvdGFsUGFyc2VkSW5wdXRMZW5ndGggKz0gcGFyc2VkSW5wdXQubGVuZ3RoOwogICAgICB9IC8vIGRvbid0IHBhcnNlIGlmIGl0J3Mgbm90IGEga25vd24gdG9rZW4KCgogICAgICBpZiAoZm9ybWF0VG9rZW5GdW5jdGlvbnNbdG9rZW5dKSB7CiAgICAgICAgaWYgKHBhcnNlZElucHV0KSB7CiAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5lbXB0eSA9IGZhbHNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS51bnVzZWRUb2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgfQoKICAgICAgICBhZGRUaW1lVG9BcnJheUZyb21Ub2tlbih0b2tlbiwgcGFyc2VkSW5wdXQsIGNvbmZpZyk7CiAgICAgIH0gZWxzZSBpZiAoY29uZmlnLl9zdHJpY3QgJiYgIXBhcnNlZElucHV0KSB7CiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykudW51c2VkVG9rZW5zLnB1c2godG9rZW4pOwogICAgICB9CiAgICB9IC8vIGFkZCByZW1haW5pbmcgdW5wYXJzZWQgaW5wdXQgbGVuZ3RoIHRvIHRoZSBzdHJpbmcKCgogICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuY2hhcnNMZWZ0T3ZlciA9IHN0cmluZ0xlbmd0aCAtIHRvdGFsUGFyc2VkSW5wdXRMZW5ndGg7CgogICAgaWYgKHN0cmluZy5sZW5ndGggPiAwKSB7CiAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLnVudXNlZElucHV0LnB1c2goc3RyaW5nKTsKICAgIH0gLy8gY2xlYXIgXzEyaCBmbGFnIGlmIGhvdXIgaXMgPD0gMTIKCgogICAgaWYgKGNvbmZpZy5fYVtIT1VSXSA8PSAxMiAmJiBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5iaWdIb3VyID09PSB0cnVlICYmIGNvbmZpZy5fYVtIT1VSXSA+IDApIHsKICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuYmlnSG91ciA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5wYXJzZWREYXRlUGFydHMgPSBjb25maWcuX2Euc2xpY2UoMCk7CiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5tZXJpZGllbSA9IGNvbmZpZy5fbWVyaWRpZW07IC8vIGhhbmRsZSBtZXJpZGllbQoKICAgIGNvbmZpZy5fYVtIT1VSXSA9IG1lcmlkaWVtRml4V3JhcChjb25maWcuX2xvY2FsZSwgY29uZmlnLl9hW0hPVVJdLCBjb25maWcuX21lcmlkaWVtKTsgLy8gaGFuZGxlIGVyYQoKICAgIGVyYSA9IGdldFBhcnNpbmdGbGFncyhjb25maWcpLmVyYTsKCiAgICBpZiAoZXJhICE9PSBudWxsKSB7CiAgICAgIGNvbmZpZy5fYVtZRUFSXSA9IGNvbmZpZy5fbG9jYWxlLmVyYXNDb252ZXJ0WWVhcihlcmEsIGNvbmZpZy5fYVtZRUFSXSk7CiAgICB9CgogICAgY29uZmlnRnJvbUFycmF5KGNvbmZpZyk7CiAgICBjaGVja092ZXJmbG93KGNvbmZpZyk7CiAgfQoKICBmdW5jdGlvbiBtZXJpZGllbUZpeFdyYXAobG9jYWxlLCBob3VyLCBtZXJpZGllbSkgewogICAgdmFyIGlzUG07CgogICAgaWYgKG1lcmlkaWVtID09IG51bGwpIHsKICAgICAgLy8gbm90aGluZyB0byBkbwogICAgICByZXR1cm4gaG91cjsKICAgIH0KCiAgICBpZiAobG9jYWxlLm1lcmlkaWVtSG91ciAhPSBudWxsKSB7CiAgICAgIHJldHVybiBsb2NhbGUubWVyaWRpZW1Ib3VyKGhvdXIsIG1lcmlkaWVtKTsKICAgIH0gZWxzZSBpZiAobG9jYWxlLmlzUE0gIT0gbnVsbCkgewogICAgICAvLyBGYWxsYmFjawogICAgICBpc1BtID0gbG9jYWxlLmlzUE0obWVyaWRpZW0pOwoKICAgICAgaWYgKGlzUG0gJiYgaG91ciA8IDEyKSB7CiAgICAgICAgaG91ciArPSAxMjsKICAgICAgfQoKICAgICAgaWYgKCFpc1BtICYmIGhvdXIgPT09IDEyKSB7CiAgICAgICAgaG91ciA9IDA7CiAgICAgIH0KCiAgICAgIHJldHVybiBob3VyOwogICAgfSBlbHNlIHsKICAgICAgLy8gdGhpcyBpcyBub3Qgc3VwcG9zZWQgdG8gaGFwcGVuCiAgICAgIHJldHVybiBob3VyOwogICAgfQogIH0gLy8gZGF0ZSBmcm9tIHN0cmluZyBhbmQgYXJyYXkgb2YgZm9ybWF0IHN0cmluZ3MKCgogIGZ1bmN0aW9uIGNvbmZpZ0Zyb21TdHJpbmdBbmRBcnJheShjb25maWcpIHsKICAgIHZhciB0ZW1wQ29uZmlnLAogICAgICAgIGJlc3RNb21lbnQsCiAgICAgICAgc2NvcmVUb0JlYXQsCiAgICAgICAgaSwKICAgICAgICBjdXJyZW50U2NvcmUsCiAgICAgICAgdmFsaWRGb3JtYXRGb3VuZCwKICAgICAgICBiZXN0Rm9ybWF0SXNWYWxpZCA9IGZhbHNlOwoKICAgIGlmIChjb25maWcuX2YubGVuZ3RoID09PSAwKSB7CiAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLmludmFsaWRGb3JtYXQgPSB0cnVlOwogICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShOYU4pOwogICAgICByZXR1cm47CiAgICB9CgogICAgZm9yIChpID0gMDsgaSA8IGNvbmZpZy5fZi5sZW5ndGg7IGkrKykgewogICAgICBjdXJyZW50U2NvcmUgPSAwOwogICAgICB2YWxpZEZvcm1hdEZvdW5kID0gZmFsc2U7CiAgICAgIHRlbXBDb25maWcgPSBjb3B5Q29uZmlnKHt9LCBjb25maWcpOwoKICAgICAgaWYgKGNvbmZpZy5fdXNlVVRDICE9IG51bGwpIHsKICAgICAgICB0ZW1wQ29uZmlnLl91c2VVVEMgPSBjb25maWcuX3VzZVVUQzsKICAgICAgfQoKICAgICAgdGVtcENvbmZpZy5fZiA9IGNvbmZpZy5fZltpXTsKICAgICAgY29uZmlnRnJvbVN0cmluZ0FuZEZvcm1hdCh0ZW1wQ29uZmlnKTsKCiAgICAgIGlmIChpc1ZhbGlkKHRlbXBDb25maWcpKSB7CiAgICAgICAgdmFsaWRGb3JtYXRGb3VuZCA9IHRydWU7CiAgICAgIH0gLy8gaWYgdGhlcmUgaXMgYW55IGlucHV0IHRoYXQgd2FzIG5vdCBwYXJzZWQgYWRkIGEgcGVuYWx0eSBmb3IgdGhhdCBmb3JtYXQKCgogICAgICBjdXJyZW50U2NvcmUgKz0gZ2V0UGFyc2luZ0ZsYWdzKHRlbXBDb25maWcpLmNoYXJzTGVmdE92ZXI7IC8vb3IgdG9rZW5zCgogICAgICBjdXJyZW50U2NvcmUgKz0gZ2V0UGFyc2luZ0ZsYWdzKHRlbXBDb25maWcpLnVudXNlZFRva2Vucy5sZW5ndGggKiAxMDsKICAgICAgZ2V0UGFyc2luZ0ZsYWdzKHRlbXBDb25maWcpLnNjb3JlID0gY3VycmVudFNjb3JlOwoKICAgICAgaWYgKCFiZXN0Rm9ybWF0SXNWYWxpZCkgewogICAgICAgIGlmIChzY29yZVRvQmVhdCA9PSBudWxsIHx8IGN1cnJlbnRTY29yZSA8IHNjb3JlVG9CZWF0IHx8IHZhbGlkRm9ybWF0Rm91bmQpIHsKICAgICAgICAgIHNjb3JlVG9CZWF0ID0gY3VycmVudFNjb3JlOwogICAgICAgICAgYmVzdE1vbWVudCA9IHRlbXBDb25maWc7CgogICAgICAgICAgaWYgKHZhbGlkRm9ybWF0Rm91bmQpIHsKICAgICAgICAgICAgYmVzdEZvcm1hdElzVmFsaWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoY3VycmVudFNjb3JlIDwgc2NvcmVUb0JlYXQpIHsKICAgICAgICAgIHNjb3JlVG9CZWF0ID0gY3VycmVudFNjb3JlOwogICAgICAgICAgYmVzdE1vbWVudCA9IHRlbXBDb25maWc7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZXh0ZW5kKGNvbmZpZywgYmVzdE1vbWVudCB8fCB0ZW1wQ29uZmlnKTsKICB9CgogIGZ1bmN0aW9uIGNvbmZpZ0Zyb21PYmplY3QoY29uZmlnKSB7CiAgICBpZiAoY29uZmlnLl9kKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgaSA9IG5vcm1hbGl6ZU9iamVjdFVuaXRzKGNvbmZpZy5faSksCiAgICAgICAgZGF5T3JEYXRlID0gaS5kYXkgPT09IHVuZGVmaW5lZCA/IGkuZGF0ZSA6IGkuZGF5OwogICAgY29uZmlnLl9hID0gbWFwKFtpLnllYXIsIGkubW9udGgsIGRheU9yRGF0ZSwgaS5ob3VyLCBpLm1pbnV0ZSwgaS5zZWNvbmQsIGkubWlsbGlzZWNvbmRdLCBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiBvYmogJiYgcGFyc2VJbnQob2JqLCAxMCk7CiAgICB9KTsKICAgIGNvbmZpZ0Zyb21BcnJheShjb25maWcpOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRnJvbUNvbmZpZyhjb25maWcpIHsKICAgIHZhciByZXMgPSBuZXcgTW9tZW50KGNoZWNrT3ZlcmZsb3cocHJlcGFyZUNvbmZpZyhjb25maWcpKSk7CgogICAgaWYgKHJlcy5fbmV4dERheSkgewogICAgICAvLyBBZGRpbmcgaXMgc21hcnQgZW5vdWdoIGFyb3VuZCBEU1QKICAgICAgcmVzLmFkZCgxLCAnZCcpOwogICAgICByZXMuX25leHREYXkgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9CgogIGZ1bmN0aW9uIHByZXBhcmVDb25maWcoY29uZmlnKSB7CiAgICB2YXIgaW5wdXQgPSBjb25maWcuX2ksCiAgICAgICAgZm9ybWF0ID0gY29uZmlnLl9mOwogICAgY29uZmlnLl9sb2NhbGUgPSBjb25maWcuX2xvY2FsZSB8fCBnZXRMb2NhbGUoY29uZmlnLl9sKTsKCiAgICBpZiAoaW5wdXQgPT09IG51bGwgfHwgZm9ybWF0ID09PSB1bmRlZmluZWQgJiYgaW5wdXQgPT09ICcnKSB7CiAgICAgIHJldHVybiBjcmVhdGVJbnZhbGlkKHsKICAgICAgICBudWxsSW5wdXQ6IHRydWUKICAgICAgfSk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgY29uZmlnLl9pID0gaW5wdXQgPSBjb25maWcuX2xvY2FsZS5wcmVwYXJzZShpbnB1dCk7CiAgICB9CgogICAgaWYgKGlzTW9tZW50KGlucHV0KSkgewogICAgICByZXR1cm4gbmV3IE1vbWVudChjaGVja092ZXJmbG93KGlucHV0KSk7CiAgICB9IGVsc2UgaWYgKGlzRGF0ZShpbnB1dCkpIHsKICAgICAgY29uZmlnLl9kID0gaW5wdXQ7CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZm9ybWF0KSkgewogICAgICBjb25maWdGcm9tU3RyaW5nQW5kQXJyYXkoY29uZmlnKTsKICAgIH0gZWxzZSBpZiAoZm9ybWF0KSB7CiAgICAgIGNvbmZpZ0Zyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbmZpZ0Zyb21JbnB1dChjb25maWcpOwogICAgfQoKICAgIGlmICghaXNWYWxpZChjb25maWcpKSB7CiAgICAgIGNvbmZpZy5fZCA9IG51bGw7CiAgICB9CgogICAgcmV0dXJuIGNvbmZpZzsKICB9CgogIGZ1bmN0aW9uIGNvbmZpZ0Zyb21JbnB1dChjb25maWcpIHsKICAgIHZhciBpbnB1dCA9IGNvbmZpZy5faTsKCiAgICBpZiAoaXNVbmRlZmluZWQoaW5wdXQpKSB7CiAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKGhvb2tzLm5vdygpKTsKICAgIH0gZWxzZSBpZiAoaXNEYXRlKGlucHV0KSkgewogICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShpbnB1dC52YWx1ZU9mKCkpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNvbmZpZ0Zyb21TdHJpbmcoY29uZmlnKTsKICAgIH0gZWxzZSBpZiAoaXNBcnJheShpbnB1dCkpIHsKICAgICAgY29uZmlnLl9hID0gbWFwKGlucHV0LnNsaWNlKDApLCBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlSW50KG9iaiwgMTApOwogICAgICB9KTsKICAgICAgY29uZmlnRnJvbUFycmF5KGNvbmZpZyk7CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGlucHV0KSkgewogICAgICBjb25maWdGcm9tT2JqZWN0KGNvbmZpZyk7CiAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKGlucHV0KSkgewogICAgICAvLyBmcm9tIG1pbGxpc2Vjb25kcwogICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShpbnB1dCk7CiAgICB9IGVsc2UgewogICAgICBob29rcy5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayhjb25maWcpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlTG9jYWxPclVUQyhpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCwgaXNVVEMpIHsKICAgIHZhciBjID0ge307CgogICAgaWYgKGZvcm1hdCA9PT0gdHJ1ZSB8fCBmb3JtYXQgPT09IGZhbHNlKSB7CiAgICAgIHN0cmljdCA9IGZvcm1hdDsKICAgICAgZm9ybWF0ID0gdW5kZWZpbmVkOwogICAgfQoKICAgIGlmIChsb2NhbGUgPT09IHRydWUgfHwgbG9jYWxlID09PSBmYWxzZSkgewogICAgICBzdHJpY3QgPSBsb2NhbGU7CiAgICAgIGxvY2FsZSA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICBpZiAoaXNPYmplY3QoaW5wdXQpICYmIGlzT2JqZWN0RW1wdHkoaW5wdXQpIHx8IGlzQXJyYXkoaW5wdXQpICYmIGlucHV0Lmxlbmd0aCA9PT0gMCkgewogICAgICBpbnB1dCA9IHVuZGVmaW5lZDsKICAgIH0gLy8gb2JqZWN0IGNvbnN0cnVjdGlvbiBtdXN0IGJlIGRvbmUgdGhpcyB3YXkuCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMTQyMwoKCiAgICBjLl9pc0FNb21lbnRPYmplY3QgPSB0cnVlOwogICAgYy5fdXNlVVRDID0gYy5faXNVVEMgPSBpc1VUQzsKICAgIGMuX2wgPSBsb2NhbGU7CiAgICBjLl9pID0gaW5wdXQ7CiAgICBjLl9mID0gZm9ybWF0OwogICAgYy5fc3RyaWN0ID0gc3RyaWN0OwogICAgcmV0dXJuIGNyZWF0ZUZyb21Db25maWcoYyk7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVMb2NhbChpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCkgewogICAgcmV0dXJuIGNyZWF0ZUxvY2FsT3JVVEMoaW5wdXQsIGZvcm1hdCwgbG9jYWxlLCBzdHJpY3QsIGZhbHNlKTsKICB9CgogIHZhciBwcm90b3R5cGVNaW4gPSBkZXByZWNhdGUoJ21vbWVudCgpLm1pbiBpcyBkZXByZWNhdGVkLCB1c2UgbW9tZW50Lm1heCBpbnN0ZWFkLiBodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL21pbi1tYXgvJywgZnVuY3Rpb24gKCkgewogICAgdmFyIG90aGVyID0gY3JlYXRlTG9jYWwuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKCiAgICBpZiAodGhpcy5pc1ZhbGlkKCkgJiYgb3RoZXIuaXNWYWxpZCgpKSB7CiAgICAgIHJldHVybiBvdGhlciA8IHRoaXMgPyB0aGlzIDogb3RoZXI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gY3JlYXRlSW52YWxpZCgpOwogICAgfQogIH0pLAogICAgICBwcm90b3R5cGVNYXggPSBkZXByZWNhdGUoJ21vbWVudCgpLm1heCBpcyBkZXByZWNhdGVkLCB1c2UgbW9tZW50Lm1pbiBpbnN0ZWFkLiBodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL21pbi1tYXgvJywgZnVuY3Rpb24gKCkgewogICAgdmFyIG90aGVyID0gY3JlYXRlTG9jYWwuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKCiAgICBpZiAodGhpcy5pc1ZhbGlkKCkgJiYgb3RoZXIuaXNWYWxpZCgpKSB7CiAgICAgIHJldHVybiBvdGhlciA+IHRoaXMgPyB0aGlzIDogb3RoZXI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gY3JlYXRlSW52YWxpZCgpOwogICAgfQogIH0pOyAvLyBQaWNrIGEgbW9tZW50IG0gZnJvbSBtb21lbnRzIHNvIHRoYXQgbVtmbl0ob3RoZXIpIGlzIHRydWUgZm9yIGFsbAogIC8vIG90aGVyLiBUaGlzIHJlbGllcyBvbiB0aGUgZnVuY3Rpb24gZm4gdG8gYmUgdHJhbnNpdGl2ZS4KICAvLwogIC8vIG1vbWVudHMgc2hvdWxkIGVpdGhlciBiZSBhbiBhcnJheSBvZiBtb21lbnQgb2JqZWN0cyBvciBhbiBhcnJheSwgd2hvc2UKICAvLyBmaXJzdCBlbGVtZW50IGlzIGFuIGFycmF5IG9mIG1vbWVudCBvYmplY3RzLgoKICBmdW5jdGlvbiBwaWNrQnkoZm4sIG1vbWVudHMpIHsKICAgIHZhciByZXMsIGk7CgogICAgaWYgKG1vbWVudHMubGVuZ3RoID09PSAxICYmIGlzQXJyYXkobW9tZW50c1swXSkpIHsKICAgICAgbW9tZW50cyA9IG1vbWVudHNbMF07CiAgICB9CgogICAgaWYgKCFtb21lbnRzLmxlbmd0aCkgewogICAgICByZXR1cm4gY3JlYXRlTG9jYWwoKTsKICAgIH0KCiAgICByZXMgPSBtb21lbnRzWzBdOwoKICAgIGZvciAoaSA9IDE7IGkgPCBtb21lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmICghbW9tZW50c1tpXS5pc1ZhbGlkKCkgfHwgbW9tZW50c1tpXVtmbl0ocmVzKSkgewogICAgICAgIHJlcyA9IG1vbWVudHNbaV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzOwogIH0gLy8gVE9ETzogVXNlIFtdLnNvcnQgaW5zdGVhZD8KCgogIGZ1bmN0aW9uIG1pbigpIHsKICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgcmV0dXJuIHBpY2tCeSgnaXNCZWZvcmUnLCBhcmdzKTsKICB9CgogIGZ1bmN0aW9uIG1heCgpIHsKICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgcmV0dXJuIHBpY2tCeSgnaXNBZnRlcicsIGFyZ3MpOwogIH0KCiAgdmFyIG5vdyA9IGZ1bmN0aW9uIG5vdygpIHsKICAgIHJldHVybiBEYXRlLm5vdyA/IERhdGUubm93KCkgOiArbmV3IERhdGUoKTsKICB9OwoKICB2YXIgb3JkZXJpbmcgPSBbJ3llYXInLCAncXVhcnRlcicsICdtb250aCcsICd3ZWVrJywgJ2RheScsICdob3VyJywgJ21pbnV0ZScsICdzZWNvbmQnLCAnbWlsbGlzZWNvbmQnXTsKCiAgZnVuY3Rpb24gaXNEdXJhdGlvblZhbGlkKG0pIHsKICAgIHZhciBrZXksCiAgICAgICAgdW5pdEhhc0RlY2ltYWwgPSBmYWxzZSwKICAgICAgICBpOwoKICAgIGZvciAoa2V5IGluIG0pIHsKICAgICAgaWYgKGhhc093blByb3AobSwga2V5KSAmJiAhKGluZGV4T2YuY2FsbChvcmRlcmluZywga2V5KSAhPT0gLTEgJiYgKG1ba2V5XSA9PSBudWxsIHx8ICFpc05hTihtW2tleV0pKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGkgPSAwOyBpIDwgb3JkZXJpbmcubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKG1bb3JkZXJpbmdbaV1dKSB7CiAgICAgICAgaWYgKHVuaXRIYXNEZWNpbWFsKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIG9ubHkgYWxsb3cgbm9uLWludGVnZXJzIGZvciBzbWFsbGVzdCB1bml0CiAgICAgICAgfQoKICAgICAgICBpZiAocGFyc2VGbG9hdChtW29yZGVyaW5nW2ldXSkgIT09IHRvSW50KG1bb3JkZXJpbmdbaV1dKSkgewogICAgICAgICAgdW5pdEhhc0RlY2ltYWwgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gaXNWYWxpZCQxKCkgewogICAgcmV0dXJuIHRoaXMuX2lzVmFsaWQ7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVJbnZhbGlkJDEoKSB7CiAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24oTmFOKTsKICB9CgogIGZ1bmN0aW9uIER1cmF0aW9uKGR1cmF0aW9uKSB7CiAgICB2YXIgbm9ybWFsaXplZElucHV0ID0gbm9ybWFsaXplT2JqZWN0VW5pdHMoZHVyYXRpb24pLAogICAgICAgIHllYXJzID0gbm9ybWFsaXplZElucHV0LnllYXIgfHwgMCwKICAgICAgICBxdWFydGVycyA9IG5vcm1hbGl6ZWRJbnB1dC5xdWFydGVyIHx8IDAsCiAgICAgICAgbW9udGhzID0gbm9ybWFsaXplZElucHV0Lm1vbnRoIHx8IDAsCiAgICAgICAgd2Vla3MgPSBub3JtYWxpemVkSW5wdXQud2VlayB8fCBub3JtYWxpemVkSW5wdXQuaXNvV2VlayB8fCAwLAogICAgICAgIGRheXMgPSBub3JtYWxpemVkSW5wdXQuZGF5IHx8IDAsCiAgICAgICAgaG91cnMgPSBub3JtYWxpemVkSW5wdXQuaG91ciB8fCAwLAogICAgICAgIG1pbnV0ZXMgPSBub3JtYWxpemVkSW5wdXQubWludXRlIHx8IDAsCiAgICAgICAgc2Vjb25kcyA9IG5vcm1hbGl6ZWRJbnB1dC5zZWNvbmQgfHwgMCwKICAgICAgICBtaWxsaXNlY29uZHMgPSBub3JtYWxpemVkSW5wdXQubWlsbGlzZWNvbmQgfHwgMDsKICAgIHRoaXMuX2lzVmFsaWQgPSBpc0R1cmF0aW9uVmFsaWQobm9ybWFsaXplZElucHV0KTsgLy8gcmVwcmVzZW50YXRpb24gZm9yIGRhdGVBZGRSZW1vdmUKCiAgICB0aGlzLl9taWxsaXNlY29uZHMgPSArbWlsbGlzZWNvbmRzICsgc2Vjb25kcyAqIDFlMyArIC8vIDEwMDAKICAgIG1pbnV0ZXMgKiA2ZTQgKyAvLyAxMDAwICogNjAKICAgIGhvdXJzICogMTAwMCAqIDYwICogNjA7IC8vdXNpbmcgMTAwMCAqIDYwICogNjAgaW5zdGVhZCBvZiAzNmU1IHRvIGF2b2lkIGZsb2F0aW5nIHBvaW50IHJvdW5kaW5nIGVycm9ycyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMjk3OAogICAgLy8gQmVjYXVzZSBvZiBkYXRlQWRkUmVtb3ZlIHRyZWF0cyAyNCBob3VycyBhcyBkaWZmZXJlbnQgZnJvbSBhCiAgICAvLyBkYXkgd2hlbiB3b3JraW5nIGFyb3VuZCBEU1QsIHdlIG5lZWQgdG8gc3RvcmUgdGhlbSBzZXBhcmF0ZWx5CgogICAgdGhpcy5fZGF5cyA9ICtkYXlzICsgd2Vla3MgKiA3OyAvLyBJdCBpcyBpbXBvc3NpYmxlIHRvIHRyYW5zbGF0ZSBtb250aHMgaW50byBkYXlzIHdpdGhvdXQga25vd2luZwogICAgLy8gd2hpY2ggbW9udGhzIHlvdSBhcmUgYXJlIHRhbGtpbmcgYWJvdXQsIHNvIHdlIGhhdmUgdG8gc3RvcmUKICAgIC8vIGl0IHNlcGFyYXRlbHkuCgogICAgdGhpcy5fbW9udGhzID0gK21vbnRocyArIHF1YXJ0ZXJzICogMyArIHllYXJzICogMTI7CiAgICB0aGlzLl9kYXRhID0ge307CiAgICB0aGlzLl9sb2NhbGUgPSBnZXRMb2NhbGUoKTsKCiAgICB0aGlzLl9idWJibGUoKTsKICB9CgogIGZ1bmN0aW9uIGlzRHVyYXRpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgRHVyYXRpb247CiAgfQoKICBmdW5jdGlvbiBhYnNSb3VuZChudW1iZXIpIHsKICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKC0xICogbnVtYmVyKSAqIC0xOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIE1hdGgucm91bmQobnVtYmVyKTsKICAgIH0KICB9IC8vIGNvbXBhcmUgdHdvIGFycmF5cywgcmV0dXJuIHRoZSBudW1iZXIgb2YgZGlmZmVyZW5jZXMKCgogIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMoYXJyYXkxLCBhcnJheTIsIGRvbnRDb252ZXJ0KSB7CiAgICB2YXIgbGVuID0gTWF0aC5taW4oYXJyYXkxLmxlbmd0aCwgYXJyYXkyLmxlbmd0aCksCiAgICAgICAgbGVuZ3RoRGlmZiA9IE1hdGguYWJzKGFycmF5MS5sZW5ndGggLSBhcnJheTIubGVuZ3RoKSwKICAgICAgICBkaWZmcyA9IDAsCiAgICAgICAgaTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgaWYgKGRvbnRDb252ZXJ0ICYmIGFycmF5MVtpXSAhPT0gYXJyYXkyW2ldIHx8ICFkb250Q29udmVydCAmJiB0b0ludChhcnJheTFbaV0pICE9PSB0b0ludChhcnJheTJbaV0pKSB7CiAgICAgICAgZGlmZnMrKzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBkaWZmcyArIGxlbmd0aERpZmY7CiAgfSAvLyBGT1JNQVRUSU5HCgoKICBmdW5jdGlvbiBvZmZzZXQodG9rZW4sIHNlcGFyYXRvcikgewogICAgYWRkRm9ybWF0VG9rZW4odG9rZW4sIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG9mZnNldCA9IHRoaXMudXRjT2Zmc2V0KCksCiAgICAgICAgICBzaWduID0gJysnOwoKICAgICAgaWYgKG9mZnNldCA8IDApIHsKICAgICAgICBvZmZzZXQgPSAtb2Zmc2V0OwogICAgICAgIHNpZ24gPSAnLSc7CiAgICAgIH0KCiAgICAgIHJldHVybiBzaWduICsgemVyb0ZpbGwofn4ob2Zmc2V0IC8gNjApLCAyKSArIHNlcGFyYXRvciArIHplcm9GaWxsKH5+b2Zmc2V0ICUgNjAsIDIpOwogICAgfSk7CiAgfQoKICBvZmZzZXQoJ1onLCAnOicpOwogIG9mZnNldCgnWlonLCAnJyk7IC8vIFBBUlNJTkcKCiAgYWRkUmVnZXhUb2tlbignWicsIG1hdGNoU2hvcnRPZmZzZXQpOwogIGFkZFJlZ2V4VG9rZW4oJ1paJywgbWF0Y2hTaG9ydE9mZnNldCk7CiAgYWRkUGFyc2VUb2tlbihbJ1onLCAnWlonXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICBjb25maWcuX3VzZVVUQyA9IHRydWU7CiAgICBjb25maWcuX3R6bSA9IG9mZnNldEZyb21TdHJpbmcobWF0Y2hTaG9ydE9mZnNldCwgaW5wdXQpOwogIH0pOyAvLyBIRUxQRVJTCiAgLy8gdGltZXpvbmUgY2h1bmtlcgogIC8vICcrMTA6MDAnID4gWycxMCcsICAnMDAnXQogIC8vICctMTUzMCcgID4gWyctMTUnLCAnMzAnXQoKICB2YXIgY2h1bmtPZmZzZXQgPSAvKFtcK1wtXXxcZFxkKS9naTsKCiAgZnVuY3Rpb24gb2Zmc2V0RnJvbVN0cmluZyhtYXRjaGVyLCBzdHJpbmcpIHsKICAgIHZhciBtYXRjaGVzID0gKHN0cmluZyB8fCAnJykubWF0Y2gobWF0Y2hlciksCiAgICAgICAgY2h1bmssCiAgICAgICAgcGFydHMsCiAgICAgICAgbWludXRlczsKCiAgICBpZiAobWF0Y2hlcyA9PT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBjaHVuayA9IG1hdGNoZXNbbWF0Y2hlcy5sZW5ndGggLSAxXSB8fCBbXTsKICAgIHBhcnRzID0gKGNodW5rICsgJycpLm1hdGNoKGNodW5rT2Zmc2V0KSB8fCBbJy0nLCAwLCAwXTsKICAgIG1pbnV0ZXMgPSArKHBhcnRzWzFdICogNjApICsgdG9JbnQocGFydHNbMl0pOwogICAgcmV0dXJuIG1pbnV0ZXMgPT09IDAgPyAwIDogcGFydHNbMF0gPT09ICcrJyA/IG1pbnV0ZXMgOiAtbWludXRlczsKICB9IC8vIFJldHVybiBhIG1vbWVudCBmcm9tIGlucHV0LCB0aGF0IGlzIGxvY2FsL3V0Yy96b25lIGVxdWl2YWxlbnQgdG8gbW9kZWwuCgoKICBmdW5jdGlvbiBjbG9uZVdpdGhPZmZzZXQoaW5wdXQsIG1vZGVsKSB7CiAgICB2YXIgcmVzLCBkaWZmOwoKICAgIGlmIChtb2RlbC5faXNVVEMpIHsKICAgICAgcmVzID0gbW9kZWwuY2xvbmUoKTsKICAgICAgZGlmZiA9IChpc01vbWVudChpbnB1dCkgfHwgaXNEYXRlKGlucHV0KSA/IGlucHV0LnZhbHVlT2YoKSA6IGNyZWF0ZUxvY2FsKGlucHV0KS52YWx1ZU9mKCkpIC0gcmVzLnZhbHVlT2YoKTsgLy8gVXNlIGxvdy1sZXZlbCBhcGksIGJlY2F1c2UgdGhpcyBmbiBpcyBsb3ctbGV2ZWwgYXBpLgoKICAgICAgcmVzLl9kLnNldFRpbWUocmVzLl9kLnZhbHVlT2YoKSArIGRpZmYpOwoKICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHJlcywgZmFsc2UpOwogICAgICByZXR1cm4gcmVzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNyZWF0ZUxvY2FsKGlucHV0KS5sb2NhbCgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0RGF0ZU9mZnNldChtKSB7CiAgICAvLyBPbiBGaXJlZm94LjI0IERhdGUjZ2V0VGltZXpvbmVPZmZzZXQgcmV0dXJucyBhIGZsb2F0aW5nIHBvaW50LgogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvcHVsbC8xODcxCiAgICByZXR1cm4gLU1hdGgucm91bmQobS5fZC5nZXRUaW1lem9uZU9mZnNldCgpKTsKICB9IC8vIEhPT0tTCiAgLy8gVGhpcyBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBhIG1vbWVudCBpcyBtdXRhdGVkLgogIC8vIEl0IGlzIGludGVuZGVkIHRvIGtlZXAgdGhlIG9mZnNldCBpbiBzeW5jIHdpdGggdGhlIHRpbWV6b25lLgoKCiAgaG9va3MudXBkYXRlT2Zmc2V0ID0gZnVuY3Rpb24gKCkge307IC8vIE1PTUVOVFMKICAvLyBrZWVwTG9jYWxUaW1lID0gdHJ1ZSBtZWFucyBvbmx5IGNoYW5nZSB0aGUgdGltZXpvbmUsIHdpdGhvdXQKICAvLyBhZmZlY3RpbmcgdGhlIGxvY2FsIGhvdXIuIFNvIDU6MzE6MjYgKzAzMDAgLS1bdXRjT2Zmc2V0KDIsIHRydWUpXS0tPgogIC8vIDU6MzE6MjYgKzAyMDAgSXQgaXMgcG9zc2libGUgdGhhdCA1OjMxOjI2IGRvZXNuJ3QgZXhpc3Qgd2l0aCBvZmZzZXQKICAvLyArMDIwMCwgc28gd2UgYWRqdXN0IHRoZSB0aW1lIGFzIG5lZWRlZCwgdG8gYmUgdmFsaWQuCiAgLy8KICAvLyBLZWVwaW5nIHRoZSB0aW1lIGFjdHVhbGx5IGFkZHMvc3VidHJhY3RzIChvbmUgaG91cikKICAvLyBmcm9tIHRoZSBhY3R1YWwgcmVwcmVzZW50ZWQgdGltZS4gVGhhdCBpcyB3aHkgd2UgY2FsbCB1cGRhdGVPZmZzZXQKICAvLyBhIHNlY29uZCB0aW1lLiBJbiBjYXNlIGl0IHdhbnRzIHVzIHRvIGNoYW5nZSB0aGUgb2Zmc2V0IGFnYWluCiAgLy8gX2NoYW5nZUluUHJvZ3Jlc3MgPT0gdHJ1ZSBjYXNlLCB0aGVuIHdlIGhhdmUgdG8gYWRqdXN0LCBiZWNhdXNlCiAgLy8gdGhlcmUgaXMgbm8gc3VjaCB0aW1lIGluIHRoZSBnaXZlbiB0aW1lem9uZS4KCgogIGZ1bmN0aW9uIGdldFNldE9mZnNldChpbnB1dCwga2VlcExvY2FsVGltZSwga2VlcE1pbnV0ZXMpIHsKICAgIHZhciBvZmZzZXQgPSB0aGlzLl9vZmZzZXQgfHwgMCwKICAgICAgICBsb2NhbEFkanVzdDsKCiAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgIHJldHVybiBpbnB1dCAhPSBudWxsID8gdGhpcyA6IE5hTjsKICAgIH0KCiAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICAgIGlucHV0ID0gb2Zmc2V0RnJvbVN0cmluZyhtYXRjaFNob3J0T2Zmc2V0LCBpbnB1dCk7CgogICAgICAgIGlmIChpbnB1dCA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKE1hdGguYWJzKGlucHV0KSA8IDE2ICYmICFrZWVwTWludXRlcykgewogICAgICAgIGlucHV0ID0gaW5wdXQgKiA2MDsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLl9pc1VUQyAmJiBrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgbG9jYWxBZGp1c3QgPSBnZXREYXRlT2Zmc2V0KHRoaXMpOwogICAgICB9CgogICAgICB0aGlzLl9vZmZzZXQgPSBpbnB1dDsKICAgICAgdGhpcy5faXNVVEMgPSB0cnVlOwoKICAgICAgaWYgKGxvY2FsQWRqdXN0ICE9IG51bGwpIHsKICAgICAgICB0aGlzLmFkZChsb2NhbEFkanVzdCwgJ20nKTsKICAgICAgfQoKICAgICAgaWYgKG9mZnNldCAhPT0gaW5wdXQpIHsKICAgICAgICBpZiAoIWtlZXBMb2NhbFRpbWUgfHwgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcykgewogICAgICAgICAgYWRkU3VidHJhY3QodGhpcywgY3JlYXRlRHVyYXRpb24oaW5wdXQgLSBvZmZzZXQsICdtJyksIDEsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9jaGFuZ2VJblByb2dyZXNzKSB7CiAgICAgICAgICB0aGlzLl9jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKICAgICAgICAgIGhvb2tzLnVwZGF0ZU9mZnNldCh0aGlzLCB0cnVlKTsKICAgICAgICAgIHRoaXMuX2NoYW5nZUluUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5faXNVVEMgPyBvZmZzZXQgOiBnZXREYXRlT2Zmc2V0KHRoaXMpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0U2V0Wm9uZShpbnB1dCwga2VlcExvY2FsVGltZSkgewogICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHsKICAgICAgICBpbnB1dCA9IC1pbnB1dDsKICAgICAgfQoKICAgICAgdGhpcy51dGNPZmZzZXQoaW5wdXQsIGtlZXBMb2NhbFRpbWUpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtdGhpcy51dGNPZmZzZXQoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHNldE9mZnNldFRvVVRDKGtlZXBMb2NhbFRpbWUpIHsKICAgIHJldHVybiB0aGlzLnV0Y09mZnNldCgwLCBrZWVwTG9jYWxUaW1lKTsKICB9CgogIGZ1bmN0aW9uIHNldE9mZnNldFRvTG9jYWwoa2VlcExvY2FsVGltZSkgewogICAgaWYgKHRoaXMuX2lzVVRDKSB7CiAgICAgIHRoaXMudXRjT2Zmc2V0KDAsIGtlZXBMb2NhbFRpbWUpOwogICAgICB0aGlzLl9pc1VUQyA9IGZhbHNlOwoKICAgICAgaWYgKGtlZXBMb2NhbFRpbWUpIHsKICAgICAgICB0aGlzLnN1YnRyYWN0KGdldERhdGVPZmZzZXQodGhpcyksICdtJyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9CgogIGZ1bmN0aW9uIHNldE9mZnNldFRvUGFyc2VkT2Zmc2V0KCkgewogICAgaWYgKHRoaXMuX3R6bSAhPSBudWxsKSB7CiAgICAgIHRoaXMudXRjT2Zmc2V0KHRoaXMuX3R6bSwgZmFsc2UsIHRydWUpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgdGhpcy5faSA9PT0gJ3N0cmluZycpIHsKICAgICAgdmFyIHRab25lID0gb2Zmc2V0RnJvbVN0cmluZyhtYXRjaE9mZnNldCwgdGhpcy5faSk7CgogICAgICBpZiAodFpvbmUgIT0gbnVsbCkgewogICAgICAgIHRoaXMudXRjT2Zmc2V0KHRab25lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnV0Y09mZnNldCgwLCB0cnVlKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0KCiAgZnVuY3Rpb24gaGFzQWxpZ25lZEhvdXJPZmZzZXQoaW5wdXQpIHsKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlucHV0ID0gaW5wdXQgPyBjcmVhdGVMb2NhbChpbnB1dCkudXRjT2Zmc2V0KCkgOiAwOwogICAgcmV0dXJuICh0aGlzLnV0Y09mZnNldCgpIC0gaW5wdXQpICUgNjAgPT09IDA7CiAgfQoKICBmdW5jdGlvbiBpc0RheWxpZ2h0U2F2aW5nVGltZSgpIHsKICAgIHJldHVybiB0aGlzLnV0Y09mZnNldCgpID4gdGhpcy5jbG9uZSgpLm1vbnRoKDApLnV0Y09mZnNldCgpIHx8IHRoaXMudXRjT2Zmc2V0KCkgPiB0aGlzLmNsb25lKCkubW9udGgoNSkudXRjT2Zmc2V0KCk7CiAgfQoKICBmdW5jdGlvbiBpc0RheWxpZ2h0U2F2aW5nVGltZVNoaWZ0ZWQoKSB7CiAgICBpZiAoIWlzVW5kZWZpbmVkKHRoaXMuX2lzRFNUU2hpZnRlZCkpIHsKICAgICAgcmV0dXJuIHRoaXMuX2lzRFNUU2hpZnRlZDsKICAgIH0KCiAgICB2YXIgYyA9IHt9LAogICAgICAgIG90aGVyOwogICAgY29weUNvbmZpZyhjLCB0aGlzKTsKICAgIGMgPSBwcmVwYXJlQ29uZmlnKGMpOwoKICAgIGlmIChjLl9hKSB7CiAgICAgIG90aGVyID0gYy5faXNVVEMgPyBjcmVhdGVVVEMoYy5fYSkgOiBjcmVhdGVMb2NhbChjLl9hKTsKICAgICAgdGhpcy5faXNEU1RTaGlmdGVkID0gdGhpcy5pc1ZhbGlkKCkgJiYgY29tcGFyZUFycmF5cyhjLl9hLCBvdGhlci50b0FycmF5KCkpID4gMDsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2lzRFNUU2hpZnRlZCA9IGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0aGlzLl9pc0RTVFNoaWZ0ZWQ7CiAgfQoKICBmdW5jdGlvbiBpc0xvY2FsKCkgewogICAgcmV0dXJuIHRoaXMuaXNWYWxpZCgpID8gIXRoaXMuX2lzVVRDIDogZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBpc1V0Y09mZnNldCgpIHsKICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSA/IHRoaXMuX2lzVVRDIDogZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBpc1V0YygpIHsKICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSA/IHRoaXMuX2lzVVRDICYmIHRoaXMuX29mZnNldCA9PT0gMCA6IGZhbHNlOwogIH0gLy8gQVNQLk5FVCBqc29uIGRhdGUgZm9ybWF0IHJlZ2V4CgoKICB2YXIgYXNwTmV0UmVnZXggPSAvXigtfFwrKT8oPzooXGQqKVsuIF0pPyhcZCspOihcZCspKD86OihcZCspKFwuXGQqKT8pPyQvLAogICAgICAvLyBmcm9tIGh0dHA6Ly9kb2NzLmNsb3N1cmUtbGlicmFyeS5nb29nbGVjb2RlLmNvbS9naXQvY2xvc3VyZV9nb29nX2RhdGVfZGF0ZS5qcy5zb3VyY2UuaHRtbAogIC8vIHNvbWV3aGF0IG1vcmUgaW4gbGluZSB3aXRoIDQuNC4zLjIgMjAwNCBzcGVjLCBidXQgYWxsb3dzIGRlY2ltYWwgYW55d2hlcmUKICAvLyBhbmQgZnVydGhlciBtb2RpZmllZCB0byBhbGxvdyBmb3Igc3RyaW5ncyBjb250YWluaW5nIGJvdGggd2VlayBhbmQgZGF5CiAgaXNvUmVnZXggPSAvXigtfFwrKT9QKD86KFstK10/WzAtOSwuXSopWSk/KD86KFstK10/WzAtOSwuXSopTSk/KD86KFstK10/WzAtOSwuXSopVyk/KD86KFstK10/WzAtOSwuXSopRCk/KD86VCg/OihbLStdP1swLTksLl0qKUgpPyg/OihbLStdP1swLTksLl0qKU0pPyg/OihbLStdP1swLTksLl0qKVMpPyk/JC87CgogIGZ1bmN0aW9uIGNyZWF0ZUR1cmF0aW9uKGlucHV0LCBrZXkpIHsKICAgIHZhciBkdXJhdGlvbiA9IGlucHV0LAogICAgICAgIC8vIG1hdGNoaW5nIGFnYWluc3QgcmVnZXhwIGlzIGV4cGVuc2l2ZSwgZG8gaXQgb24gZGVtYW5kCiAgICBtYXRjaCA9IG51bGwsCiAgICAgICAgc2lnbiwKICAgICAgICByZXQsCiAgICAgICAgZGlmZlJlczsKCiAgICBpZiAoaXNEdXJhdGlvbihpbnB1dCkpIHsKICAgICAgZHVyYXRpb24gPSB7CiAgICAgICAgbXM6IGlucHV0Ll9taWxsaXNlY29uZHMsCiAgICAgICAgZDogaW5wdXQuX2RheXMsCiAgICAgICAgTTogaW5wdXQuX21vbnRocwogICAgICB9OwogICAgfSBlbHNlIGlmIChpc051bWJlcihpbnB1dCkgfHwgIWlzTmFOKCtpbnB1dCkpIHsKICAgICAgZHVyYXRpb24gPSB7fTsKCiAgICAgIGlmIChrZXkpIHsKICAgICAgICBkdXJhdGlvbltrZXldID0gK2lucHV0OwogICAgICB9IGVsc2UgewogICAgICAgIGR1cmF0aW9uLm1pbGxpc2Vjb25kcyA9ICtpbnB1dDsKICAgICAgfQogICAgfSBlbHNlIGlmIChtYXRjaCA9IGFzcE5ldFJlZ2V4LmV4ZWMoaW5wdXQpKSB7CiAgICAgIHNpZ24gPSBtYXRjaFsxXSA9PT0gJy0nID8gLTEgOiAxOwogICAgICBkdXJhdGlvbiA9IHsKICAgICAgICB5OiAwLAogICAgICAgIGQ6IHRvSW50KG1hdGNoW0RBVEVdKSAqIHNpZ24sCiAgICAgICAgaDogdG9JbnQobWF0Y2hbSE9VUl0pICogc2lnbiwKICAgICAgICBtOiB0b0ludChtYXRjaFtNSU5VVEVdKSAqIHNpZ24sCiAgICAgICAgczogdG9JbnQobWF0Y2hbU0VDT05EXSkgKiBzaWduLAogICAgICAgIG1zOiB0b0ludChhYnNSb3VuZChtYXRjaFtNSUxMSVNFQ09ORF0gKiAxMDAwKSkgKiBzaWduIC8vIHRoZSBtaWxsaXNlY29uZCBkZWNpbWFsIHBvaW50IGlzIGluY2x1ZGVkIGluIHRoZSBtYXRjaAoKICAgICAgfTsKICAgIH0gZWxzZSBpZiAobWF0Y2ggPSBpc29SZWdleC5leGVjKGlucHV0KSkgewogICAgICBzaWduID0gbWF0Y2hbMV0gPT09ICctJyA/IC0xIDogMTsKICAgICAgZHVyYXRpb24gPSB7CiAgICAgICAgeTogcGFyc2VJc28obWF0Y2hbMl0sIHNpZ24pLAogICAgICAgIE06IHBhcnNlSXNvKG1hdGNoWzNdLCBzaWduKSwKICAgICAgICB3OiBwYXJzZUlzbyhtYXRjaFs0XSwgc2lnbiksCiAgICAgICAgZDogcGFyc2VJc28obWF0Y2hbNV0sIHNpZ24pLAogICAgICAgIGg6IHBhcnNlSXNvKG1hdGNoWzZdLCBzaWduKSwKICAgICAgICBtOiBwYXJzZUlzbyhtYXRjaFs3XSwgc2lnbiksCiAgICAgICAgczogcGFyc2VJc28obWF0Y2hbOF0sIHNpZ24pCiAgICAgIH07CiAgICB9IGVsc2UgaWYgKGR1cmF0aW9uID09IG51bGwpIHsKICAgICAgLy8gY2hlY2tzIGZvciBudWxsIG9yIHVuZGVmaW5lZAogICAgICBkdXJhdGlvbiA9IHt9OwogICAgfSBlbHNlIGlmIChfdHlwZW9mKGR1cmF0aW9uKSA9PT0gJ29iamVjdCcgJiYgKCdmcm9tJyBpbiBkdXJhdGlvbiB8fCAndG8nIGluIGR1cmF0aW9uKSkgewogICAgICBkaWZmUmVzID0gbW9tZW50c0RpZmZlcmVuY2UoY3JlYXRlTG9jYWwoZHVyYXRpb24uZnJvbSksIGNyZWF0ZUxvY2FsKGR1cmF0aW9uLnRvKSk7CiAgICAgIGR1cmF0aW9uID0ge307CiAgICAgIGR1cmF0aW9uLm1zID0gZGlmZlJlcy5taWxsaXNlY29uZHM7CiAgICAgIGR1cmF0aW9uLk0gPSBkaWZmUmVzLm1vbnRoczsKICAgIH0KCiAgICByZXQgPSBuZXcgRHVyYXRpb24oZHVyYXRpb24pOwoKICAgIGlmIChpc0R1cmF0aW9uKGlucHV0KSAmJiBoYXNPd25Qcm9wKGlucHV0LCAnX2xvY2FsZScpKSB7CiAgICAgIHJldC5fbG9jYWxlID0gaW5wdXQuX2xvY2FsZTsKICAgIH0KCiAgICBpZiAoaXNEdXJhdGlvbihpbnB1dCkgJiYgaGFzT3duUHJvcChpbnB1dCwgJ19pc1ZhbGlkJykpIHsKICAgICAgcmV0Ll9pc1ZhbGlkID0gaW5wdXQuX2lzVmFsaWQ7CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9CgogIGNyZWF0ZUR1cmF0aW9uLmZuID0gRHVyYXRpb24ucHJvdG90eXBlOwogIGNyZWF0ZUR1cmF0aW9uLmludmFsaWQgPSBjcmVhdGVJbnZhbGlkJDE7CgogIGZ1bmN0aW9uIHBhcnNlSXNvKGlucCwgc2lnbikgewogICAgLy8gV2UnZCBub3JtYWxseSB1c2Ugfn5pbnAgZm9yIHRoaXMsIGJ1dCB1bmZvcnR1bmF0ZWx5IGl0IGFsc28KICAgIC8vIGNvbnZlcnRzIGZsb2F0cyB0byBpbnRzLgogICAgLy8gaW5wIG1heSBiZSB1bmRlZmluZWQsIHNvIGNhcmVmdWwgY2FsbGluZyByZXBsYWNlIG9uIGl0LgogICAgdmFyIHJlcyA9IGlucCAmJiBwYXJzZUZsb2F0KGlucC5yZXBsYWNlKCcsJywgJy4nKSk7IC8vIGFwcGx5IHNpZ24gd2hpbGUgd2UncmUgYXQgaXQKCiAgICByZXR1cm4gKGlzTmFOKHJlcykgPyAwIDogcmVzKSAqIHNpZ247CiAgfQoKICBmdW5jdGlvbiBwb3NpdGl2ZU1vbWVudHNEaWZmZXJlbmNlKGJhc2UsIG90aGVyKSB7CiAgICB2YXIgcmVzID0ge307CiAgICByZXMubW9udGhzID0gb3RoZXIubW9udGgoKSAtIGJhc2UubW9udGgoKSArIChvdGhlci55ZWFyKCkgLSBiYXNlLnllYXIoKSkgKiAxMjsKCiAgICBpZiAoYmFzZS5jbG9uZSgpLmFkZChyZXMubW9udGhzLCAnTScpLmlzQWZ0ZXIob3RoZXIpKSB7CiAgICAgIC0tcmVzLm1vbnRoczsKICAgIH0KCiAgICByZXMubWlsbGlzZWNvbmRzID0gK290aGVyIC0gK2Jhc2UuY2xvbmUoKS5hZGQocmVzLm1vbnRocywgJ00nKTsKICAgIHJldHVybiByZXM7CiAgfQoKICBmdW5jdGlvbiBtb21lbnRzRGlmZmVyZW5jZShiYXNlLCBvdGhlcikgewogICAgdmFyIHJlczsKCiAgICBpZiAoIShiYXNlLmlzVmFsaWQoKSAmJiBvdGhlci5pc1ZhbGlkKCkpKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgbWlsbGlzZWNvbmRzOiAwLAogICAgICAgIG1vbnRoczogMAogICAgICB9OwogICAgfQoKICAgIG90aGVyID0gY2xvbmVXaXRoT2Zmc2V0KG90aGVyLCBiYXNlKTsKCiAgICBpZiAoYmFzZS5pc0JlZm9yZShvdGhlcikpIHsKICAgICAgcmVzID0gcG9zaXRpdmVNb21lbnRzRGlmZmVyZW5jZShiYXNlLCBvdGhlcik7CiAgICB9IGVsc2UgewogICAgICByZXMgPSBwb3NpdGl2ZU1vbWVudHNEaWZmZXJlbmNlKG90aGVyLCBiYXNlKTsKICAgICAgcmVzLm1pbGxpc2Vjb25kcyA9IC1yZXMubWlsbGlzZWNvbmRzOwogICAgICByZXMubW9udGhzID0gLXJlcy5tb250aHM7CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9IC8vIFRPRE86IHJlbW92ZSAnbmFtZScgYXJnIGFmdGVyIGRlcHJlY2F0aW9uIGlzIHJlbW92ZWQKCgogIGZ1bmN0aW9uIGNyZWF0ZUFkZGVyKGRpcmVjdGlvbiwgbmFtZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICh2YWwsIHBlcmlvZCkgewogICAgICB2YXIgZHVyLCB0bXA7IC8vaW52ZXJ0IHRoZSBhcmd1bWVudHMsIGJ1dCBjb21wbGFpbiBhYm91dCBpdAoKICAgICAgaWYgKHBlcmlvZCAhPT0gbnVsbCAmJiAhaXNOYU4oK3BlcmlvZCkpIHsKICAgICAgICBkZXByZWNhdGVTaW1wbGUobmFtZSwgJ21vbWVudCgpLicgKyBuYW1lICsgJyhwZXJpb2QsIG51bWJlcikgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBtb21lbnQoKS4nICsgbmFtZSArICcobnVtYmVyLCBwZXJpb2QpLiAnICsgJ1NlZSBodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL2FkZC1pbnZlcnRlZC1wYXJhbS8gZm9yIG1vcmUgaW5mby4nKTsKICAgICAgICB0bXAgPSB2YWw7CiAgICAgICAgdmFsID0gcGVyaW9kOwogICAgICAgIHBlcmlvZCA9IHRtcDsKICAgICAgfQoKICAgICAgZHVyID0gY3JlYXRlRHVyYXRpb24odmFsLCBwZXJpb2QpOwogICAgICBhZGRTdWJ0cmFjdCh0aGlzLCBkdXIsIGRpcmVjdGlvbik7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGFkZFN1YnRyYWN0KG1vbSwgZHVyYXRpb24sIGlzQWRkaW5nLCB1cGRhdGVPZmZzZXQpIHsKICAgIHZhciBtaWxsaXNlY29uZHMgPSBkdXJhdGlvbi5fbWlsbGlzZWNvbmRzLAogICAgICAgIGRheXMgPSBhYnNSb3VuZChkdXJhdGlvbi5fZGF5cyksCiAgICAgICAgbW9udGhzID0gYWJzUm91bmQoZHVyYXRpb24uX21vbnRocyk7CgogICAgaWYgKCFtb20uaXNWYWxpZCgpKSB7CiAgICAgIC8vIE5vIG9wCiAgICAgIHJldHVybjsKICAgIH0KCiAgICB1cGRhdGVPZmZzZXQgPSB1cGRhdGVPZmZzZXQgPT0gbnVsbCA/IHRydWUgOiB1cGRhdGVPZmZzZXQ7CgogICAgaWYgKG1vbnRocykgewogICAgICBzZXRNb250aChtb20sIGdldChtb20sICdNb250aCcpICsgbW9udGhzICogaXNBZGRpbmcpOwogICAgfQoKICAgIGlmIChkYXlzKSB7CiAgICAgIHNldCQxKG1vbSwgJ0RhdGUnLCBnZXQobW9tLCAnRGF0ZScpICsgZGF5cyAqIGlzQWRkaW5nKTsKICAgIH0KCiAgICBpZiAobWlsbGlzZWNvbmRzKSB7CiAgICAgIG1vbS5fZC5zZXRUaW1lKG1vbS5fZC52YWx1ZU9mKCkgKyBtaWxsaXNlY29uZHMgKiBpc0FkZGluZyk7CiAgICB9CgogICAgaWYgKHVwZGF0ZU9mZnNldCkgewogICAgICBob29rcy51cGRhdGVPZmZzZXQobW9tLCBkYXlzIHx8IG1vbnRocyk7CiAgICB9CiAgfQoKICB2YXIgYWRkID0gY3JlYXRlQWRkZXIoMSwgJ2FkZCcpLAogICAgICBzdWJ0cmFjdCA9IGNyZWF0ZUFkZGVyKC0xLCAnc3VidHJhY3QnKTsKCiAgZnVuY3Rpb24gaXNTdHJpbmcoaW5wdXQpIHsKICAgIHJldHVybiB0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnIHx8IGlucHV0IGluc3RhbmNlb2YgU3RyaW5nOwogIH0gLy8gdHlwZSBNb21lbnRJbnB1dCA9IE1vbWVudCB8IERhdGUgfCBzdHJpbmcgfCBudW1iZXIgfCAobnVtYmVyIHwgc3RyaW5nKVtdIHwgTW9tZW50SW5wdXRPYmplY3QgfCB2b2lkOyAvLyBudWxsIHwgdW5kZWZpbmVkCgoKICBmdW5jdGlvbiBpc01vbWVudElucHV0KGlucHV0KSB7CiAgICByZXR1cm4gaXNNb21lbnQoaW5wdXQpIHx8IGlzRGF0ZShpbnB1dCkgfHwgaXNTdHJpbmcoaW5wdXQpIHx8IGlzTnVtYmVyKGlucHV0KSB8fCBpc051bWJlck9yU3RyaW5nQXJyYXkoaW5wdXQpIHx8IGlzTW9tZW50SW5wdXRPYmplY3QoaW5wdXQpIHx8IGlucHV0ID09PSBudWxsIHx8IGlucHV0ID09PSB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiBpc01vbWVudElucHV0T2JqZWN0KGlucHV0KSB7CiAgICB2YXIgb2JqZWN0VGVzdCA9IGlzT2JqZWN0KGlucHV0KSAmJiAhaXNPYmplY3RFbXB0eShpbnB1dCksCiAgICAgICAgcHJvcGVydHlUZXN0ID0gZmFsc2UsCiAgICAgICAgcHJvcGVydGllcyA9IFsneWVhcnMnLCAneWVhcicsICd5JywgJ21vbnRocycsICdtb250aCcsICdNJywgJ2RheXMnLCAnZGF5JywgJ2QnLCAnZGF0ZXMnLCAnZGF0ZScsICdEJywgJ2hvdXJzJywgJ2hvdXInLCAnaCcsICdtaW51dGVzJywgJ21pbnV0ZScsICdtJywgJ3NlY29uZHMnLCAnc2Vjb25kJywgJ3MnLCAnbWlsbGlzZWNvbmRzJywgJ21pbGxpc2Vjb25kJywgJ21zJ10sCiAgICAgICAgaSwKICAgICAgICBwcm9wZXJ0eTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgcHJvcGVydGllcy5sZW5ndGg7IGkgKz0gMSkgewogICAgICBwcm9wZXJ0eSA9IHByb3BlcnRpZXNbaV07CiAgICAgIHByb3BlcnR5VGVzdCA9IHByb3BlcnR5VGVzdCB8fCBoYXNPd25Qcm9wKGlucHV0LCBwcm9wZXJ0eSk7CiAgICB9CgogICAgcmV0dXJuIG9iamVjdFRlc3QgJiYgcHJvcGVydHlUZXN0OwogIH0KCiAgZnVuY3Rpb24gaXNOdW1iZXJPclN0cmluZ0FycmF5KGlucHV0KSB7CiAgICB2YXIgYXJyYXlUZXN0ID0gaXNBcnJheShpbnB1dCksCiAgICAgICAgZGF0YVR5cGVUZXN0ID0gZmFsc2U7CgogICAgaWYgKGFycmF5VGVzdCkgewogICAgICBkYXRhVHlwZVRlc3QgPSBpbnB1dC5maWx0ZXIoZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICByZXR1cm4gIWlzTnVtYmVyKGl0ZW0pICYmIGlzU3RyaW5nKGlucHV0KTsKICAgICAgfSkubGVuZ3RoID09PSAwOwogICAgfQoKICAgIHJldHVybiBhcnJheVRlc3QgJiYgZGF0YVR5cGVUZXN0OwogIH0KCiAgZnVuY3Rpb24gaXNDYWxlbmRhclNwZWMoaW5wdXQpIHsKICAgIHZhciBvYmplY3RUZXN0ID0gaXNPYmplY3QoaW5wdXQpICYmICFpc09iamVjdEVtcHR5KGlucHV0KSwKICAgICAgICBwcm9wZXJ0eVRlc3QgPSBmYWxzZSwKICAgICAgICBwcm9wZXJ0aWVzID0gWydzYW1lRGF5JywgJ25leHREYXknLCAnbGFzdERheScsICduZXh0V2VlaycsICdsYXN0V2VlaycsICdzYW1lRWxzZSddLAogICAgICAgIGksCiAgICAgICAgcHJvcGVydHk7CgogICAgZm9yIChpID0gMDsgaSA8IHByb3BlcnRpZXMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgcHJvcGVydHkgPSBwcm9wZXJ0aWVzW2ldOwogICAgICBwcm9wZXJ0eVRlc3QgPSBwcm9wZXJ0eVRlc3QgfHwgaGFzT3duUHJvcChpbnB1dCwgcHJvcGVydHkpOwogICAgfQoKICAgIHJldHVybiBvYmplY3RUZXN0ICYmIHByb3BlcnR5VGVzdDsKICB9CgogIGZ1bmN0aW9uIGdldENhbGVuZGFyRm9ybWF0KG15TW9tZW50LCBub3cpIHsKICAgIHZhciBkaWZmID0gbXlNb21lbnQuZGlmZihub3csICdkYXlzJywgdHJ1ZSk7CiAgICByZXR1cm4gZGlmZiA8IC02ID8gJ3NhbWVFbHNlJyA6IGRpZmYgPCAtMSA/ICdsYXN0V2VlaycgOiBkaWZmIDwgMCA/ICdsYXN0RGF5JyA6IGRpZmYgPCAxID8gJ3NhbWVEYXknIDogZGlmZiA8IDIgPyAnbmV4dERheScgOiBkaWZmIDwgNyA/ICduZXh0V2VlaycgOiAnc2FtZUVsc2UnOwogIH0KCiAgZnVuY3Rpb24gY2FsZW5kYXIkMSh0aW1lLCBmb3JtYXRzKSB7CiAgICAvLyBTdXBwb3J0IGZvciBzaW5nbGUgcGFyYW1ldGVyLCBmb3JtYXRzIG9ubHkgb3ZlcmxvYWQgdG8gdGhlIGNhbGVuZGFyIGZ1bmN0aW9uCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICBpZiAoIWFyZ3VtZW50c1swXSkgewogICAgICAgIHRpbWUgPSB1bmRlZmluZWQ7CiAgICAgICAgZm9ybWF0cyA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIGlmIChpc01vbWVudElucHV0KGFyZ3VtZW50c1swXSkpIHsKICAgICAgICB0aW1lID0gYXJndW1lbnRzWzBdOwogICAgICAgIGZvcm1hdHMgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSBpZiAoaXNDYWxlbmRhclNwZWMoYXJndW1lbnRzWzBdKSkgewogICAgICAgIGZvcm1hdHMgPSBhcmd1bWVudHNbMF07CiAgICAgICAgdGltZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfSAvLyBXZSB3YW50IHRvIGNvbXBhcmUgdGhlIHN0YXJ0IG9mIHRvZGF5LCB2cyB0aGlzLgogICAgLy8gR2V0dGluZyBzdGFydC1vZi10b2RheSBkZXBlbmRzIG9uIHdoZXRoZXIgd2UncmUgbG9jYWwvdXRjL29mZnNldCBvciBub3QuCgoKICAgIHZhciBub3cgPSB0aW1lIHx8IGNyZWF0ZUxvY2FsKCksCiAgICAgICAgc29kID0gY2xvbmVXaXRoT2Zmc2V0KG5vdywgdGhpcykuc3RhcnRPZignZGF5JyksCiAgICAgICAgZm9ybWF0ID0gaG9va3MuY2FsZW5kYXJGb3JtYXQodGhpcywgc29kKSB8fCAnc2FtZUVsc2UnLAogICAgICAgIG91dHB1dCA9IGZvcm1hdHMgJiYgKGlzRnVuY3Rpb24oZm9ybWF0c1tmb3JtYXRdKSA/IGZvcm1hdHNbZm9ybWF0XS5jYWxsKHRoaXMsIG5vdykgOiBmb3JtYXRzW2Zvcm1hdF0pOwogICAgcmV0dXJuIHRoaXMuZm9ybWF0KG91dHB1dCB8fCB0aGlzLmxvY2FsZURhdGEoKS5jYWxlbmRhcihmb3JtYXQsIHRoaXMsIGNyZWF0ZUxvY2FsKG5vdykpKTsKICB9CgogIGZ1bmN0aW9uIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyBNb21lbnQodGhpcyk7CiAgfQoKICBmdW5jdGlvbiBpc0FmdGVyKGlucHV0LCB1bml0cykgewogICAgdmFyIGxvY2FsSW5wdXQgPSBpc01vbWVudChpbnB1dCkgPyBpbnB1dCA6IGNyZWF0ZUxvY2FsKGlucHV0KTsKCiAgICBpZiAoISh0aGlzLmlzVmFsaWQoKSAmJiBsb2NhbElucHV0LmlzVmFsaWQoKSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpIHx8ICdtaWxsaXNlY29uZCc7CgogICAgaWYgKHVuaXRzID09PSAnbWlsbGlzZWNvbmQnKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKSA+IGxvY2FsSW5wdXQudmFsdWVPZigpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGxvY2FsSW5wdXQudmFsdWVPZigpIDwgdGhpcy5jbG9uZSgpLnN0YXJ0T2YodW5pdHMpLnZhbHVlT2YoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGlzQmVmb3JlKGlucHV0LCB1bml0cykgewogICAgdmFyIGxvY2FsSW5wdXQgPSBpc01vbWVudChpbnB1dCkgPyBpbnB1dCA6IGNyZWF0ZUxvY2FsKGlucHV0KTsKCiAgICBpZiAoISh0aGlzLmlzVmFsaWQoKSAmJiBsb2NhbElucHV0LmlzVmFsaWQoKSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpIHx8ICdtaWxsaXNlY29uZCc7CgogICAgaWYgKHVuaXRzID09PSAnbWlsbGlzZWNvbmQnKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKSA8IGxvY2FsSW5wdXQudmFsdWVPZigpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5lbmRPZih1bml0cykudmFsdWVPZigpIDwgbG9jYWxJbnB1dC52YWx1ZU9mKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc0JldHdlZW4oZnJvbSwgdG8sIHVuaXRzLCBpbmNsdXNpdml0eSkgewogICAgdmFyIGxvY2FsRnJvbSA9IGlzTW9tZW50KGZyb20pID8gZnJvbSA6IGNyZWF0ZUxvY2FsKGZyb20pLAogICAgICAgIGxvY2FsVG8gPSBpc01vbWVudCh0bykgPyB0byA6IGNyZWF0ZUxvY2FsKHRvKTsKCiAgICBpZiAoISh0aGlzLmlzVmFsaWQoKSAmJiBsb2NhbEZyb20uaXNWYWxpZCgpICYmIGxvY2FsVG8uaXNWYWxpZCgpKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaW5jbHVzaXZpdHkgPSBpbmNsdXNpdml0eSB8fCAnKCknOwogICAgcmV0dXJuIChpbmNsdXNpdml0eVswXSA9PT0gJygnID8gdGhpcy5pc0FmdGVyKGxvY2FsRnJvbSwgdW5pdHMpIDogIXRoaXMuaXNCZWZvcmUobG9jYWxGcm9tLCB1bml0cykpICYmIChpbmNsdXNpdml0eVsxXSA9PT0gJyknID8gdGhpcy5pc0JlZm9yZShsb2NhbFRvLCB1bml0cykgOiAhdGhpcy5pc0FmdGVyKGxvY2FsVG8sIHVuaXRzKSk7CiAgfQoKICBmdW5jdGlvbiBpc1NhbWUoaW5wdXQsIHVuaXRzKSB7CiAgICB2YXIgbG9jYWxJbnB1dCA9IGlzTW9tZW50KGlucHV0KSA/IGlucHV0IDogY3JlYXRlTG9jYWwoaW5wdXQpLAogICAgICAgIGlucHV0TXM7CgogICAgaWYgKCEodGhpcy5pc1ZhbGlkKCkgJiYgbG9jYWxJbnB1dC5pc1ZhbGlkKCkpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKSB8fCAnbWlsbGlzZWNvbmQnOwoKICAgIGlmICh1bml0cyA9PT0gJ21pbGxpc2Vjb25kJykgewogICAgICByZXR1cm4gdGhpcy52YWx1ZU9mKCkgPT09IGxvY2FsSW5wdXQudmFsdWVPZigpOwogICAgfSBlbHNlIHsKICAgICAgaW5wdXRNcyA9IGxvY2FsSW5wdXQudmFsdWVPZigpOwogICAgICByZXR1cm4gdGhpcy5jbG9uZSgpLnN0YXJ0T2YodW5pdHMpLnZhbHVlT2YoKSA8PSBpbnB1dE1zICYmIGlucHV0TXMgPD0gdGhpcy5jbG9uZSgpLmVuZE9mKHVuaXRzKS52YWx1ZU9mKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1NhbWVPckFmdGVyKGlucHV0LCB1bml0cykgewogICAgcmV0dXJuIHRoaXMuaXNTYW1lKGlucHV0LCB1bml0cykgfHwgdGhpcy5pc0FmdGVyKGlucHV0LCB1bml0cyk7CiAgfQoKICBmdW5jdGlvbiBpc1NhbWVPckJlZm9yZShpbnB1dCwgdW5pdHMpIHsKICAgIHJldHVybiB0aGlzLmlzU2FtZShpbnB1dCwgdW5pdHMpIHx8IHRoaXMuaXNCZWZvcmUoaW5wdXQsIHVuaXRzKTsKICB9CgogIGZ1bmN0aW9uIGRpZmYoaW5wdXQsIHVuaXRzLCBhc0Zsb2F0KSB7CiAgICB2YXIgdGhhdCwgem9uZURlbHRhLCBvdXRwdXQ7CgogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICByZXR1cm4gTmFOOwogICAgfQoKICAgIHRoYXQgPSBjbG9uZVdpdGhPZmZzZXQoaW5wdXQsIHRoaXMpOwoKICAgIGlmICghdGhhdC5pc1ZhbGlkKCkpIHsKICAgICAgcmV0dXJuIE5hTjsKICAgIH0KCiAgICB6b25lRGVsdGEgPSAodGhhdC51dGNPZmZzZXQoKSAtIHRoaXMudXRjT2Zmc2V0KCkpICogNmU0OwogICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CgogICAgc3dpdGNoICh1bml0cykgewogICAgICBjYXNlICd5ZWFyJzoKICAgICAgICBvdXRwdXQgPSBtb250aERpZmYodGhpcywgdGhhdCkgLyAxMjsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ21vbnRoJzoKICAgICAgICBvdXRwdXQgPSBtb250aERpZmYodGhpcywgdGhhdCk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdxdWFydGVyJzoKICAgICAgICBvdXRwdXQgPSBtb250aERpZmYodGhpcywgdGhhdCkgLyAzOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2Vjb25kJzoKICAgICAgICBvdXRwdXQgPSAodGhpcyAtIHRoYXQpIC8gMWUzOwogICAgICAgIGJyZWFrOwogICAgICAvLyAxMDAwCgogICAgICBjYXNlICdtaW51dGUnOgogICAgICAgIG91dHB1dCA9ICh0aGlzIC0gdGhhdCkgLyA2ZTQ7CiAgICAgICAgYnJlYWs7CiAgICAgIC8vIDEwMDAgKiA2MAoKICAgICAgY2FzZSAnaG91cic6CiAgICAgICAgb3V0cHV0ID0gKHRoaXMgLSB0aGF0KSAvIDM2ZTU7CiAgICAgICAgYnJlYWs7CiAgICAgIC8vIDEwMDAgKiA2MCAqIDYwCgogICAgICBjYXNlICdkYXknOgogICAgICAgIG91dHB1dCA9ICh0aGlzIC0gdGhhdCAtIHpvbmVEZWx0YSkgLyA4NjRlNTsKICAgICAgICBicmVhazsKICAgICAgLy8gMTAwMCAqIDYwICogNjAgKiAyNCwgbmVnYXRlIGRzdAoKICAgICAgY2FzZSAnd2Vlayc6CiAgICAgICAgb3V0cHV0ID0gKHRoaXMgLSB0aGF0IC0gem9uZURlbHRhKSAvIDYwNDhlNTsKICAgICAgICBicmVhazsKICAgICAgLy8gMTAwMCAqIDYwICogNjAgKiAyNCAqIDcsIG5lZ2F0ZSBkc3QKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgb3V0cHV0ID0gdGhpcyAtIHRoYXQ7CiAgICB9CgogICAgcmV0dXJuIGFzRmxvYXQgPyBvdXRwdXQgOiBhYnNGbG9vcihvdXRwdXQpOwogIH0KCiAgZnVuY3Rpb24gbW9udGhEaWZmKGEsIGIpIHsKICAgIGlmIChhLmRhdGUoKSA8IGIuZGF0ZSgpKSB7CiAgICAgIC8vIGVuZC1vZi1tb250aCBjYWxjdWxhdGlvbnMgd29yayBjb3JyZWN0IHdoZW4gdGhlIHN0YXJ0IG1vbnRoIGhhcyBtb3JlCiAgICAgIC8vIGRheXMgdGhhbiB0aGUgZW5kIG1vbnRoLgogICAgICByZXR1cm4gLW1vbnRoRGlmZihiLCBhKTsKICAgIH0gLy8gZGlmZmVyZW5jZSBpbiBtb250aHMKCgogICAgdmFyIHdob2xlTW9udGhEaWZmID0gKGIueWVhcigpIC0gYS55ZWFyKCkpICogMTIgKyAoYi5tb250aCgpIC0gYS5tb250aCgpKSwKICAgICAgICAvLyBiIGlzIGluIChhbmNob3IgLSAxIG1vbnRoLCBhbmNob3IgKyAxIG1vbnRoKQogICAgYW5jaG9yID0gYS5jbG9uZSgpLmFkZCh3aG9sZU1vbnRoRGlmZiwgJ21vbnRocycpLAogICAgICAgIGFuY2hvcjIsCiAgICAgICAgYWRqdXN0OwoKICAgIGlmIChiIC0gYW5jaG9yIDwgMCkgewogICAgICBhbmNob3IyID0gYS5jbG9uZSgpLmFkZCh3aG9sZU1vbnRoRGlmZiAtIDEsICdtb250aHMnKTsgLy8gbGluZWFyIGFjcm9zcyB0aGUgbW9udGgKCiAgICAgIGFkanVzdCA9IChiIC0gYW5jaG9yKSAvIChhbmNob3IgLSBhbmNob3IyKTsKICAgIH0gZWxzZSB7CiAgICAgIGFuY2hvcjIgPSBhLmNsb25lKCkuYWRkKHdob2xlTW9udGhEaWZmICsgMSwgJ21vbnRocycpOyAvLyBsaW5lYXIgYWNyb3NzIHRoZSBtb250aAoKICAgICAgYWRqdXN0ID0gKGIgLSBhbmNob3IpIC8gKGFuY2hvcjIgLSBhbmNob3IpOwogICAgfSAvL2NoZWNrIGZvciBuZWdhdGl2ZSB6ZXJvLCByZXR1cm4gemVybyBpZiBuZWdhdGl2ZSB6ZXJvCgoKICAgIHJldHVybiAtKHdob2xlTW9udGhEaWZmICsgYWRqdXN0KSB8fCAwOwogIH0KCiAgaG9va3MuZGVmYXVsdEZvcm1hdCA9ICdZWVlZLU1NLUREVEhIOm1tOnNzWic7CiAgaG9va3MuZGVmYXVsdEZvcm1hdFV0YyA9ICdZWVlZLU1NLUREVEhIOm1tOnNzW1pdJzsKCiAgZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5jbG9uZSgpLmxvY2FsZSgnZW4nKS5mb3JtYXQoJ2RkZCBNTU0gREQgWVlZWSBISDptbTpzcyBbR01UXVpaJyk7CiAgfQoKICBmdW5jdGlvbiB0b0lTT1N0cmluZyhrZWVwT2Zmc2V0KSB7CiAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHZhciB1dGMgPSBrZWVwT2Zmc2V0ICE9PSB0cnVlLAogICAgICAgIG0gPSB1dGMgPyB0aGlzLmNsb25lKCkudXRjKCkgOiB0aGlzOwoKICAgIGlmIChtLnllYXIoKSA8IDAgfHwgbS55ZWFyKCkgPiA5OTk5KSB7CiAgICAgIHJldHVybiBmb3JtYXRNb21lbnQobSwgdXRjID8gJ1lZWVlZWS1NTS1ERFtUXUhIOm1tOnNzLlNTU1taXScgOiAnWVlZWVlZLU1NLUREW1RdSEg6bW06c3MuU1NTWicpOwogICAgfQoKICAgIGlmIChpc0Z1bmN0aW9uKERhdGUucHJvdG90eXBlLnRvSVNPU3RyaW5nKSkgewogICAgICAvLyBuYXRpdmUgaW1wbGVtZW50YXRpb24gaXMgfjUweCBmYXN0ZXIsIHVzZSBpdCB3aGVuIHdlIGNhbgogICAgICBpZiAodXRjKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudG9EYXRlKCkudG9JU09TdHJpbmcoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUodGhpcy52YWx1ZU9mKCkgKyB0aGlzLnV0Y09mZnNldCgpICogNjAgKiAxMDAwKS50b0lTT1N0cmluZygpLnJlcGxhY2UoJ1onLCBmb3JtYXRNb21lbnQobSwgJ1onKSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZm9ybWF0TW9tZW50KG0sIHV0YyA/ICdZWVlZLU1NLUREW1RdSEg6bW06c3MuU1NTW1pdJyA6ICdZWVlZLU1NLUREW1RdSEg6bW06c3MuU1NTWicpOwogIH0KICAvKioKICAgKiBSZXR1cm4gYSBodW1hbiByZWFkYWJsZSByZXByZXNlbnRhdGlvbiBvZiBhIG1vbWVudCB0aGF0IGNhbgogICAqIGFsc28gYmUgZXZhbHVhdGVkIHRvIGdldCBhIG5ldyBtb21lbnQgd2hpY2ggaXMgdGhlIHNhbWUKICAgKgogICAqIEBsaW5rIGh0dHBzOi8vbm9kZWpzLm9yZy9kaXN0L2xhdGVzdC9kb2NzL2FwaS91dGlsLmh0bWwjdXRpbF9jdXN0b21faW5zcGVjdF9mdW5jdGlvbl9vbl9vYmplY3RzCiAgICovCgoKICBmdW5jdGlvbiBpbnNwZWN0KCkgewogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICByZXR1cm4gJ21vbWVudC5pbnZhbGlkKC8qICcgKyB0aGlzLl9pICsgJyAqLyknOwogICAgfQoKICAgIHZhciBmdW5jID0gJ21vbWVudCcsCiAgICAgICAgem9uZSA9ICcnLAogICAgICAgIHByZWZpeCwKICAgICAgICB5ZWFyLAogICAgICAgIGRhdGV0aW1lLAogICAgICAgIHN1ZmZpeDsKCiAgICBpZiAoIXRoaXMuaXNMb2NhbCgpKSB7CiAgICAgIGZ1bmMgPSB0aGlzLnV0Y09mZnNldCgpID09PSAwID8gJ21vbWVudC51dGMnIDogJ21vbWVudC5wYXJzZVpvbmUnOwogICAgICB6b25lID0gJ1onOwogICAgfQoKICAgIHByZWZpeCA9ICdbJyArIGZ1bmMgKyAnKCJdJzsKICAgIHllYXIgPSAwIDw9IHRoaXMueWVhcigpICYmIHRoaXMueWVhcigpIDw9IDk5OTkgPyAnWVlZWScgOiAnWVlZWVlZJzsKICAgIGRhdGV0aW1lID0gJy1NTS1ERFtUXUhIOm1tOnNzLlNTUyc7CiAgICBzdWZmaXggPSB6b25lICsgJ1siKV0nOwogICAgcmV0dXJuIHRoaXMuZm9ybWF0KHByZWZpeCArIHllYXIgKyBkYXRldGltZSArIHN1ZmZpeCk7CiAgfQoKICBmdW5jdGlvbiBmb3JtYXQoaW5wdXRTdHJpbmcpIHsKICAgIGlmICghaW5wdXRTdHJpbmcpIHsKICAgICAgaW5wdXRTdHJpbmcgPSB0aGlzLmlzVXRjKCkgPyBob29rcy5kZWZhdWx0Rm9ybWF0VXRjIDogaG9va3MuZGVmYXVsdEZvcm1hdDsKICAgIH0KCiAgICB2YXIgb3V0cHV0ID0gZm9ybWF0TW9tZW50KHRoaXMsIGlucHV0U3RyaW5nKTsKICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5wb3N0Zm9ybWF0KG91dHB1dCk7CiAgfQoKICBmdW5jdGlvbiBmcm9tKHRpbWUsIHdpdGhvdXRTdWZmaXgpIHsKICAgIGlmICh0aGlzLmlzVmFsaWQoKSAmJiAoaXNNb21lbnQodGltZSkgJiYgdGltZS5pc1ZhbGlkKCkgfHwgY3JlYXRlTG9jYWwodGltZSkuaXNWYWxpZCgpKSkgewogICAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24oewogICAgICAgIHRvOiB0aGlzLAogICAgICAgIGZyb206IHRpbWUKICAgICAgfSkubG9jYWxlKHRoaXMubG9jYWxlKCkpLmh1bWFuaXplKCF3aXRob3V0U3VmZml4KTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5pbnZhbGlkRGF0ZSgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZnJvbU5vdyh3aXRob3V0U3VmZml4KSB7CiAgICByZXR1cm4gdGhpcy5mcm9tKGNyZWF0ZUxvY2FsKCksIHdpdGhvdXRTdWZmaXgpOwogIH0KCiAgZnVuY3Rpb24gdG8odGltZSwgd2l0aG91dFN1ZmZpeCkgewogICAgaWYgKHRoaXMuaXNWYWxpZCgpICYmIChpc01vbWVudCh0aW1lKSAmJiB0aW1lLmlzVmFsaWQoKSB8fCBjcmVhdGVMb2NhbCh0aW1lKS5pc1ZhbGlkKCkpKSB7CiAgICAgIHJldHVybiBjcmVhdGVEdXJhdGlvbih7CiAgICAgICAgZnJvbTogdGhpcywKICAgICAgICB0bzogdGltZQogICAgICB9KS5sb2NhbGUodGhpcy5sb2NhbGUoKSkuaHVtYW5pemUoIXdpdGhvdXRTdWZmaXgpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0b05vdyh3aXRob3V0U3VmZml4KSB7CiAgICByZXR1cm4gdGhpcy50byhjcmVhdGVMb2NhbCgpLCB3aXRob3V0U3VmZml4KTsKICB9IC8vIElmIHBhc3NlZCBhIGxvY2FsZSBrZXksIGl0IHdpbGwgc2V0IHRoZSBsb2NhbGUgZm9yIHRoaXMKICAvLyBpbnN0YW5jZS4gIE90aGVyd2lzZSwgaXQgd2lsbCByZXR1cm4gdGhlIGxvY2FsZSBjb25maWd1cmF0aW9uCiAgLy8gdmFyaWFibGVzIGZvciB0aGlzIGluc3RhbmNlLgoKCiAgZnVuY3Rpb24gbG9jYWxlKGtleSkgewogICAgdmFyIG5ld0xvY2FsZURhdGE7CgogICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiB0aGlzLl9sb2NhbGUuX2FiYnI7CiAgICB9IGVsc2UgewogICAgICBuZXdMb2NhbGVEYXRhID0gZ2V0TG9jYWxlKGtleSk7CgogICAgICBpZiAobmV3TG9jYWxlRGF0YSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5fbG9jYWxlID0gbmV3TG9jYWxlRGF0YTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfQoKICB2YXIgbGFuZyA9IGRlcHJlY2F0ZSgnbW9tZW50KCkubGFuZygpIGlzIGRlcHJlY2F0ZWQuIEluc3RlYWQsIHVzZSBtb21lbnQoKS5sb2NhbGVEYXRhKCkgdG8gZ2V0IHRoZSBsYW5ndWFnZSBjb25maWd1cmF0aW9uLiBVc2UgbW9tZW50KCkubG9jYWxlKCkgdG8gY2hhbmdlIGxhbmd1YWdlcy4nLCBmdW5jdGlvbiAoa2V5KSB7CiAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYWxlKGtleSk7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIGxvY2FsZURhdGEoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9jYWxlOwogIH0KCiAgdmFyIE1TX1BFUl9TRUNPTkQgPSAxMDAwLAogICAgICBNU19QRVJfTUlOVVRFID0gNjAgKiBNU19QRVJfU0VDT05ELAogICAgICBNU19QRVJfSE9VUiA9IDYwICogTVNfUEVSX01JTlVURSwKICAgICAgTVNfUEVSXzQwMF9ZRUFSUyA9ICgzNjUgKiA0MDAgKyA5NykgKiAyNCAqIE1TX1BFUl9IT1VSOyAvLyBhY3R1YWwgbW9kdWxvIC0gaGFuZGxlcyBuZWdhdGl2ZSBudW1iZXJzIChmb3IgZGF0ZXMgYmVmb3JlIDE5NzApOgoKICBmdW5jdGlvbiBtb2QkMShkaXZpZGVuZCwgZGl2aXNvcikgewogICAgcmV0dXJuIChkaXZpZGVuZCAlIGRpdmlzb3IgKyBkaXZpc29yKSAlIGRpdmlzb3I7CiAgfQoKICBmdW5jdGlvbiBsb2NhbFN0YXJ0T2ZEYXRlKHksIG0sIGQpIHsKICAgIC8vIHRoZSBkYXRlIGNvbnN0cnVjdG9yIHJlbWFwcyB5ZWFycyAwLTk5IHRvIDE5MDAtMTk5OQogICAgaWYgKHkgPCAxMDAgJiYgeSA+PSAwKSB7CiAgICAgIC8vIHByZXNlcnZlIGxlYXAgeWVhcnMgdXNpbmcgYSBmdWxsIDQwMCB5ZWFyIGN5Y2xlLCB0aGVuIHJlc2V0CiAgICAgIHJldHVybiBuZXcgRGF0ZSh5ICsgNDAwLCBtLCBkKSAtIE1TX1BFUl80MDBfWUVBUlM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IERhdGUoeSwgbSwgZCkudmFsdWVPZigpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdXRjU3RhcnRPZkRhdGUoeSwgbSwgZCkgewogICAgLy8gRGF0ZS5VVEMgcmVtYXBzIHllYXJzIDAtOTkgdG8gMTkwMC0xOTk5CiAgICBpZiAoeSA8IDEwMCAmJiB5ID49IDApIHsKICAgICAgLy8gcHJlc2VydmUgbGVhcCB5ZWFycyB1c2luZyBhIGZ1bGwgNDAwIHllYXIgY3ljbGUsIHRoZW4gcmVzZXQKICAgICAgcmV0dXJuIERhdGUuVVRDKHkgKyA0MDAsIG0sIGQpIC0gTVNfUEVSXzQwMF9ZRUFSUzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBEYXRlLlVUQyh5LCBtLCBkKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHN0YXJ0T2YodW5pdHMpIHsKICAgIHZhciB0aW1lLCBzdGFydE9mRGF0ZTsKICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwoKICAgIGlmICh1bml0cyA9PT0gdW5kZWZpbmVkIHx8IHVuaXRzID09PSAnbWlsbGlzZWNvbmQnIHx8ICF0aGlzLmlzVmFsaWQoKSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICBzdGFydE9mRGF0ZSA9IHRoaXMuX2lzVVRDID8gdXRjU3RhcnRPZkRhdGUgOiBsb2NhbFN0YXJ0T2ZEYXRlOwoKICAgIHN3aXRjaCAodW5pdHMpIHsKICAgICAgY2FzZSAneWVhcic6CiAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCAwLCAxKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3F1YXJ0ZXInOgogICAgICAgIHRpbWUgPSBzdGFydE9mRGF0ZSh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpIC0gdGhpcy5tb250aCgpICUgMywgMSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdtb250aCc6CiAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIDEpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnd2Vlayc6CiAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIHRoaXMuZGF0ZSgpIC0gdGhpcy53ZWVrZGF5KCkpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnaXNvV2Vlayc6CiAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIHRoaXMuZGF0ZSgpIC0gKHRoaXMuaXNvV2Vla2RheSgpIC0gMSkpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnZGF5JzoKICAgICAgY2FzZSAnZGF0ZSc6CiAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIHRoaXMuZGF0ZSgpKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ2hvdXInOgogICAgICAgIHRpbWUgPSB0aGlzLl9kLnZhbHVlT2YoKTsKICAgICAgICB0aW1lIC09IG1vZCQxKHRpbWUgKyAodGhpcy5faXNVVEMgPyAwIDogdGhpcy51dGNPZmZzZXQoKSAqIE1TX1BFUl9NSU5VVEUpLCBNU19QRVJfSE9VUik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdtaW51dGUnOgogICAgICAgIHRpbWUgPSB0aGlzLl9kLnZhbHVlT2YoKTsKICAgICAgICB0aW1lIC09IG1vZCQxKHRpbWUsIE1TX1BFUl9NSU5VVEUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2Vjb25kJzoKICAgICAgICB0aW1lID0gdGhpcy5fZC52YWx1ZU9mKCk7CiAgICAgICAgdGltZSAtPSBtb2QkMSh0aW1lLCBNU19QRVJfU0VDT05EKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICB0aGlzLl9kLnNldFRpbWUodGltZSk7CgogICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMsIHRydWUpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBmdW5jdGlvbiBlbmRPZih1bml0cykgewogICAgdmFyIHRpbWUsIHN0YXJ0T2ZEYXRlOwogICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CgogICAgaWYgKHVuaXRzID09PSB1bmRlZmluZWQgfHwgdW5pdHMgPT09ICdtaWxsaXNlY29uZCcgfHwgIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIHN0YXJ0T2ZEYXRlID0gdGhpcy5faXNVVEMgPyB1dGNTdGFydE9mRGF0ZSA6IGxvY2FsU3RhcnRPZkRhdGU7CgogICAgc3dpdGNoICh1bml0cykgewogICAgICBjYXNlICd5ZWFyJzoKICAgICAgICB0aW1lID0gc3RhcnRPZkRhdGUodGhpcy55ZWFyKCkgKyAxLCAwLCAxKSAtIDE7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdxdWFydGVyJzoKICAgICAgICB0aW1lID0gc3RhcnRPZkRhdGUodGhpcy55ZWFyKCksIHRoaXMubW9udGgoKSAtIHRoaXMubW9udGgoKSAlIDMgKyAzLCAxKSAtIDE7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdtb250aCc6CiAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCkgKyAxLCAxKSAtIDE7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICd3ZWVrJzoKICAgICAgICB0aW1lID0gc3RhcnRPZkRhdGUodGhpcy55ZWFyKCksIHRoaXMubW9udGgoKSwgdGhpcy5kYXRlKCkgLSB0aGlzLndlZWtkYXkoKSArIDcpIC0gMTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ2lzb1dlZWsnOgogICAgICAgIHRpbWUgPSBzdGFydE9mRGF0ZSh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpLCB0aGlzLmRhdGUoKSAtICh0aGlzLmlzb1dlZWtkYXkoKSAtIDEpICsgNykgLSAxOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnZGF5JzoKICAgICAgY2FzZSAnZGF0ZSc6CiAgICAgICAgdGltZSA9IHN0YXJ0T2ZEYXRlKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCksIHRoaXMuZGF0ZSgpICsgMSkgLSAxOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnaG91cic6CiAgICAgICAgdGltZSA9IHRoaXMuX2QudmFsdWVPZigpOwogICAgICAgIHRpbWUgKz0gTVNfUEVSX0hPVVIgLSBtb2QkMSh0aW1lICsgKHRoaXMuX2lzVVRDID8gMCA6IHRoaXMudXRjT2Zmc2V0KCkgKiBNU19QRVJfTUlOVVRFKSwgTVNfUEVSX0hPVVIpIC0gMTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ21pbnV0ZSc6CiAgICAgICAgdGltZSA9IHRoaXMuX2QudmFsdWVPZigpOwogICAgICAgIHRpbWUgKz0gTVNfUEVSX01JTlVURSAtIG1vZCQxKHRpbWUsIE1TX1BFUl9NSU5VVEUpIC0gMTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NlY29uZCc6CiAgICAgICAgdGltZSA9IHRoaXMuX2QudmFsdWVPZigpOwogICAgICAgIHRpbWUgKz0gTVNfUEVSX1NFQ09ORCAtIG1vZCQxKHRpbWUsIE1TX1BFUl9TRUNPTkQpIC0gMTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICB0aGlzLl9kLnNldFRpbWUodGltZSk7CgogICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMsIHRydWUpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBmdW5jdGlvbiB2YWx1ZU9mKCkgewogICAgcmV0dXJuIHRoaXMuX2QudmFsdWVPZigpIC0gKHRoaXMuX29mZnNldCB8fCAwKSAqIDYwMDAwOwogIH0KCiAgZnVuY3Rpb24gdW5peCgpIHsKICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMudmFsdWVPZigpIC8gMTAwMCk7CiAgfQoKICBmdW5jdGlvbiB0b0RhdGUoKSB7CiAgICByZXR1cm4gbmV3IERhdGUodGhpcy52YWx1ZU9mKCkpOwogIH0KCiAgZnVuY3Rpb24gdG9BcnJheSgpIHsKICAgIHZhciBtID0gdGhpczsKICAgIHJldHVybiBbbS55ZWFyKCksIG0ubW9udGgoKSwgbS5kYXRlKCksIG0uaG91cigpLCBtLm1pbnV0ZSgpLCBtLnNlY29uZCgpLCBtLm1pbGxpc2Vjb25kKCldOwogIH0KCiAgZnVuY3Rpb24gdG9PYmplY3QoKSB7CiAgICB2YXIgbSA9IHRoaXM7CiAgICByZXR1cm4gewogICAgICB5ZWFyczogbS55ZWFyKCksCiAgICAgIG1vbnRoczogbS5tb250aCgpLAogICAgICBkYXRlOiBtLmRhdGUoKSwKICAgICAgaG91cnM6IG0uaG91cnMoKSwKICAgICAgbWludXRlczogbS5taW51dGVzKCksCiAgICAgIHNlY29uZHM6IG0uc2Vjb25kcygpLAogICAgICBtaWxsaXNlY29uZHM6IG0ubWlsbGlzZWNvbmRzKCkKICAgIH07CiAgfQoKICBmdW5jdGlvbiB0b0pTT04oKSB7CiAgICAvLyBuZXcgRGF0ZShOYU4pLnRvSlNPTigpID09PSBudWxsCiAgICByZXR1cm4gdGhpcy5pc1ZhbGlkKCkgPyB0aGlzLnRvSVNPU3RyaW5nKCkgOiBudWxsOwogIH0KCiAgZnVuY3Rpb24gaXNWYWxpZCQyKCkgewogICAgcmV0dXJuIGlzVmFsaWQodGhpcyk7CiAgfQoKICBmdW5jdGlvbiBwYXJzaW5nRmxhZ3MoKSB7CiAgICByZXR1cm4gZXh0ZW5kKHt9LCBnZXRQYXJzaW5nRmxhZ3ModGhpcykpOwogIH0KCiAgZnVuY3Rpb24gaW52YWxpZEF0KCkgewogICAgcmV0dXJuIGdldFBhcnNpbmdGbGFncyh0aGlzKS5vdmVyZmxvdzsKICB9CgogIGZ1bmN0aW9uIGNyZWF0aW9uRGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIGlucHV0OiB0aGlzLl9pLAogICAgICBmb3JtYXQ6IHRoaXMuX2YsCiAgICAgIGxvY2FsZTogdGhpcy5fbG9jYWxlLAogICAgICBpc1VUQzogdGhpcy5faXNVVEMsCiAgICAgIHN0cmljdDogdGhpcy5fc3RyaWN0CiAgICB9OwogIH0KCiAgYWRkRm9ybWF0VG9rZW4oJ04nLCAwLCAwLCAnZXJhQWJicicpOwogIGFkZEZvcm1hdFRva2VuKCdOTicsIDAsIDAsICdlcmFBYmJyJyk7CiAgYWRkRm9ybWF0VG9rZW4oJ05OTicsIDAsIDAsICdlcmFBYmJyJyk7CiAgYWRkRm9ybWF0VG9rZW4oJ05OTk4nLCAwLCAwLCAnZXJhTmFtZScpOwogIGFkZEZvcm1hdFRva2VuKCdOTk5OTicsIDAsIDAsICdlcmFOYXJyb3cnKTsKICBhZGRGb3JtYXRUb2tlbigneScsIFsneScsIDFdLCAneW8nLCAnZXJhWWVhcicpOwogIGFkZEZvcm1hdFRva2VuKCd5JywgWyd5eScsIDJdLCAwLCAnZXJhWWVhcicpOwogIGFkZEZvcm1hdFRva2VuKCd5JywgWyd5eXknLCAzXSwgMCwgJ2VyYVllYXInKTsKICBhZGRGb3JtYXRUb2tlbigneScsIFsneXl5eScsIDRdLCAwLCAnZXJhWWVhcicpOwogIGFkZFJlZ2V4VG9rZW4oJ04nLCBtYXRjaEVyYUFiYnIpOwogIGFkZFJlZ2V4VG9rZW4oJ05OJywgbWF0Y2hFcmFBYmJyKTsKICBhZGRSZWdleFRva2VuKCdOTk4nLCBtYXRjaEVyYUFiYnIpOwogIGFkZFJlZ2V4VG9rZW4oJ05OTk4nLCBtYXRjaEVyYU5hbWUpOwogIGFkZFJlZ2V4VG9rZW4oJ05OTk5OJywgbWF0Y2hFcmFOYXJyb3cpOwogIGFkZFBhcnNlVG9rZW4oWydOJywgJ05OJywgJ05OTicsICdOTk5OJywgJ05OTk5OJ10sIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZywgdG9rZW4pIHsKICAgIHZhciBlcmEgPSBjb25maWcuX2xvY2FsZS5lcmFzUGFyc2UoaW5wdXQsIHRva2VuLCBjb25maWcuX3N0cmljdCk7CgogICAgaWYgKGVyYSkgewogICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5lcmEgPSBlcmE7CiAgICB9IGVsc2UgewogICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5pbnZhbGlkRXJhID0gaW5wdXQ7CiAgICB9CiAgfSk7CiAgYWRkUmVnZXhUb2tlbigneScsIG1hdGNoVW5zaWduZWQpOwogIGFkZFJlZ2V4VG9rZW4oJ3l5JywgbWF0Y2hVbnNpZ25lZCk7CiAgYWRkUmVnZXhUb2tlbigneXl5JywgbWF0Y2hVbnNpZ25lZCk7CiAgYWRkUmVnZXhUb2tlbigneXl5eScsIG1hdGNoVW5zaWduZWQpOwogIGFkZFJlZ2V4VG9rZW4oJ3lvJywgbWF0Y2hFcmFZZWFyT3JkaW5hbCk7CiAgYWRkUGFyc2VUb2tlbihbJ3knLCAneXknLCAneXl5JywgJ3l5eXknXSwgWUVBUik7CiAgYWRkUGFyc2VUb2tlbihbJ3lvJ10sIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZywgdG9rZW4pIHsKICAgIHZhciBtYXRjaDsKCiAgICBpZiAoY29uZmlnLl9sb2NhbGUuX2VyYVllYXJPcmRpbmFsUmVnZXgpIHsKICAgICAgbWF0Y2ggPSBpbnB1dC5tYXRjaChjb25maWcuX2xvY2FsZS5fZXJhWWVhck9yZGluYWxSZWdleCk7CiAgICB9CgogICAgaWYgKGNvbmZpZy5fbG9jYWxlLmVyYVllYXJPcmRpbmFsUGFyc2UpIHsKICAgICAgYXJyYXlbWUVBUl0gPSBjb25maWcuX2xvY2FsZS5lcmFZZWFyT3JkaW5hbFBhcnNlKGlucHV0LCBtYXRjaCk7CiAgICB9IGVsc2UgewogICAgICBhcnJheVtZRUFSXSA9IHBhcnNlSW50KGlucHV0LCAxMCk7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIGxvY2FsZUVyYXMobSwgZm9ybWF0KSB7CiAgICB2YXIgaSwKICAgICAgICBsLAogICAgICAgIGRhdGUsCiAgICAgICAgZXJhcyA9IHRoaXMuX2VyYXMgfHwgZ2V0TG9jYWxlKCdlbicpLl9lcmFzOwoKICAgIGZvciAoaSA9IDAsIGwgPSBlcmFzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICBzd2l0Y2ggKF90eXBlb2YoZXJhc1tpXS5zaW5jZSkpIHsKICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgLy8gdHJ1bmNhdGUgdGltZQogICAgICAgICAgZGF0ZSA9IGhvb2tzKGVyYXNbaV0uc2luY2UpLnN0YXJ0T2YoJ2RheScpOwogICAgICAgICAgZXJhc1tpXS5zaW5jZSA9IGRhdGUudmFsdWVPZigpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIHN3aXRjaCAoX3R5cGVvZihlcmFzW2ldLnVudGlsKSkgewogICAgICAgIGNhc2UgJ3VuZGVmaW5lZCc6CiAgICAgICAgICBlcmFzW2ldLnVudGlsID0gK0luZmluaXR5OwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAvLyB0cnVuY2F0ZSB0aW1lCiAgICAgICAgICBkYXRlID0gaG9va3MoZXJhc1tpXS51bnRpbCkuc3RhcnRPZignZGF5JykudmFsdWVPZigpOwogICAgICAgICAgZXJhc1tpXS51bnRpbCA9IGRhdGUudmFsdWVPZigpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZXJhczsKICB9CgogIGZ1bmN0aW9uIGxvY2FsZUVyYXNQYXJzZShlcmFOYW1lLCBmb3JtYXQsIHN0cmljdCkgewogICAgdmFyIGksCiAgICAgICAgbCwKICAgICAgICBlcmFzID0gdGhpcy5lcmFzKCksCiAgICAgICAgbmFtZSwKICAgICAgICBhYmJyLAogICAgICAgIG5hcnJvdzsKICAgIGVyYU5hbWUgPSBlcmFOYW1lLnRvVXBwZXJDYXNlKCk7CgogICAgZm9yIChpID0gMCwgbCA9IGVyYXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgIG5hbWUgPSBlcmFzW2ldLm5hbWUudG9VcHBlckNhc2UoKTsKICAgICAgYWJiciA9IGVyYXNbaV0uYWJici50b1VwcGVyQ2FzZSgpOwogICAgICBuYXJyb3cgPSBlcmFzW2ldLm5hcnJvdy50b1VwcGVyQ2FzZSgpOwoKICAgICAgaWYgKHN0cmljdCkgewogICAgICAgIHN3aXRjaCAoZm9ybWF0KSB7CiAgICAgICAgICBjYXNlICdOJzoKICAgICAgICAgIGNhc2UgJ05OJzoKICAgICAgICAgIGNhc2UgJ05OTic6CiAgICAgICAgICAgIGlmIChhYmJyID09PSBlcmFOYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVyYXNbaV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgJ05OTk4nOgogICAgICAgICAgICBpZiAobmFtZSA9PT0gZXJhTmFtZSkgewogICAgICAgICAgICAgIHJldHVybiBlcmFzW2ldOwogICAgICAgICAgICB9CgogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlICdOTk5OTic6CiAgICAgICAgICAgIGlmIChuYXJyb3cgPT09IGVyYU5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZXJhc1tpXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKFtuYW1lLCBhYmJyLCBuYXJyb3ddLmluZGV4T2YoZXJhTmFtZSkgPj0gMCkgewogICAgICAgIHJldHVybiBlcmFzW2ldOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsb2NhbGVFcmFzQ29udmVydFllYXIoZXJhLCB5ZWFyKSB7CiAgICB2YXIgZGlyID0gZXJhLnNpbmNlIDw9IGVyYS51bnRpbCA/ICsxIDogLTE7CgogICAgaWYgKHllYXIgPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gaG9va3MoZXJhLnNpbmNlKS55ZWFyKCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaG9va3MoZXJhLnNpbmNlKS55ZWFyKCkgKyAoeWVhciAtIGVyYS5vZmZzZXQpICogZGlyOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0RXJhTmFtZSgpIHsKICAgIHZhciBpLAogICAgICAgIGwsCiAgICAgICAgdmFsLAogICAgICAgIGVyYXMgPSB0aGlzLmxvY2FsZURhdGEoKS5lcmFzKCk7CgogICAgZm9yIChpID0gMCwgbCA9IGVyYXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgIC8vIHRydW5jYXRlIHRpbWUKICAgICAgdmFsID0gdGhpcy5jbG9uZSgpLnN0YXJ0T2YoJ2RheScpLnZhbHVlT2YoKTsKCiAgICAgIGlmIChlcmFzW2ldLnNpbmNlIDw9IHZhbCAmJiB2YWwgPD0gZXJhc1tpXS51bnRpbCkgewogICAgICAgIHJldHVybiBlcmFzW2ldLm5hbWU7CiAgICAgIH0KCiAgICAgIGlmIChlcmFzW2ldLnVudGlsIDw9IHZhbCAmJiB2YWwgPD0gZXJhc1tpXS5zaW5jZSkgewogICAgICAgIHJldHVybiBlcmFzW2ldLm5hbWU7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gJyc7CiAgfQoKICBmdW5jdGlvbiBnZXRFcmFOYXJyb3coKSB7CiAgICB2YXIgaSwKICAgICAgICBsLAogICAgICAgIHZhbCwKICAgICAgICBlcmFzID0gdGhpcy5sb2NhbGVEYXRhKCkuZXJhcygpOwoKICAgIGZvciAoaSA9IDAsIGwgPSBlcmFzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAvLyB0cnVuY2F0ZSB0aW1lCiAgICAgIHZhbCA9IHRoaXMuY2xvbmUoKS5zdGFydE9mKCdkYXknKS52YWx1ZU9mKCk7CgogICAgICBpZiAoZXJhc1tpXS5zaW5jZSA8PSB2YWwgJiYgdmFsIDw9IGVyYXNbaV0udW50aWwpIHsKICAgICAgICByZXR1cm4gZXJhc1tpXS5uYXJyb3c7CiAgICAgIH0KCiAgICAgIGlmIChlcmFzW2ldLnVudGlsIDw9IHZhbCAmJiB2YWwgPD0gZXJhc1tpXS5zaW5jZSkgewogICAgICAgIHJldHVybiBlcmFzW2ldLm5hcnJvdzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiAnJzsKICB9CgogIGZ1bmN0aW9uIGdldEVyYUFiYnIoKSB7CiAgICB2YXIgaSwKICAgICAgICBsLAogICAgICAgIHZhbCwKICAgICAgICBlcmFzID0gdGhpcy5sb2NhbGVEYXRhKCkuZXJhcygpOwoKICAgIGZvciAoaSA9IDAsIGwgPSBlcmFzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAvLyB0cnVuY2F0ZSB0aW1lCiAgICAgIHZhbCA9IHRoaXMuY2xvbmUoKS5zdGFydE9mKCdkYXknKS52YWx1ZU9mKCk7CgogICAgICBpZiAoZXJhc1tpXS5zaW5jZSA8PSB2YWwgJiYgdmFsIDw9IGVyYXNbaV0udW50aWwpIHsKICAgICAgICByZXR1cm4gZXJhc1tpXS5hYmJyOwogICAgICB9CgogICAgICBpZiAoZXJhc1tpXS51bnRpbCA8PSB2YWwgJiYgdmFsIDw9IGVyYXNbaV0uc2luY2UpIHsKICAgICAgICByZXR1cm4gZXJhc1tpXS5hYmJyOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuICcnOwogIH0KCiAgZnVuY3Rpb24gZ2V0RXJhWWVhcigpIHsKICAgIHZhciBpLAogICAgICAgIGwsCiAgICAgICAgZGlyLAogICAgICAgIHZhbCwKICAgICAgICBlcmFzID0gdGhpcy5sb2NhbGVEYXRhKCkuZXJhcygpOwoKICAgIGZvciAoaSA9IDAsIGwgPSBlcmFzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICBkaXIgPSBlcmFzW2ldLnNpbmNlIDw9IGVyYXNbaV0udW50aWwgPyArMSA6IC0xOyAvLyB0cnVuY2F0ZSB0aW1lCgogICAgICB2YWwgPSB0aGlzLmNsb25lKCkuc3RhcnRPZignZGF5JykudmFsdWVPZigpOwoKICAgICAgaWYgKGVyYXNbaV0uc2luY2UgPD0gdmFsICYmIHZhbCA8PSBlcmFzW2ldLnVudGlsIHx8IGVyYXNbaV0udW50aWwgPD0gdmFsICYmIHZhbCA8PSBlcmFzW2ldLnNpbmNlKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLnllYXIoKSAtIGhvb2tzKGVyYXNbaV0uc2luY2UpLnllYXIoKSkgKiBkaXIgKyBlcmFzW2ldLm9mZnNldDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzLnllYXIoKTsKICB9CgogIGZ1bmN0aW9uIGVyYXNOYW1lUmVnZXgoaXNTdHJpY3QpIHsKICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX2VyYXNOYW1lUmVnZXgnKSkgewogICAgICBjb21wdXRlRXJhc1BhcnNlLmNhbGwodGhpcyk7CiAgICB9CgogICAgcmV0dXJuIGlzU3RyaWN0ID8gdGhpcy5fZXJhc05hbWVSZWdleCA6IHRoaXMuX2VyYXNSZWdleDsKICB9CgogIGZ1bmN0aW9uIGVyYXNBYmJyUmVnZXgoaXNTdHJpY3QpIHsKICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX2VyYXNBYmJyUmVnZXgnKSkgewogICAgICBjb21wdXRlRXJhc1BhcnNlLmNhbGwodGhpcyk7CiAgICB9CgogICAgcmV0dXJuIGlzU3RyaWN0ID8gdGhpcy5fZXJhc0FiYnJSZWdleCA6IHRoaXMuX2VyYXNSZWdleDsKICB9CgogIGZ1bmN0aW9uIGVyYXNOYXJyb3dSZWdleChpc1N0cmljdCkgewogICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfZXJhc05hcnJvd1JlZ2V4JykpIHsKICAgICAgY29tcHV0ZUVyYXNQYXJzZS5jYWxsKHRoaXMpOwogICAgfQoKICAgIHJldHVybiBpc1N0cmljdCA/IHRoaXMuX2VyYXNOYXJyb3dSZWdleCA6IHRoaXMuX2VyYXNSZWdleDsKICB9CgogIGZ1bmN0aW9uIG1hdGNoRXJhQWJicihpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLmVyYXNBYmJyUmVnZXgoaXNTdHJpY3QpOwogIH0KCiAgZnVuY3Rpb24gbWF0Y2hFcmFOYW1lKGlzU3RyaWN0LCBsb2NhbGUpIHsKICAgIHJldHVybiBsb2NhbGUuZXJhc05hbWVSZWdleChpc1N0cmljdCk7CiAgfQoKICBmdW5jdGlvbiBtYXRjaEVyYU5hcnJvdyhpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLmVyYXNOYXJyb3dSZWdleChpc1N0cmljdCk7CiAgfQoKICBmdW5jdGlvbiBtYXRjaEVyYVllYXJPcmRpbmFsKGlzU3RyaWN0LCBsb2NhbGUpIHsKICAgIHJldHVybiBsb2NhbGUuX2VyYVllYXJPcmRpbmFsUmVnZXggfHwgbWF0Y2hVbnNpZ25lZDsKICB9CgogIGZ1bmN0aW9uIGNvbXB1dGVFcmFzUGFyc2UoKSB7CiAgICB2YXIgYWJiclBpZWNlcyA9IFtdLAogICAgICAgIG5hbWVQaWVjZXMgPSBbXSwKICAgICAgICBuYXJyb3dQaWVjZXMgPSBbXSwKICAgICAgICBtaXhlZFBpZWNlcyA9IFtdLAogICAgICAgIGksCiAgICAgICAgbCwKICAgICAgICBlcmFzID0gdGhpcy5lcmFzKCk7CgogICAgZm9yIChpID0gMCwgbCA9IGVyYXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgIG5hbWVQaWVjZXMucHVzaChyZWdleEVzY2FwZShlcmFzW2ldLm5hbWUpKTsKICAgICAgYWJiclBpZWNlcy5wdXNoKHJlZ2V4RXNjYXBlKGVyYXNbaV0uYWJicikpOwogICAgICBuYXJyb3dQaWVjZXMucHVzaChyZWdleEVzY2FwZShlcmFzW2ldLm5hcnJvdykpOwogICAgICBtaXhlZFBpZWNlcy5wdXNoKHJlZ2V4RXNjYXBlKGVyYXNbaV0ubmFtZSkpOwogICAgICBtaXhlZFBpZWNlcy5wdXNoKHJlZ2V4RXNjYXBlKGVyYXNbaV0uYWJicikpOwogICAgICBtaXhlZFBpZWNlcy5wdXNoKHJlZ2V4RXNjYXBlKGVyYXNbaV0ubmFycm93KSk7CiAgICB9CgogICAgdGhpcy5fZXJhc1JlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgbWl4ZWRQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogICAgdGhpcy5fZXJhc05hbWVSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIG5hbWVQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogICAgdGhpcy5fZXJhc0FiYnJSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIGFiYnJQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogICAgdGhpcy5fZXJhc05hcnJvd1JlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgbmFycm93UGllY2VzLmpvaW4oJ3wnKSArICcpJywgJ2knKTsKICB9IC8vIEZPUk1BVFRJTkcKCgogIGFkZEZvcm1hdFRva2VuKDAsIFsnZ2cnLCAyXSwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMud2Vla1llYXIoKSAlIDEwMDsKICB9KTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ0dHJywgMl0sIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmlzb1dlZWtZZWFyKCkgJSAxMDA7CiAgfSk7CgogIGZ1bmN0aW9uIGFkZFdlZWtZZWFyRm9ybWF0VG9rZW4odG9rZW4sIGdldHRlcikgewogICAgYWRkRm9ybWF0VG9rZW4oMCwgW3Rva2VuLCB0b2tlbi5sZW5ndGhdLCAwLCBnZXR0ZXIpOwogIH0KCiAgYWRkV2Vla1llYXJGb3JtYXRUb2tlbignZ2dnZycsICd3ZWVrWWVhcicpOwogIGFkZFdlZWtZZWFyRm9ybWF0VG9rZW4oJ2dnZ2dnJywgJ3dlZWtZZWFyJyk7CiAgYWRkV2Vla1llYXJGb3JtYXRUb2tlbignR0dHRycsICdpc29XZWVrWWVhcicpOwogIGFkZFdlZWtZZWFyRm9ybWF0VG9rZW4oJ0dHR0dHJywgJ2lzb1dlZWtZZWFyJyk7IC8vIEFMSUFTRVMKCiAgYWRkVW5pdEFsaWFzKCd3ZWVrWWVhcicsICdnZycpOwogIGFkZFVuaXRBbGlhcygnaXNvV2Vla1llYXInLCAnR0cnKTsgLy8gUFJJT1JJVFkKCiAgYWRkVW5pdFByaW9yaXR5KCd3ZWVrWWVhcicsIDEpOwogIGFkZFVuaXRQcmlvcml0eSgnaXNvV2Vla1llYXInLCAxKTsgLy8gUEFSU0lORwoKICBhZGRSZWdleFRva2VuKCdHJywgbWF0Y2hTaWduZWQpOwogIGFkZFJlZ2V4VG9rZW4oJ2cnLCBtYXRjaFNpZ25lZCk7CiAgYWRkUmVnZXhUb2tlbignR0cnLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgYWRkUmVnZXhUb2tlbignZ2cnLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgYWRkUmVnZXhUb2tlbignR0dHRycsIG1hdGNoMXRvNCwgbWF0Y2g0KTsKICBhZGRSZWdleFRva2VuKCdnZ2dnJywgbWF0Y2gxdG80LCBtYXRjaDQpOwogIGFkZFJlZ2V4VG9rZW4oJ0dHR0dHJywgbWF0Y2gxdG82LCBtYXRjaDYpOwogIGFkZFJlZ2V4VG9rZW4oJ2dnZ2dnJywgbWF0Y2gxdG82LCBtYXRjaDYpOwogIGFkZFdlZWtQYXJzZVRva2VuKFsnZ2dnZycsICdnZ2dnZycsICdHR0dHJywgJ0dHR0dHJ10sIGZ1bmN0aW9uIChpbnB1dCwgd2VlaywgY29uZmlnLCB0b2tlbikgewogICAgd2Vla1t0b2tlbi5zdWJzdHIoMCwgMildID0gdG9JbnQoaW5wdXQpOwogIH0pOwogIGFkZFdlZWtQYXJzZVRva2VuKFsnZ2cnLCAnR0cnXSwgZnVuY3Rpb24gKGlucHV0LCB3ZWVrLCBjb25maWcsIHRva2VuKSB7CiAgICB3ZWVrW3Rva2VuXSA9IGhvb2tzLnBhcnNlVHdvRGlnaXRZZWFyKGlucHV0KTsKICB9KTsgLy8gTU9NRU5UUwoKICBmdW5jdGlvbiBnZXRTZXRXZWVrWWVhcihpbnB1dCkgewogICAgcmV0dXJuIGdldFNldFdlZWtZZWFySGVscGVyLmNhbGwodGhpcywgaW5wdXQsIHRoaXMud2VlaygpLCB0aGlzLndlZWtkYXkoKSwgdGhpcy5sb2NhbGVEYXRhKCkuX3dlZWsuZG93LCB0aGlzLmxvY2FsZURhdGEoKS5fd2Vlay5kb3kpOwogIH0KCiAgZnVuY3Rpb24gZ2V0U2V0SVNPV2Vla1llYXIoaW5wdXQpIHsKICAgIHJldHVybiBnZXRTZXRXZWVrWWVhckhlbHBlci5jYWxsKHRoaXMsIGlucHV0LCB0aGlzLmlzb1dlZWsoKSwgdGhpcy5pc29XZWVrZGF5KCksIDEsIDQpOwogIH0KCiAgZnVuY3Rpb24gZ2V0SVNPV2Vla3NJblllYXIoKSB7CiAgICByZXR1cm4gd2Vla3NJblllYXIodGhpcy55ZWFyKCksIDEsIDQpOwogIH0KCiAgZnVuY3Rpb24gZ2V0SVNPV2Vla3NJbklTT1dlZWtZZWFyKCkgewogICAgcmV0dXJuIHdlZWtzSW5ZZWFyKHRoaXMuaXNvV2Vla1llYXIoKSwgMSwgNCk7CiAgfQoKICBmdW5jdGlvbiBnZXRXZWVrc0luWWVhcigpIHsKICAgIHZhciB3ZWVrSW5mbyA9IHRoaXMubG9jYWxlRGF0YSgpLl93ZWVrOwoKICAgIHJldHVybiB3ZWVrc0luWWVhcih0aGlzLnllYXIoKSwgd2Vla0luZm8uZG93LCB3ZWVrSW5mby5kb3kpOwogIH0KCiAgZnVuY3Rpb24gZ2V0V2Vla3NJbldlZWtZZWFyKCkgewogICAgdmFyIHdlZWtJbmZvID0gdGhpcy5sb2NhbGVEYXRhKCkuX3dlZWs7CgogICAgcmV0dXJuIHdlZWtzSW5ZZWFyKHRoaXMud2Vla1llYXIoKSwgd2Vla0luZm8uZG93LCB3ZWVrSW5mby5kb3kpOwogIH0KCiAgZnVuY3Rpb24gZ2V0U2V0V2Vla1llYXJIZWxwZXIoaW5wdXQsIHdlZWssIHdlZWtkYXksIGRvdywgZG95KSB7CiAgICB2YXIgd2Vla3NUYXJnZXQ7CgogICAgaWYgKGlucHV0ID09IG51bGwpIHsKICAgICAgcmV0dXJuIHdlZWtPZlllYXIodGhpcywgZG93LCBkb3kpLnllYXI7CiAgICB9IGVsc2UgewogICAgICB3ZWVrc1RhcmdldCA9IHdlZWtzSW5ZZWFyKGlucHV0LCBkb3csIGRveSk7CgogICAgICBpZiAod2VlayA+IHdlZWtzVGFyZ2V0KSB7CiAgICAgICAgd2VlayA9IHdlZWtzVGFyZ2V0OwogICAgICB9CgogICAgICByZXR1cm4gc2V0V2Vla0FsbC5jYWxsKHRoaXMsIGlucHV0LCB3ZWVrLCB3ZWVrZGF5LCBkb3csIGRveSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXRXZWVrQWxsKHdlZWtZZWFyLCB3ZWVrLCB3ZWVrZGF5LCBkb3csIGRveSkgewogICAgdmFyIGRheU9mWWVhckRhdGEgPSBkYXlPZlllYXJGcm9tV2Vla3Mod2Vla1llYXIsIHdlZWssIHdlZWtkYXksIGRvdywgZG95KSwKICAgICAgICBkYXRlID0gY3JlYXRlVVRDRGF0ZShkYXlPZlllYXJEYXRhLnllYXIsIDAsIGRheU9mWWVhckRhdGEuZGF5T2ZZZWFyKTsKICAgIHRoaXMueWVhcihkYXRlLmdldFVUQ0Z1bGxZZWFyKCkpOwogICAgdGhpcy5tb250aChkYXRlLmdldFVUQ01vbnRoKCkpOwogICAgdGhpcy5kYXRlKGRhdGUuZ2V0VVRDRGF0ZSgpKTsKICAgIHJldHVybiB0aGlzOwogIH0gLy8gRk9STUFUVElORwoKCiAgYWRkRm9ybWF0VG9rZW4oJ1EnLCAwLCAnUW8nLCAncXVhcnRlcicpOyAvLyBBTElBU0VTCgogIGFkZFVuaXRBbGlhcygncXVhcnRlcicsICdRJyk7IC8vIFBSSU9SSVRZCgogIGFkZFVuaXRQcmlvcml0eSgncXVhcnRlcicsIDcpOyAvLyBQQVJTSU5HCgogIGFkZFJlZ2V4VG9rZW4oJ1EnLCBtYXRjaDEpOwogIGFkZFBhcnNlVG9rZW4oJ1EnLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICBhcnJheVtNT05USF0gPSAodG9JbnQoaW5wdXQpIC0gMSkgKiAzOwogIH0pOyAvLyBNT01FTlRTCgogIGZ1bmN0aW9uIGdldFNldFF1YXJ0ZXIoaW5wdXQpIHsKICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gTWF0aC5jZWlsKCh0aGlzLm1vbnRoKCkgKyAxKSAvIDMpIDogdGhpcy5tb250aCgoaW5wdXQgLSAxKSAqIDMgKyB0aGlzLm1vbnRoKCkgJSAzKTsKICB9IC8vIEZPUk1BVFRJTkcKCgogIGFkZEZvcm1hdFRva2VuKCdEJywgWydERCcsIDJdLCAnRG8nLCAnZGF0ZScpOyAvLyBBTElBU0VTCgogIGFkZFVuaXRBbGlhcygnZGF0ZScsICdEJyk7IC8vIFBSSU9SSVRZCgogIGFkZFVuaXRQcmlvcml0eSgnZGF0ZScsIDkpOyAvLyBQQVJTSU5HCgogIGFkZFJlZ2V4VG9rZW4oJ0QnLCBtYXRjaDF0bzIpOwogIGFkZFJlZ2V4VG9rZW4oJ0REJywgbWF0Y2gxdG8yLCBtYXRjaDIpOwogIGFkZFJlZ2V4VG9rZW4oJ0RvJywgZnVuY3Rpb24gKGlzU3RyaWN0LCBsb2NhbGUpIHsKICAgIC8vIFRPRE86IFJlbW92ZSAib3JkaW5hbFBhcnNlIiBmYWxsYmFjayBpbiBuZXh0IG1ham9yIHJlbGVhc2UuCiAgICByZXR1cm4gaXNTdHJpY3QgPyBsb2NhbGUuX2RheU9mTW9udGhPcmRpbmFsUGFyc2UgfHwgbG9jYWxlLl9vcmRpbmFsUGFyc2UgOiBsb2NhbGUuX2RheU9mTW9udGhPcmRpbmFsUGFyc2VMZW5pZW50OwogIH0pOwogIGFkZFBhcnNlVG9rZW4oWydEJywgJ0REJ10sIERBVEUpOwogIGFkZFBhcnNlVG9rZW4oJ0RvJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSkgewogICAgYXJyYXlbREFURV0gPSB0b0ludChpbnB1dC5tYXRjaChtYXRjaDF0bzIpWzBdKTsKICB9KTsgLy8gTU9NRU5UUwoKICB2YXIgZ2V0U2V0RGF5T2ZNb250aCA9IG1ha2VHZXRTZXQoJ0RhdGUnLCB0cnVlKTsgLy8gRk9STUFUVElORwoKICBhZGRGb3JtYXRUb2tlbignREREJywgWydEREREJywgM10sICdERERvJywgJ2RheU9mWWVhcicpOyAvLyBBTElBU0VTCgogIGFkZFVuaXRBbGlhcygnZGF5T2ZZZWFyJywgJ0RERCcpOyAvLyBQUklPUklUWQoKICBhZGRVbml0UHJpb3JpdHkoJ2RheU9mWWVhcicsIDQpOyAvLyBQQVJTSU5HCgogIGFkZFJlZ2V4VG9rZW4oJ0RERCcsIG1hdGNoMXRvMyk7CiAgYWRkUmVnZXhUb2tlbignRERERCcsIG1hdGNoMyk7CiAgYWRkUGFyc2VUb2tlbihbJ0RERCcsICdEREREJ10sIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgY29uZmlnLl9kYXlPZlllYXIgPSB0b0ludChpbnB1dCk7CiAgfSk7IC8vIEhFTFBFUlMKICAvLyBNT01FTlRTCgogIGZ1bmN0aW9uIGdldFNldERheU9mWWVhcihpbnB1dCkgewogICAgdmFyIGRheU9mWWVhciA9IE1hdGgucm91bmQoKHRoaXMuY2xvbmUoKS5zdGFydE9mKCdkYXknKSAtIHRoaXMuY2xvbmUoKS5zdGFydE9mKCd5ZWFyJykpIC8gODY0ZTUpICsgMTsKICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gZGF5T2ZZZWFyIDogdGhpcy5hZGQoaW5wdXQgLSBkYXlPZlllYXIsICdkJyk7CiAgfSAvLyBGT1JNQVRUSU5HCgoKICBhZGRGb3JtYXRUb2tlbignbScsIFsnbW0nLCAyXSwgMCwgJ21pbnV0ZScpOyAvLyBBTElBU0VTCgogIGFkZFVuaXRBbGlhcygnbWludXRlJywgJ20nKTsgLy8gUFJJT1JJVFkKCiAgYWRkVW5pdFByaW9yaXR5KCdtaW51dGUnLCAxNCk7IC8vIFBBUlNJTkcKCiAgYWRkUmVnZXhUb2tlbignbScsIG1hdGNoMXRvMik7CiAgYWRkUmVnZXhUb2tlbignbW0nLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgYWRkUGFyc2VUb2tlbihbJ20nLCAnbW0nXSwgTUlOVVRFKTsgLy8gTU9NRU5UUwoKICB2YXIgZ2V0U2V0TWludXRlID0gbWFrZUdldFNldCgnTWludXRlcycsIGZhbHNlKTsgLy8gRk9STUFUVElORwoKICBhZGRGb3JtYXRUb2tlbigncycsIFsnc3MnLCAyXSwgMCwgJ3NlY29uZCcpOyAvLyBBTElBU0VTCgogIGFkZFVuaXRBbGlhcygnc2Vjb25kJywgJ3MnKTsgLy8gUFJJT1JJVFkKCiAgYWRkVW5pdFByaW9yaXR5KCdzZWNvbmQnLCAxNSk7IC8vIFBBUlNJTkcKCiAgYWRkUmVnZXhUb2tlbigncycsIG1hdGNoMXRvMik7CiAgYWRkUmVnZXhUb2tlbignc3MnLCBtYXRjaDF0bzIsIG1hdGNoMik7CiAgYWRkUGFyc2VUb2tlbihbJ3MnLCAnc3MnXSwgU0VDT05EKTsgLy8gTU9NRU5UUwoKICB2YXIgZ2V0U2V0U2Vjb25kID0gbWFrZUdldFNldCgnU2Vjb25kcycsIGZhbHNlKTsgLy8gRk9STUFUVElORwoKICBhZGRGb3JtYXRUb2tlbignUycsIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB+fih0aGlzLm1pbGxpc2Vjb25kKCkgLyAxMDApOwogIH0pOwogIGFkZEZvcm1hdFRva2VuKDAsIFsnU1MnLCAyXSwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIH5+KHRoaXMubWlsbGlzZWNvbmQoKSAvIDEwKTsKICB9KTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ1NTUycsIDNdLCAwLCAnbWlsbGlzZWNvbmQnKTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ1NTU1MnLCA0XSwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMubWlsbGlzZWNvbmQoKSAqIDEwOwogIH0pOwogIGFkZEZvcm1hdFRva2VuKDAsIFsnU1NTU1MnLCA1XSwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMubWlsbGlzZWNvbmQoKSAqIDEwMDsKICB9KTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ1NTU1NTUycsIDZdLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTAwMDsKICB9KTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ1NTU1NTU1MnLCA3XSwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMubWlsbGlzZWNvbmQoKSAqIDEwMDAwOwogIH0pOwogIGFkZEZvcm1hdFRva2VuKDAsIFsnU1NTU1NTU1MnLCA4XSwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMubWlsbGlzZWNvbmQoKSAqIDEwMDAwMDsKICB9KTsKICBhZGRGb3JtYXRUb2tlbigwLCBbJ1NTU1NTU1NTUycsIDldLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTAwMDAwMDsKICB9KTsgLy8gQUxJQVNFUwoKICBhZGRVbml0QWxpYXMoJ21pbGxpc2Vjb25kJywgJ21zJyk7IC8vIFBSSU9SSVRZCgogIGFkZFVuaXRQcmlvcml0eSgnbWlsbGlzZWNvbmQnLCAxNik7IC8vIFBBUlNJTkcKCiAgYWRkUmVnZXhUb2tlbignUycsIG1hdGNoMXRvMywgbWF0Y2gxKTsKICBhZGRSZWdleFRva2VuKCdTUycsIG1hdGNoMXRvMywgbWF0Y2gyKTsKICBhZGRSZWdleFRva2VuKCdTU1MnLCBtYXRjaDF0bzMsIG1hdGNoMyk7CiAgdmFyIHRva2VuLCBnZXRTZXRNaWxsaXNlY29uZDsKCiAgZm9yICh0b2tlbiA9ICdTU1NTJzsgdG9rZW4ubGVuZ3RoIDw9IDk7IHRva2VuICs9ICdTJykgewogICAgYWRkUmVnZXhUb2tlbih0b2tlbiwgbWF0Y2hVbnNpZ25lZCk7CiAgfQoKICBmdW5jdGlvbiBwYXJzZU1zKGlucHV0LCBhcnJheSkgewogICAgYXJyYXlbTUlMTElTRUNPTkRdID0gdG9JbnQoKCcwLicgKyBpbnB1dCkgKiAxMDAwKTsKICB9CgogIGZvciAodG9rZW4gPSAnUyc7IHRva2VuLmxlbmd0aCA8PSA5OyB0b2tlbiArPSAnUycpIHsKICAgIGFkZFBhcnNlVG9rZW4odG9rZW4sIHBhcnNlTXMpOwogIH0KCiAgZ2V0U2V0TWlsbGlzZWNvbmQgPSBtYWtlR2V0U2V0KCdNaWxsaXNlY29uZHMnLCBmYWxzZSk7IC8vIEZPUk1BVFRJTkcKCiAgYWRkRm9ybWF0VG9rZW4oJ3onLCAwLCAwLCAnem9uZUFiYnInKTsKICBhZGRGb3JtYXRUb2tlbignenonLCAwLCAwLCAnem9uZU5hbWUnKTsgLy8gTU9NRU5UUwoKICBmdW5jdGlvbiBnZXRab25lQWJicigpIHsKICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICdVVEMnIDogJyc7CiAgfQoKICBmdW5jdGlvbiBnZXRab25lTmFtZSgpIHsKICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICdDb29yZGluYXRlZCBVbml2ZXJzYWwgVGltZScgOiAnJzsKICB9CgogIHZhciBwcm90byA9IE1vbWVudC5wcm90b3R5cGU7CiAgcHJvdG8uYWRkID0gYWRkOwogIHByb3RvLmNhbGVuZGFyID0gY2FsZW5kYXIkMTsKICBwcm90by5jbG9uZSA9IGNsb25lOwogIHByb3RvLmRpZmYgPSBkaWZmOwogIHByb3RvLmVuZE9mID0gZW5kT2Y7CiAgcHJvdG8uZm9ybWF0ID0gZm9ybWF0OwogIHByb3RvLmZyb20gPSBmcm9tOwogIHByb3RvLmZyb21Ob3cgPSBmcm9tTm93OwogIHByb3RvLnRvID0gdG87CiAgcHJvdG8udG9Ob3cgPSB0b05vdzsKICBwcm90by5nZXQgPSBzdHJpbmdHZXQ7CiAgcHJvdG8uaW52YWxpZEF0ID0gaW52YWxpZEF0OwogIHByb3RvLmlzQWZ0ZXIgPSBpc0FmdGVyOwogIHByb3RvLmlzQmVmb3JlID0gaXNCZWZvcmU7CiAgcHJvdG8uaXNCZXR3ZWVuID0gaXNCZXR3ZWVuOwogIHByb3RvLmlzU2FtZSA9IGlzU2FtZTsKICBwcm90by5pc1NhbWVPckFmdGVyID0gaXNTYW1lT3JBZnRlcjsKICBwcm90by5pc1NhbWVPckJlZm9yZSA9IGlzU2FtZU9yQmVmb3JlOwogIHByb3RvLmlzVmFsaWQgPSBpc1ZhbGlkJDI7CiAgcHJvdG8ubGFuZyA9IGxhbmc7CiAgcHJvdG8ubG9jYWxlID0gbG9jYWxlOwogIHByb3RvLmxvY2FsZURhdGEgPSBsb2NhbGVEYXRhOwogIHByb3RvLm1heCA9IHByb3RvdHlwZU1heDsKICBwcm90by5taW4gPSBwcm90b3R5cGVNaW47CiAgcHJvdG8ucGFyc2luZ0ZsYWdzID0gcGFyc2luZ0ZsYWdzOwogIHByb3RvLnNldCA9IHN0cmluZ1NldDsKICBwcm90by5zdGFydE9mID0gc3RhcnRPZjsKICBwcm90by5zdWJ0cmFjdCA9IHN1YnRyYWN0OwogIHByb3RvLnRvQXJyYXkgPSB0b0FycmF5OwogIHByb3RvLnRvT2JqZWN0ID0gdG9PYmplY3Q7CiAgcHJvdG8udG9EYXRlID0gdG9EYXRlOwogIHByb3RvLnRvSVNPU3RyaW5nID0gdG9JU09TdHJpbmc7CiAgcHJvdG8uaW5zcGVjdCA9IGluc3BlY3Q7CgogIGlmICh0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBTeW1ib2wuZm9yICE9IG51bGwpIHsKICAgIHByb3RvW1N5bWJvbC5mb3IoJ25vZGVqcy51dGlsLmluc3BlY3QuY3VzdG9tJyldID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gJ01vbWVudDwnICsgdGhpcy5mb3JtYXQoKSArICc+JzsKICAgIH07CiAgfQoKICBwcm90by50b0pTT04gPSB0b0pTT047CiAgcHJvdG8udG9TdHJpbmcgPSB0b1N0cmluZzsKICBwcm90by51bml4ID0gdW5peDsKICBwcm90by52YWx1ZU9mID0gdmFsdWVPZjsKICBwcm90by5jcmVhdGlvbkRhdGEgPSBjcmVhdGlvbkRhdGE7CiAgcHJvdG8uZXJhTmFtZSA9IGdldEVyYU5hbWU7CiAgcHJvdG8uZXJhTmFycm93ID0gZ2V0RXJhTmFycm93OwogIHByb3RvLmVyYUFiYnIgPSBnZXRFcmFBYmJyOwogIHByb3RvLmVyYVllYXIgPSBnZXRFcmFZZWFyOwogIHByb3RvLnllYXIgPSBnZXRTZXRZZWFyOwogIHByb3RvLmlzTGVhcFllYXIgPSBnZXRJc0xlYXBZZWFyOwogIHByb3RvLndlZWtZZWFyID0gZ2V0U2V0V2Vla1llYXI7CiAgcHJvdG8uaXNvV2Vla1llYXIgPSBnZXRTZXRJU09XZWVrWWVhcjsKICBwcm90by5xdWFydGVyID0gcHJvdG8ucXVhcnRlcnMgPSBnZXRTZXRRdWFydGVyOwogIHByb3RvLm1vbnRoID0gZ2V0U2V0TW9udGg7CiAgcHJvdG8uZGF5c0luTW9udGggPSBnZXREYXlzSW5Nb250aDsKICBwcm90by53ZWVrID0gcHJvdG8ud2Vla3MgPSBnZXRTZXRXZWVrOwogIHByb3RvLmlzb1dlZWsgPSBwcm90by5pc29XZWVrcyA9IGdldFNldElTT1dlZWs7CiAgcHJvdG8ud2Vla3NJblllYXIgPSBnZXRXZWVrc0luWWVhcjsKICBwcm90by53ZWVrc0luV2Vla1llYXIgPSBnZXRXZWVrc0luV2Vla1llYXI7CiAgcHJvdG8uaXNvV2Vla3NJblllYXIgPSBnZXRJU09XZWVrc0luWWVhcjsKICBwcm90by5pc29XZWVrc0luSVNPV2Vla1llYXIgPSBnZXRJU09XZWVrc0luSVNPV2Vla1llYXI7CiAgcHJvdG8uZGF0ZSA9IGdldFNldERheU9mTW9udGg7CiAgcHJvdG8uZGF5ID0gcHJvdG8uZGF5cyA9IGdldFNldERheU9mV2VlazsKICBwcm90by53ZWVrZGF5ID0gZ2V0U2V0TG9jYWxlRGF5T2ZXZWVrOwogIHByb3RvLmlzb1dlZWtkYXkgPSBnZXRTZXRJU09EYXlPZldlZWs7CiAgcHJvdG8uZGF5T2ZZZWFyID0gZ2V0U2V0RGF5T2ZZZWFyOwogIHByb3RvLmhvdXIgPSBwcm90by5ob3VycyA9IGdldFNldEhvdXI7CiAgcHJvdG8ubWludXRlID0gcHJvdG8ubWludXRlcyA9IGdldFNldE1pbnV0ZTsKICBwcm90by5zZWNvbmQgPSBwcm90by5zZWNvbmRzID0gZ2V0U2V0U2Vjb25kOwogIHByb3RvLm1pbGxpc2Vjb25kID0gcHJvdG8ubWlsbGlzZWNvbmRzID0gZ2V0U2V0TWlsbGlzZWNvbmQ7CiAgcHJvdG8udXRjT2Zmc2V0ID0gZ2V0U2V0T2Zmc2V0OwogIHByb3RvLnV0YyA9IHNldE9mZnNldFRvVVRDOwogIHByb3RvLmxvY2FsID0gc2V0T2Zmc2V0VG9Mb2NhbDsKICBwcm90by5wYXJzZVpvbmUgPSBzZXRPZmZzZXRUb1BhcnNlZE9mZnNldDsKICBwcm90by5oYXNBbGlnbmVkSG91ck9mZnNldCA9IGhhc0FsaWduZWRIb3VyT2Zmc2V0OwogIHByb3RvLmlzRFNUID0gaXNEYXlsaWdodFNhdmluZ1RpbWU7CiAgcHJvdG8uaXNMb2NhbCA9IGlzTG9jYWw7CiAgcHJvdG8uaXNVdGNPZmZzZXQgPSBpc1V0Y09mZnNldDsKICBwcm90by5pc1V0YyA9IGlzVXRjOwogIHByb3RvLmlzVVRDID0gaXNVdGM7CiAgcHJvdG8uem9uZUFiYnIgPSBnZXRab25lQWJicjsKICBwcm90by56b25lTmFtZSA9IGdldFpvbmVOYW1lOwogIHByb3RvLmRhdGVzID0gZGVwcmVjYXRlKCdkYXRlcyBhY2Nlc3NvciBpcyBkZXByZWNhdGVkLiBVc2UgZGF0ZSBpbnN0ZWFkLicsIGdldFNldERheU9mTW9udGgpOwogIHByb3RvLm1vbnRocyA9IGRlcHJlY2F0ZSgnbW9udGhzIGFjY2Vzc29yIGlzIGRlcHJlY2F0ZWQuIFVzZSBtb250aCBpbnN0ZWFkJywgZ2V0U2V0TW9udGgpOwogIHByb3RvLnllYXJzID0gZGVwcmVjYXRlKCd5ZWFycyBhY2Nlc3NvciBpcyBkZXByZWNhdGVkLiBVc2UgeWVhciBpbnN0ZWFkJywgZ2V0U2V0WWVhcik7CiAgcHJvdG8uem9uZSA9IGRlcHJlY2F0ZSgnbW9tZW50KCkuem9uZSBpcyBkZXByZWNhdGVkLCB1c2UgbW9tZW50KCkudXRjT2Zmc2V0IGluc3RlYWQuIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3Mvem9uZS8nLCBnZXRTZXRab25lKTsKICBwcm90by5pc0RTVFNoaWZ0ZWQgPSBkZXByZWNhdGUoJ2lzRFNUU2hpZnRlZCBpcyBkZXByZWNhdGVkLiBTZWUgaHR0cDovL21vbWVudGpzLmNvbS9ndWlkZXMvIy93YXJuaW5ncy9kc3Qtc2hpZnRlZC8gZm9yIG1vcmUgaW5mb3JtYXRpb24nLCBpc0RheWxpZ2h0U2F2aW5nVGltZVNoaWZ0ZWQpOwoKICBmdW5jdGlvbiBjcmVhdGVVbml4KGlucHV0KSB7CiAgICByZXR1cm4gY3JlYXRlTG9jYWwoaW5wdXQgKiAxMDAwKTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUluWm9uZSgpIHsKICAgIHJldHVybiBjcmVhdGVMb2NhbC5hcHBseShudWxsLCBhcmd1bWVudHMpLnBhcnNlWm9uZSgpOwogIH0KCiAgZnVuY3Rpb24gcHJlUGFyc2VQb3N0Rm9ybWF0KHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZzsKICB9CgogIHZhciBwcm90byQxID0gTG9jYWxlLnByb3RvdHlwZTsKICBwcm90byQxLmNhbGVuZGFyID0gY2FsZW5kYXI7CiAgcHJvdG8kMS5sb25nRGF0ZUZvcm1hdCA9IGxvbmdEYXRlRm9ybWF0OwogIHByb3RvJDEuaW52YWxpZERhdGUgPSBpbnZhbGlkRGF0ZTsKICBwcm90byQxLm9yZGluYWwgPSBvcmRpbmFsOwogIHByb3RvJDEucHJlcGFyc2UgPSBwcmVQYXJzZVBvc3RGb3JtYXQ7CiAgcHJvdG8kMS5wb3N0Zm9ybWF0ID0gcHJlUGFyc2VQb3N0Rm9ybWF0OwogIHByb3RvJDEucmVsYXRpdmVUaW1lID0gcmVsYXRpdmVUaW1lOwogIHByb3RvJDEucGFzdEZ1dHVyZSA9IHBhc3RGdXR1cmU7CiAgcHJvdG8kMS5zZXQgPSBzZXQ7CiAgcHJvdG8kMS5lcmFzID0gbG9jYWxlRXJhczsKICBwcm90byQxLmVyYXNQYXJzZSA9IGxvY2FsZUVyYXNQYXJzZTsKICBwcm90byQxLmVyYXNDb252ZXJ0WWVhciA9IGxvY2FsZUVyYXNDb252ZXJ0WWVhcjsKICBwcm90byQxLmVyYXNBYmJyUmVnZXggPSBlcmFzQWJiclJlZ2V4OwogIHByb3RvJDEuZXJhc05hbWVSZWdleCA9IGVyYXNOYW1lUmVnZXg7CiAgcHJvdG8kMS5lcmFzTmFycm93UmVnZXggPSBlcmFzTmFycm93UmVnZXg7CiAgcHJvdG8kMS5tb250aHMgPSBsb2NhbGVNb250aHM7CiAgcHJvdG8kMS5tb250aHNTaG9ydCA9IGxvY2FsZU1vbnRoc1Nob3J0OwogIHByb3RvJDEubW9udGhzUGFyc2UgPSBsb2NhbGVNb250aHNQYXJzZTsKICBwcm90byQxLm1vbnRoc1JlZ2V4ID0gbW9udGhzUmVnZXg7CiAgcHJvdG8kMS5tb250aHNTaG9ydFJlZ2V4ID0gbW9udGhzU2hvcnRSZWdleDsKICBwcm90byQxLndlZWsgPSBsb2NhbGVXZWVrOwogIHByb3RvJDEuZmlyc3REYXlPZlllYXIgPSBsb2NhbGVGaXJzdERheU9mWWVhcjsKICBwcm90byQxLmZpcnN0RGF5T2ZXZWVrID0gbG9jYWxlRmlyc3REYXlPZldlZWs7CiAgcHJvdG8kMS53ZWVrZGF5cyA9IGxvY2FsZVdlZWtkYXlzOwogIHByb3RvJDEud2Vla2RheXNNaW4gPSBsb2NhbGVXZWVrZGF5c01pbjsKICBwcm90byQxLndlZWtkYXlzU2hvcnQgPSBsb2NhbGVXZWVrZGF5c1Nob3J0OwogIHByb3RvJDEud2Vla2RheXNQYXJzZSA9IGxvY2FsZVdlZWtkYXlzUGFyc2U7CiAgcHJvdG8kMS53ZWVrZGF5c1JlZ2V4ID0gd2Vla2RheXNSZWdleDsKICBwcm90byQxLndlZWtkYXlzU2hvcnRSZWdleCA9IHdlZWtkYXlzU2hvcnRSZWdleDsKICBwcm90byQxLndlZWtkYXlzTWluUmVnZXggPSB3ZWVrZGF5c01pblJlZ2V4OwogIHByb3RvJDEuaXNQTSA9IGxvY2FsZUlzUE07CiAgcHJvdG8kMS5tZXJpZGllbSA9IGxvY2FsZU1lcmlkaWVtOwoKICBmdW5jdGlvbiBnZXQkMShmb3JtYXQsIGluZGV4LCBmaWVsZCwgc2V0dGVyKSB7CiAgICB2YXIgbG9jYWxlID0gZ2V0TG9jYWxlKCksCiAgICAgICAgdXRjID0gY3JlYXRlVVRDKCkuc2V0KHNldHRlciwgaW5kZXgpOwogICAgcmV0dXJuIGxvY2FsZVtmaWVsZF0odXRjLCBmb3JtYXQpOwogIH0KCiAgZnVuY3Rpb24gbGlzdE1vbnRoc0ltcGwoZm9ybWF0LCBpbmRleCwgZmllbGQpIHsKICAgIGlmIChpc051bWJlcihmb3JtYXQpKSB7CiAgICAgIGluZGV4ID0gZm9ybWF0OwogICAgICBmb3JtYXQgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgZm9ybWF0ID0gZm9ybWF0IHx8ICcnOwoKICAgIGlmIChpbmRleCAhPSBudWxsKSB7CiAgICAgIHJldHVybiBnZXQkMShmb3JtYXQsIGluZGV4LCBmaWVsZCwgJ21vbnRoJyk7CiAgICB9CgogICAgdmFyIGksCiAgICAgICAgb3V0ID0gW107CgogICAgZm9yIChpID0gMDsgaSA8IDEyOyBpKyspIHsKICAgICAgb3V0W2ldID0gZ2V0JDEoZm9ybWF0LCBpLCBmaWVsZCwgJ21vbnRoJyk7CiAgICB9CgogICAgcmV0dXJuIG91dDsKICB9IC8vICgpCiAgLy8gKDUpCiAgLy8gKGZtdCwgNSkKICAvLyAoZm10KQogIC8vICh0cnVlKQogIC8vICh0cnVlLCA1KQogIC8vICh0cnVlLCBmbXQsIDUpCiAgLy8gKHRydWUsIGZtdCkKCgogIGZ1bmN0aW9uIGxpc3RXZWVrZGF5c0ltcGwobG9jYWxlU29ydGVkLCBmb3JtYXQsIGluZGV4LCBmaWVsZCkgewogICAgaWYgKHR5cGVvZiBsb2NhbGVTb3J0ZWQgPT09ICdib29sZWFuJykgewogICAgICBpZiAoaXNOdW1iZXIoZm9ybWF0KSkgewogICAgICAgIGluZGV4ID0gZm9ybWF0OwogICAgICAgIGZvcm1hdCA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgZm9ybWF0ID0gZm9ybWF0IHx8ICcnOwogICAgfSBlbHNlIHsKICAgICAgZm9ybWF0ID0gbG9jYWxlU29ydGVkOwogICAgICBpbmRleCA9IGZvcm1hdDsKICAgICAgbG9jYWxlU29ydGVkID0gZmFsc2U7CgogICAgICBpZiAoaXNOdW1iZXIoZm9ybWF0KSkgewogICAgICAgIGluZGV4ID0gZm9ybWF0OwogICAgICAgIGZvcm1hdCA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgZm9ybWF0ID0gZm9ybWF0IHx8ICcnOwogICAgfQoKICAgIHZhciBsb2NhbGUgPSBnZXRMb2NhbGUoKSwKICAgICAgICBzaGlmdCA9IGxvY2FsZVNvcnRlZCA/IGxvY2FsZS5fd2Vlay5kb3cgOiAwLAogICAgICAgIGksCiAgICAgICAgb3V0ID0gW107CgogICAgaWYgKGluZGV4ICE9IG51bGwpIHsKICAgICAgcmV0dXJuIGdldCQxKGZvcm1hdCwgKGluZGV4ICsgc2hpZnQpICUgNywgZmllbGQsICdkYXknKTsKICAgIH0KCiAgICBmb3IgKGkgPSAwOyBpIDwgNzsgaSsrKSB7CiAgICAgIG91dFtpXSA9IGdldCQxKGZvcm1hdCwgKGkgKyBzaGlmdCkgJSA3LCBmaWVsZCwgJ2RheScpOwogICAgfQoKICAgIHJldHVybiBvdXQ7CiAgfQoKICBmdW5jdGlvbiBsaXN0TW9udGhzKGZvcm1hdCwgaW5kZXgpIHsKICAgIHJldHVybiBsaXN0TW9udGhzSW1wbChmb3JtYXQsIGluZGV4LCAnbW9udGhzJyk7CiAgfQoKICBmdW5jdGlvbiBsaXN0TW9udGhzU2hvcnQoZm9ybWF0LCBpbmRleCkgewogICAgcmV0dXJuIGxpc3RNb250aHNJbXBsKGZvcm1hdCwgaW5kZXgsICdtb250aHNTaG9ydCcpOwogIH0KCiAgZnVuY3Rpb24gbGlzdFdlZWtkYXlzKGxvY2FsZVNvcnRlZCwgZm9ybWF0LCBpbmRleCkgewogICAgcmV0dXJuIGxpc3RXZWVrZGF5c0ltcGwobG9jYWxlU29ydGVkLCBmb3JtYXQsIGluZGV4LCAnd2Vla2RheXMnKTsKICB9CgogIGZ1bmN0aW9uIGxpc3RXZWVrZGF5c1Nob3J0KGxvY2FsZVNvcnRlZCwgZm9ybWF0LCBpbmRleCkgewogICAgcmV0dXJuIGxpc3RXZWVrZGF5c0ltcGwobG9jYWxlU29ydGVkLCBmb3JtYXQsIGluZGV4LCAnd2Vla2RheXNTaG9ydCcpOwogIH0KCiAgZnVuY3Rpb24gbGlzdFdlZWtkYXlzTWluKGxvY2FsZVNvcnRlZCwgZm9ybWF0LCBpbmRleCkgewogICAgcmV0dXJuIGxpc3RXZWVrZGF5c0ltcGwobG9jYWxlU29ydGVkLCBmb3JtYXQsIGluZGV4LCAnd2Vla2RheXNNaW4nKTsKICB9CgogIGdldFNldEdsb2JhbExvY2FsZSgnZW4nLCB7CiAgICBlcmFzOiBbewogICAgICBzaW5jZTogJzAwMDEtMDEtMDEnLAogICAgICB1bnRpbDogK0luZmluaXR5LAogICAgICBvZmZzZXQ6IDEsCiAgICAgIG5hbWU6ICdBbm5vIERvbWluaScsCiAgICAgIG5hcnJvdzogJ0FEJywKICAgICAgYWJicjogJ0FEJwogICAgfSwgewogICAgICBzaW5jZTogJzAwMDAtMTItMzEnLAogICAgICB1bnRpbDogLUluZmluaXR5LAogICAgICBvZmZzZXQ6IDEsCiAgICAgIG5hbWU6ICdCZWZvcmUgQ2hyaXN0JywKICAgICAgbmFycm93OiAnQkMnLAogICAgICBhYmJyOiAnQkMnCiAgICB9XSwKICAgIGRheU9mTW9udGhPcmRpbmFsUGFyc2U6IC9cZHsxLDJ9KHRofHN0fG5kfHJkKS8sCiAgICBvcmRpbmFsOiBmdW5jdGlvbiBvcmRpbmFsKG51bWJlcikgewogICAgICB2YXIgYiA9IG51bWJlciAlIDEwLAogICAgICAgICAgb3V0cHV0ID0gdG9JbnQobnVtYmVyICUgMTAwIC8gMTApID09PSAxID8gJ3RoJyA6IGIgPT09IDEgPyAnc3QnIDogYiA9PT0gMiA/ICduZCcgOiBiID09PSAzID8gJ3JkJyA6ICd0aCc7CiAgICAgIHJldHVybiBudW1iZXIgKyBvdXRwdXQ7CiAgICB9CiAgfSk7IC8vIFNpZGUgZWZmZWN0IGltcG9ydHMKCiAgaG9va3MubGFuZyA9IGRlcHJlY2F0ZSgnbW9tZW50LmxhbmcgaXMgZGVwcmVjYXRlZC4gVXNlIG1vbWVudC5sb2NhbGUgaW5zdGVhZC4nLCBnZXRTZXRHbG9iYWxMb2NhbGUpOwogIGhvb2tzLmxhbmdEYXRhID0gZGVwcmVjYXRlKCdtb21lbnQubGFuZ0RhdGEgaXMgZGVwcmVjYXRlZC4gVXNlIG1vbWVudC5sb2NhbGVEYXRhIGluc3RlYWQuJywgZ2V0TG9jYWxlKTsKICB2YXIgbWF0aEFicyA9IE1hdGguYWJzOwoKICBmdW5jdGlvbiBhYnMoKSB7CiAgICB2YXIgZGF0YSA9IHRoaXMuX2RhdGE7CiAgICB0aGlzLl9taWxsaXNlY29uZHMgPSBtYXRoQWJzKHRoaXMuX21pbGxpc2Vjb25kcyk7CiAgICB0aGlzLl9kYXlzID0gbWF0aEFicyh0aGlzLl9kYXlzKTsKICAgIHRoaXMuX21vbnRocyA9IG1hdGhBYnModGhpcy5fbW9udGhzKTsKICAgIGRhdGEubWlsbGlzZWNvbmRzID0gbWF0aEFicyhkYXRhLm1pbGxpc2Vjb25kcyk7CiAgICBkYXRhLnNlY29uZHMgPSBtYXRoQWJzKGRhdGEuc2Vjb25kcyk7CiAgICBkYXRhLm1pbnV0ZXMgPSBtYXRoQWJzKGRhdGEubWludXRlcyk7CiAgICBkYXRhLmhvdXJzID0gbWF0aEFicyhkYXRhLmhvdXJzKTsKICAgIGRhdGEubW9udGhzID0gbWF0aEFicyhkYXRhLm1vbnRocyk7CiAgICBkYXRhLnllYXJzID0gbWF0aEFicyhkYXRhLnllYXJzKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgZnVuY3Rpb24gYWRkU3VidHJhY3QkMShkdXJhdGlvbiwgaW5wdXQsIHZhbHVlLCBkaXJlY3Rpb24pIHsKICAgIHZhciBvdGhlciA9IGNyZWF0ZUR1cmF0aW9uKGlucHV0LCB2YWx1ZSk7CiAgICBkdXJhdGlvbi5fbWlsbGlzZWNvbmRzICs9IGRpcmVjdGlvbiAqIG90aGVyLl9taWxsaXNlY29uZHM7CiAgICBkdXJhdGlvbi5fZGF5cyArPSBkaXJlY3Rpb24gKiBvdGhlci5fZGF5czsKICAgIGR1cmF0aW9uLl9tb250aHMgKz0gZGlyZWN0aW9uICogb3RoZXIuX21vbnRoczsKICAgIHJldHVybiBkdXJhdGlvbi5fYnViYmxlKCk7CiAgfSAvLyBzdXBwb3J0cyBvbmx5IDIuMC1zdHlsZSBhZGQoMSwgJ3MnKSBvciBhZGQoZHVyYXRpb24pCgoKICBmdW5jdGlvbiBhZGQkMShpbnB1dCwgdmFsdWUpIHsKICAgIHJldHVybiBhZGRTdWJ0cmFjdCQxKHRoaXMsIGlucHV0LCB2YWx1ZSwgMSk7CiAgfSAvLyBzdXBwb3J0cyBvbmx5IDIuMC1zdHlsZSBzdWJ0cmFjdCgxLCAncycpIG9yIHN1YnRyYWN0KGR1cmF0aW9uKQoKCiAgZnVuY3Rpb24gc3VidHJhY3QkMShpbnB1dCwgdmFsdWUpIHsKICAgIHJldHVybiBhZGRTdWJ0cmFjdCQxKHRoaXMsIGlucHV0LCB2YWx1ZSwgLTEpOwogIH0KCiAgZnVuY3Rpb24gYWJzQ2VpbChudW1iZXIpIHsKICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgIHJldHVybiBNYXRoLmZsb29yKG51bWJlcik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gTWF0aC5jZWlsKG51bWJlcik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBidWJibGUoKSB7CiAgICB2YXIgbWlsbGlzZWNvbmRzID0gdGhpcy5fbWlsbGlzZWNvbmRzLAogICAgICAgIGRheXMgPSB0aGlzLl9kYXlzLAogICAgICAgIG1vbnRocyA9IHRoaXMuX21vbnRocywKICAgICAgICBkYXRhID0gdGhpcy5fZGF0YSwKICAgICAgICBzZWNvbmRzLAogICAgICAgIG1pbnV0ZXMsCiAgICAgICAgaG91cnMsCiAgICAgICAgeWVhcnMsCiAgICAgICAgbW9udGhzRnJvbURheXM7IC8vIGlmIHdlIGhhdmUgYSBtaXggb2YgcG9zaXRpdmUgYW5kIG5lZ2F0aXZlIHZhbHVlcywgYnViYmxlIGRvd24gZmlyc3QKICAgIC8vIGNoZWNrOiBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMjE2NgoKICAgIGlmICghKG1pbGxpc2Vjb25kcyA+PSAwICYmIGRheXMgPj0gMCAmJiBtb250aHMgPj0gMCB8fCBtaWxsaXNlY29uZHMgPD0gMCAmJiBkYXlzIDw9IDAgJiYgbW9udGhzIDw9IDApKSB7CiAgICAgIG1pbGxpc2Vjb25kcyArPSBhYnNDZWlsKG1vbnRoc1RvRGF5cyhtb250aHMpICsgZGF5cykgKiA4NjRlNTsKICAgICAgZGF5cyA9IDA7CiAgICAgIG1vbnRocyA9IDA7CiAgICB9IC8vIFRoZSBmb2xsb3dpbmcgY29kZSBidWJibGVzIHVwIHZhbHVlcywgc2VlIHRoZSB0ZXN0cyBmb3IKICAgIC8vIGV4YW1wbGVzIG9mIHdoYXQgdGhhdCBtZWFucy4KCgogICAgZGF0YS5taWxsaXNlY29uZHMgPSBtaWxsaXNlY29uZHMgJSAxMDAwOwogICAgc2Vjb25kcyA9IGFic0Zsb29yKG1pbGxpc2Vjb25kcyAvIDEwMDApOwogICAgZGF0YS5zZWNvbmRzID0gc2Vjb25kcyAlIDYwOwogICAgbWludXRlcyA9IGFic0Zsb29yKHNlY29uZHMgLyA2MCk7CiAgICBkYXRhLm1pbnV0ZXMgPSBtaW51dGVzICUgNjA7CiAgICBob3VycyA9IGFic0Zsb29yKG1pbnV0ZXMgLyA2MCk7CiAgICBkYXRhLmhvdXJzID0gaG91cnMgJSAyNDsKICAgIGRheXMgKz0gYWJzRmxvb3IoaG91cnMgLyAyNCk7IC8vIGNvbnZlcnQgZGF5cyB0byBtb250aHMKCiAgICBtb250aHNGcm9tRGF5cyA9IGFic0Zsb29yKGRheXNUb01vbnRocyhkYXlzKSk7CiAgICBtb250aHMgKz0gbW9udGhzRnJvbURheXM7CiAgICBkYXlzIC09IGFic0NlaWwobW9udGhzVG9EYXlzKG1vbnRoc0Zyb21EYXlzKSk7IC8vIDEyIG1vbnRocyAtPiAxIHllYXIKCiAgICB5ZWFycyA9IGFic0Zsb29yKG1vbnRocyAvIDEyKTsKICAgIG1vbnRocyAlPSAxMjsKICAgIGRhdGEuZGF5cyA9IGRheXM7CiAgICBkYXRhLm1vbnRocyA9IG1vbnRoczsKICAgIGRhdGEueWVhcnMgPSB5ZWFyczsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgZnVuY3Rpb24gZGF5c1RvTW9udGhzKGRheXMpIHsKICAgIC8vIDQwMCB5ZWFycyBoYXZlIDE0NjA5NyBkYXlzICh0YWtpbmcgaW50byBhY2NvdW50IGxlYXAgeWVhciBydWxlcykKICAgIC8vIDQwMCB5ZWFycyBoYXZlIDEyIG1vbnRocyA9PT0gNDgwMAogICAgcmV0dXJuIGRheXMgKiA0ODAwIC8gMTQ2MDk3OwogIH0KCiAgZnVuY3Rpb24gbW9udGhzVG9EYXlzKG1vbnRocykgewogICAgLy8gdGhlIHJldmVyc2Ugb2YgZGF5c1RvTW9udGhzCiAgICByZXR1cm4gbW9udGhzICogMTQ2MDk3IC8gNDgwMDsKICB9CgogIGZ1bmN0aW9uIGFzKHVuaXRzKSB7CiAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgIHJldHVybiBOYU47CiAgICB9CgogICAgdmFyIGRheXMsCiAgICAgICAgbW9udGhzLAogICAgICAgIG1pbGxpc2Vjb25kcyA9IHRoaXMuX21pbGxpc2Vjb25kczsKICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwoKICAgIGlmICh1bml0cyA9PT0gJ21vbnRoJyB8fCB1bml0cyA9PT0gJ3F1YXJ0ZXInIHx8IHVuaXRzID09PSAneWVhcicpIHsKICAgICAgZGF5cyA9IHRoaXMuX2RheXMgKyBtaWxsaXNlY29uZHMgLyA4NjRlNTsKICAgICAgbW9udGhzID0gdGhpcy5fbW9udGhzICsgZGF5c1RvTW9udGhzKGRheXMpOwoKICAgICAgc3dpdGNoICh1bml0cykgewogICAgICAgIGNhc2UgJ21vbnRoJzoKICAgICAgICAgIHJldHVybiBtb250aHM7CgogICAgICAgIGNhc2UgJ3F1YXJ0ZXInOgogICAgICAgICAgcmV0dXJuIG1vbnRocyAvIDM7CgogICAgICAgIGNhc2UgJ3llYXInOgogICAgICAgICAgcmV0dXJuIG1vbnRocyAvIDEyOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBoYW5kbGUgbWlsbGlzZWNvbmRzIHNlcGFyYXRlbHkgYmVjYXVzZSBvZiBmbG9hdGluZyBwb2ludCBtYXRoIGVycm9ycyAoaXNzdWUgIzE4NjcpCiAgICAgIGRheXMgPSB0aGlzLl9kYXlzICsgTWF0aC5yb3VuZChtb250aHNUb0RheXModGhpcy5fbW9udGhzKSk7CgogICAgICBzd2l0Y2ggKHVuaXRzKSB7CiAgICAgICAgY2FzZSAnd2Vlayc6CiAgICAgICAgICByZXR1cm4gZGF5cyAvIDcgKyBtaWxsaXNlY29uZHMgLyA2MDQ4ZTU7CgogICAgICAgIGNhc2UgJ2RheSc6CiAgICAgICAgICByZXR1cm4gZGF5cyArIG1pbGxpc2Vjb25kcyAvIDg2NGU1OwoKICAgICAgICBjYXNlICdob3VyJzoKICAgICAgICAgIHJldHVybiBkYXlzICogMjQgKyBtaWxsaXNlY29uZHMgLyAzNmU1OwoKICAgICAgICBjYXNlICdtaW51dGUnOgogICAgICAgICAgcmV0dXJuIGRheXMgKiAxNDQwICsgbWlsbGlzZWNvbmRzIC8gNmU0OwoKICAgICAgICBjYXNlICdzZWNvbmQnOgogICAgICAgICAgcmV0dXJuIGRheXMgKiA4NjQwMCArIG1pbGxpc2Vjb25kcyAvIDEwMDA7CiAgICAgICAgLy8gTWF0aC5mbG9vciBwcmV2ZW50cyBmbG9hdGluZyBwb2ludCBtYXRoIGVycm9ycyBoZXJlCgogICAgICAgIGNhc2UgJ21pbGxpc2Vjb25kJzoKICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKGRheXMgKiA4NjRlNSkgKyBtaWxsaXNlY29uZHM7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdW5pdCAnICsgdW5pdHMpOwogICAgICB9CiAgICB9CiAgfSAvLyBUT0RPOiBVc2UgdGhpcy5hcygnbXMnKT8KCgogIGZ1bmN0aW9uIHZhbHVlT2YkMSgpIHsKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgcmV0dXJuIE5hTjsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fbWlsbGlzZWNvbmRzICsgdGhpcy5fZGF5cyAqIDg2NGU1ICsgdGhpcy5fbW9udGhzICUgMTIgKiAyNTkyZTYgKyB0b0ludCh0aGlzLl9tb250aHMgLyAxMikgKiAzMTUzNmU2OwogIH0KCiAgZnVuY3Rpb24gbWFrZUFzKGFsaWFzKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5hcyhhbGlhcyk7CiAgICB9OwogIH0KCiAgdmFyIGFzTWlsbGlzZWNvbmRzID0gbWFrZUFzKCdtcycpLAogICAgICBhc1NlY29uZHMgPSBtYWtlQXMoJ3MnKSwKICAgICAgYXNNaW51dGVzID0gbWFrZUFzKCdtJyksCiAgICAgIGFzSG91cnMgPSBtYWtlQXMoJ2gnKSwKICAgICAgYXNEYXlzID0gbWFrZUFzKCdkJyksCiAgICAgIGFzV2Vla3MgPSBtYWtlQXMoJ3cnKSwKICAgICAgYXNNb250aHMgPSBtYWtlQXMoJ00nKSwKICAgICAgYXNRdWFydGVycyA9IG1ha2VBcygnUScpLAogICAgICBhc1llYXJzID0gbWFrZUFzKCd5Jyk7CgogIGZ1bmN0aW9uIGNsb25lJDEoKSB7CiAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24odGhpcyk7CiAgfQoKICBmdW5jdGlvbiBnZXQkMih1bml0cykgewogICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICByZXR1cm4gdGhpcy5pc1ZhbGlkKCkgPyB0aGlzW3VuaXRzICsgJ3MnXSgpIDogTmFOOwogIH0KCiAgZnVuY3Rpb24gbWFrZUdldHRlcihuYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5pc1ZhbGlkKCkgPyB0aGlzLl9kYXRhW25hbWVdIDogTmFOOwogICAgfTsKICB9CgogIHZhciBtaWxsaXNlY29uZHMgPSBtYWtlR2V0dGVyKCdtaWxsaXNlY29uZHMnKSwKICAgICAgc2Vjb25kcyA9IG1ha2VHZXR0ZXIoJ3NlY29uZHMnKSwKICAgICAgbWludXRlcyA9IG1ha2VHZXR0ZXIoJ21pbnV0ZXMnKSwKICAgICAgaG91cnMgPSBtYWtlR2V0dGVyKCdob3VycycpLAogICAgICBkYXlzID0gbWFrZUdldHRlcignZGF5cycpLAogICAgICBtb250aHMgPSBtYWtlR2V0dGVyKCdtb250aHMnKSwKICAgICAgeWVhcnMgPSBtYWtlR2V0dGVyKCd5ZWFycycpOwoKICBmdW5jdGlvbiB3ZWVrcygpIHsKICAgIHJldHVybiBhYnNGbG9vcih0aGlzLmRheXMoKSAvIDcpOwogIH0KCiAgdmFyIHJvdW5kID0gTWF0aC5yb3VuZCwKICAgICAgdGhyZXNob2xkcyA9IHsKICAgIHNzOiA0NCwKICAgIC8vIGEgZmV3IHNlY29uZHMgdG8gc2Vjb25kcwogICAgczogNDUsCiAgICAvLyBzZWNvbmRzIHRvIG1pbnV0ZQogICAgbTogNDUsCiAgICAvLyBtaW51dGVzIHRvIGhvdXIKICAgIGg6IDIyLAogICAgLy8gaG91cnMgdG8gZGF5CiAgICBkOiAyNiwKICAgIC8vIGRheXMgdG8gbW9udGgvd2VlawogICAgdzogbnVsbCwKICAgIC8vIHdlZWtzIHRvIG1vbnRoCiAgICBNOiAxMSAvLyBtb250aHMgdG8geWVhcgoKICB9OyAvLyBoZWxwZXIgZnVuY3Rpb24gZm9yIG1vbWVudC5mbi5mcm9tLCBtb21lbnQuZm4uZnJvbU5vdywgYW5kIG1vbWVudC5kdXJhdGlvbi5mbi5odW1hbml6ZQoKICBmdW5jdGlvbiBzdWJzdGl0dXRlVGltZUFnbyhzdHJpbmcsIG51bWJlciwgd2l0aG91dFN1ZmZpeCwgaXNGdXR1cmUsIGxvY2FsZSkgewogICAgcmV0dXJuIGxvY2FsZS5yZWxhdGl2ZVRpbWUobnVtYmVyIHx8IDEsICEhd2l0aG91dFN1ZmZpeCwgc3RyaW5nLCBpc0Z1dHVyZSk7CiAgfQoKICBmdW5jdGlvbiByZWxhdGl2ZVRpbWUkMShwb3NOZWdEdXJhdGlvbiwgd2l0aG91dFN1ZmZpeCwgdGhyZXNob2xkcywgbG9jYWxlKSB7CiAgICB2YXIgZHVyYXRpb24gPSBjcmVhdGVEdXJhdGlvbihwb3NOZWdEdXJhdGlvbikuYWJzKCksCiAgICAgICAgc2Vjb25kcyA9IHJvdW5kKGR1cmF0aW9uLmFzKCdzJykpLAogICAgICAgIG1pbnV0ZXMgPSByb3VuZChkdXJhdGlvbi5hcygnbScpKSwKICAgICAgICBob3VycyA9IHJvdW5kKGR1cmF0aW9uLmFzKCdoJykpLAogICAgICAgIGRheXMgPSByb3VuZChkdXJhdGlvbi5hcygnZCcpKSwKICAgICAgICBtb250aHMgPSByb3VuZChkdXJhdGlvbi5hcygnTScpKSwKICAgICAgICB3ZWVrcyA9IHJvdW5kKGR1cmF0aW9uLmFzKCd3JykpLAogICAgICAgIHllYXJzID0gcm91bmQoZHVyYXRpb24uYXMoJ3knKSksCiAgICAgICAgYSA9IHNlY29uZHMgPD0gdGhyZXNob2xkcy5zcyAmJiBbJ3MnLCBzZWNvbmRzXSB8fCBzZWNvbmRzIDwgdGhyZXNob2xkcy5zICYmIFsnc3MnLCBzZWNvbmRzXSB8fCBtaW51dGVzIDw9IDEgJiYgWydtJ10gfHwgbWludXRlcyA8IHRocmVzaG9sZHMubSAmJiBbJ21tJywgbWludXRlc10gfHwgaG91cnMgPD0gMSAmJiBbJ2gnXSB8fCBob3VycyA8IHRocmVzaG9sZHMuaCAmJiBbJ2hoJywgaG91cnNdIHx8IGRheXMgPD0gMSAmJiBbJ2QnXSB8fCBkYXlzIDwgdGhyZXNob2xkcy5kICYmIFsnZGQnLCBkYXlzXTsKCiAgICBpZiAodGhyZXNob2xkcy53ICE9IG51bGwpIHsKICAgICAgYSA9IGEgfHwgd2Vla3MgPD0gMSAmJiBbJ3cnXSB8fCB3ZWVrcyA8IHRocmVzaG9sZHMudyAmJiBbJ3d3Jywgd2Vla3NdOwogICAgfQoKICAgIGEgPSBhIHx8IG1vbnRocyA8PSAxICYmIFsnTSddIHx8IG1vbnRocyA8IHRocmVzaG9sZHMuTSAmJiBbJ01NJywgbW9udGhzXSB8fCB5ZWFycyA8PSAxICYmIFsneSddIHx8IFsneXknLCB5ZWFyc107CiAgICBhWzJdID0gd2l0aG91dFN1ZmZpeDsKICAgIGFbM10gPSArcG9zTmVnRHVyYXRpb24gPiAwOwogICAgYVs0XSA9IGxvY2FsZTsKICAgIHJldHVybiBzdWJzdGl0dXRlVGltZUFnby5hcHBseShudWxsLCBhKTsKICB9IC8vIFRoaXMgZnVuY3Rpb24gYWxsb3dzIHlvdSB0byBzZXQgdGhlIHJvdW5kaW5nIGZ1bmN0aW9uIGZvciByZWxhdGl2ZSB0aW1lIHN0cmluZ3MKCgogIGZ1bmN0aW9uIGdldFNldFJlbGF0aXZlVGltZVJvdW5kaW5nKHJvdW5kaW5nRnVuY3Rpb24pIHsKICAgIGlmIChyb3VuZGluZ0Z1bmN0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIHJvdW5kOwogICAgfQoKICAgIGlmICh0eXBlb2Ygcm91bmRpbmdGdW5jdGlvbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByb3VuZCA9IHJvdW5kaW5nRnVuY3Rpb247CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9IC8vIFRoaXMgZnVuY3Rpb24gYWxsb3dzIHlvdSB0byBzZXQgYSB0aHJlc2hvbGQgZm9yIHJlbGF0aXZlIHRpbWUgc3RyaW5ncwoKCiAgZnVuY3Rpb24gZ2V0U2V0UmVsYXRpdmVUaW1lVGhyZXNob2xkKHRocmVzaG9sZCwgbGltaXQpIHsKICAgIGlmICh0aHJlc2hvbGRzW3RocmVzaG9sZF0gPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKGxpbWl0ID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIHRocmVzaG9sZHNbdGhyZXNob2xkXTsKICAgIH0KCiAgICB0aHJlc2hvbGRzW3RocmVzaG9sZF0gPSBsaW1pdDsKCiAgICBpZiAodGhyZXNob2xkID09PSAncycpIHsKICAgICAgdGhyZXNob2xkcy5zcyA9IGxpbWl0IC0gMTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGh1bWFuaXplKGFyZ1dpdGhTdWZmaXgsIGFyZ1RocmVzaG9sZHMpIHsKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICB9CgogICAgdmFyIHdpdGhTdWZmaXggPSBmYWxzZSwKICAgICAgICB0aCA9IHRocmVzaG9sZHMsCiAgICAgICAgbG9jYWxlLAogICAgICAgIG91dHB1dDsKCiAgICBpZiAoX3R5cGVvZihhcmdXaXRoU3VmZml4KSA9PT0gJ29iamVjdCcpIHsKICAgICAgYXJnVGhyZXNob2xkcyA9IGFyZ1dpdGhTdWZmaXg7CiAgICAgIGFyZ1dpdGhTdWZmaXggPSBmYWxzZTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGFyZ1dpdGhTdWZmaXggPT09ICdib29sZWFuJykgewogICAgICB3aXRoU3VmZml4ID0gYXJnV2l0aFN1ZmZpeDsKICAgIH0KCiAgICBpZiAoX3R5cGVvZihhcmdUaHJlc2hvbGRzKSA9PT0gJ29iamVjdCcpIHsKICAgICAgdGggPSBPYmplY3QuYXNzaWduKHt9LCB0aHJlc2hvbGRzLCBhcmdUaHJlc2hvbGRzKTsKCiAgICAgIGlmIChhcmdUaHJlc2hvbGRzLnMgIT0gbnVsbCAmJiBhcmdUaHJlc2hvbGRzLnNzID09IG51bGwpIHsKICAgICAgICB0aC5zcyA9IGFyZ1RocmVzaG9sZHMucyAtIDE7CiAgICAgIH0KICAgIH0KCiAgICBsb2NhbGUgPSB0aGlzLmxvY2FsZURhdGEoKTsKICAgIG91dHB1dCA9IHJlbGF0aXZlVGltZSQxKHRoaXMsICF3aXRoU3VmZml4LCB0aCwgbG9jYWxlKTsKCiAgICBpZiAod2l0aFN1ZmZpeCkgewogICAgICBvdXRwdXQgPSBsb2NhbGUucGFzdEZ1dHVyZSgrdGhpcywgb3V0cHV0KTsKICAgIH0KCiAgICByZXR1cm4gbG9jYWxlLnBvc3Rmb3JtYXQob3V0cHV0KTsKICB9CgogIHZhciBhYnMkMSA9IE1hdGguYWJzOwoKICBmdW5jdGlvbiBzaWduKHgpIHsKICAgIHJldHVybiAoeCA+IDApIC0gKHggPCAwKSB8fCAreDsKICB9CgogIGZ1bmN0aW9uIHRvSVNPU3RyaW5nJDEoKSB7CiAgICAvLyBmb3IgSVNPIHN0cmluZ3Mgd2UgZG8gbm90IHVzZSB0aGUgbm9ybWFsIGJ1YmJsaW5nIHJ1bGVzOgogICAgLy8gICogbWlsbGlzZWNvbmRzIGJ1YmJsZSB1cCB1bnRpbCB0aGV5IGJlY29tZSBob3VycwogICAgLy8gICogZGF5cyBkbyBub3QgYnViYmxlIGF0IGFsbAogICAgLy8gICogbW9udGhzIGJ1YmJsZSB1cCB1bnRpbCB0aGV5IGJlY29tZSB5ZWFycwogICAgLy8gVGhpcyBpcyBiZWNhdXNlIHRoZXJlIGlzIG5vIGNvbnRleHQtZnJlZSBjb252ZXJzaW9uIGJldHdlZW4gaG91cnMgYW5kIGRheXMKICAgIC8vICh0aGluayBvZiBjbG9jayBjaGFuZ2VzKQogICAgLy8gYW5kIGFsc28gbm90IGJldHdlZW4gZGF5cyBhbmQgbW9udGhzICgyOC0zMSBkYXlzIHBlciBtb250aCkKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICB9CgogICAgdmFyIHNlY29uZHMgPSBhYnMkMSh0aGlzLl9taWxsaXNlY29uZHMpIC8gMTAwMCwKICAgICAgICBkYXlzID0gYWJzJDEodGhpcy5fZGF5cyksCiAgICAgICAgbW9udGhzID0gYWJzJDEodGhpcy5fbW9udGhzKSwKICAgICAgICBtaW51dGVzLAogICAgICAgIGhvdXJzLAogICAgICAgIHllYXJzLAogICAgICAgIHMsCiAgICAgICAgdG90YWwgPSB0aGlzLmFzU2Vjb25kcygpLAogICAgICAgIHRvdGFsU2lnbiwKICAgICAgICB5bVNpZ24sCiAgICAgICAgZGF5c1NpZ24sCiAgICAgICAgaG1zU2lnbjsKCiAgICBpZiAoIXRvdGFsKSB7CiAgICAgIC8vIHRoaXMgaXMgdGhlIHNhbWUgYXMgQyMncyAoTm9kYSkgYW5kIHB5dGhvbiAoaXNvZGF0ZSkuLi4KICAgICAgLy8gYnV0IG5vdCBvdGhlciBKUyAoZ29vZy5kYXRlKQogICAgICByZXR1cm4gJ1AwRCc7CiAgICB9IC8vIDM2MDAgc2Vjb25kcyAtPiA2MCBtaW51dGVzIC0+IDEgaG91cgoKCiAgICBtaW51dGVzID0gYWJzRmxvb3Ioc2Vjb25kcyAvIDYwKTsKICAgIGhvdXJzID0gYWJzRmxvb3IobWludXRlcyAvIDYwKTsKICAgIHNlY29uZHMgJT0gNjA7CiAgICBtaW51dGVzICU9IDYwOyAvLyAxMiBtb250aHMgLT4gMSB5ZWFyCgogICAgeWVhcnMgPSBhYnNGbG9vcihtb250aHMgLyAxMik7CiAgICBtb250aHMgJT0gMTI7IC8vIGluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9kb3JkaWxsZS9tb21lbnQtaXNvZHVyYXRpb24vYmxvYi9tYXN0ZXIvbW9tZW50Lmlzb2R1cmF0aW9uLmpzCgogICAgcyA9IHNlY29uZHMgPyBzZWNvbmRzLnRvRml4ZWQoMykucmVwbGFjZSgvXC4/MCskLywgJycpIDogJyc7CiAgICB0b3RhbFNpZ24gPSB0b3RhbCA8IDAgPyAnLScgOiAnJzsKICAgIHltU2lnbiA9IHNpZ24odGhpcy5fbW9udGhzKSAhPT0gc2lnbih0b3RhbCkgPyAnLScgOiAnJzsKICAgIGRheXNTaWduID0gc2lnbih0aGlzLl9kYXlzKSAhPT0gc2lnbih0b3RhbCkgPyAnLScgOiAnJzsKICAgIGhtc1NpZ24gPSBzaWduKHRoaXMuX21pbGxpc2Vjb25kcykgIT09IHNpZ24odG90YWwpID8gJy0nIDogJyc7CiAgICByZXR1cm4gdG90YWxTaWduICsgJ1AnICsgKHllYXJzID8geW1TaWduICsgeWVhcnMgKyAnWScgOiAnJykgKyAobW9udGhzID8geW1TaWduICsgbW9udGhzICsgJ00nIDogJycpICsgKGRheXMgPyBkYXlzU2lnbiArIGRheXMgKyAnRCcgOiAnJykgKyAoaG91cnMgfHwgbWludXRlcyB8fCBzZWNvbmRzID8gJ1QnIDogJycpICsgKGhvdXJzID8gaG1zU2lnbiArIGhvdXJzICsgJ0gnIDogJycpICsgKG1pbnV0ZXMgPyBobXNTaWduICsgbWludXRlcyArICdNJyA6ICcnKSArIChzZWNvbmRzID8gaG1zU2lnbiArIHMgKyAnUycgOiAnJyk7CiAgfQoKICB2YXIgcHJvdG8kMiA9IER1cmF0aW9uLnByb3RvdHlwZTsKICBwcm90byQyLmlzVmFsaWQgPSBpc1ZhbGlkJDE7CiAgcHJvdG8kMi5hYnMgPSBhYnM7CiAgcHJvdG8kMi5hZGQgPSBhZGQkMTsKICBwcm90byQyLnN1YnRyYWN0ID0gc3VidHJhY3QkMTsKICBwcm90byQyLmFzID0gYXM7CiAgcHJvdG8kMi5hc01pbGxpc2Vjb25kcyA9IGFzTWlsbGlzZWNvbmRzOwogIHByb3RvJDIuYXNTZWNvbmRzID0gYXNTZWNvbmRzOwogIHByb3RvJDIuYXNNaW51dGVzID0gYXNNaW51dGVzOwogIHByb3RvJDIuYXNIb3VycyA9IGFzSG91cnM7CiAgcHJvdG8kMi5hc0RheXMgPSBhc0RheXM7CiAgcHJvdG8kMi5hc1dlZWtzID0gYXNXZWVrczsKICBwcm90byQyLmFzTW9udGhzID0gYXNNb250aHM7CiAgcHJvdG8kMi5hc1F1YXJ0ZXJzID0gYXNRdWFydGVyczsKICBwcm90byQyLmFzWWVhcnMgPSBhc1llYXJzOwogIHByb3RvJDIudmFsdWVPZiA9IHZhbHVlT2YkMTsKICBwcm90byQyLl9idWJibGUgPSBidWJibGU7CiAgcHJvdG8kMi5jbG9uZSA9IGNsb25lJDE7CiAgcHJvdG8kMi5nZXQgPSBnZXQkMjsKICBwcm90byQyLm1pbGxpc2Vjb25kcyA9IG1pbGxpc2Vjb25kczsKICBwcm90byQyLnNlY29uZHMgPSBzZWNvbmRzOwogIHByb3RvJDIubWludXRlcyA9IG1pbnV0ZXM7CiAgcHJvdG8kMi5ob3VycyA9IGhvdXJzOwogIHByb3RvJDIuZGF5cyA9IGRheXM7CiAgcHJvdG8kMi53ZWVrcyA9IHdlZWtzOwogIHByb3RvJDIubW9udGhzID0gbW9udGhzOwogIHByb3RvJDIueWVhcnMgPSB5ZWFyczsKICBwcm90byQyLmh1bWFuaXplID0gaHVtYW5pemU7CiAgcHJvdG8kMi50b0lTT1N0cmluZyA9IHRvSVNPU3RyaW5nJDE7CiAgcHJvdG8kMi50b1N0cmluZyA9IHRvSVNPU3RyaW5nJDE7CiAgcHJvdG8kMi50b0pTT04gPSB0b0lTT1N0cmluZyQxOwogIHByb3RvJDIubG9jYWxlID0gbG9jYWxlOwogIHByb3RvJDIubG9jYWxlRGF0YSA9IGxvY2FsZURhdGE7CiAgcHJvdG8kMi50b0lzb1N0cmluZyA9IGRlcHJlY2F0ZSgndG9Jc29TdHJpbmcoKSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIHRvSVNPU3RyaW5nKCkgaW5zdGVhZCAobm90aWNlIHRoZSBjYXBpdGFscyknLCB0b0lTT1N0cmluZyQxKTsKICBwcm90byQyLmxhbmcgPSBsYW5nOyAvLyBGT1JNQVRUSU5HCgogIGFkZEZvcm1hdFRva2VuKCdYJywgMCwgMCwgJ3VuaXgnKTsKICBhZGRGb3JtYXRUb2tlbigneCcsIDAsIDAsICd2YWx1ZU9mJyk7IC8vIFBBUlNJTkcKCiAgYWRkUmVnZXhUb2tlbigneCcsIG1hdGNoU2lnbmVkKTsKICBhZGRSZWdleFRva2VuKCdYJywgbWF0Y2hUaW1lc3RhbXApOwogIGFkZFBhcnNlVG9rZW4oJ1gnLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcpIHsKICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKHBhcnNlRmxvYXQoaW5wdXQpICogMTAwMCk7CiAgfSk7CiAgYWRkUGFyc2VUb2tlbigneCcsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgY29uZmlnLl9kID0gbmV3IERhdGUodG9JbnQoaW5wdXQpKTsKICB9KTsgLy8hIG1vbWVudC5qcwoKICBob29rcy52ZXJzaW9uID0gJzIuMjkuMSc7CiAgc2V0SG9va0NhbGxiYWNrKGNyZWF0ZUxvY2FsKTsKICBob29rcy5mbiA9IHByb3RvOwogIGhvb2tzLm1pbiA9IG1pbjsKICBob29rcy5tYXggPSBtYXg7CiAgaG9va3Mubm93ID0gbm93OwogIGhvb2tzLnV0YyA9IGNyZWF0ZVVUQzsKICBob29rcy51bml4ID0gY3JlYXRlVW5peDsKICBob29rcy5tb250aHMgPSBsaXN0TW9udGhzOwogIGhvb2tzLmlzRGF0ZSA9IGlzRGF0ZTsKICBob29rcy5sb2NhbGUgPSBnZXRTZXRHbG9iYWxMb2NhbGU7CiAgaG9va3MuaW52YWxpZCA9IGNyZWF0ZUludmFsaWQ7CiAgaG9va3MuZHVyYXRpb24gPSBjcmVhdGVEdXJhdGlvbjsKICBob29rcy5pc01vbWVudCA9IGlzTW9tZW50OwogIGhvb2tzLndlZWtkYXlzID0gbGlzdFdlZWtkYXlzOwogIGhvb2tzLnBhcnNlWm9uZSA9IGNyZWF0ZUluWm9uZTsKICBob29rcy5sb2NhbGVEYXRhID0gZ2V0TG9jYWxlOwogIGhvb2tzLmlzRHVyYXRpb24gPSBpc0R1cmF0aW9uOwogIGhvb2tzLm1vbnRoc1Nob3J0ID0gbGlzdE1vbnRoc1Nob3J0OwogIGhvb2tzLndlZWtkYXlzTWluID0gbGlzdFdlZWtkYXlzTWluOwogIGhvb2tzLmRlZmluZUxvY2FsZSA9IGRlZmluZUxvY2FsZTsKICBob29rcy51cGRhdGVMb2NhbGUgPSB1cGRhdGVMb2NhbGU7CiAgaG9va3MubG9jYWxlcyA9IGxpc3RMb2NhbGVzOwogIGhvb2tzLndlZWtkYXlzU2hvcnQgPSBsaXN0V2Vla2RheXNTaG9ydDsKICBob29rcy5ub3JtYWxpemVVbml0cyA9IG5vcm1hbGl6ZVVuaXRzOwogIGhvb2tzLnJlbGF0aXZlVGltZVJvdW5kaW5nID0gZ2V0U2V0UmVsYXRpdmVUaW1lUm91bmRpbmc7CiAgaG9va3MucmVsYXRpdmVUaW1lVGhyZXNob2xkID0gZ2V0U2V0UmVsYXRpdmVUaW1lVGhyZXNob2xkOwogIGhvb2tzLmNhbGVuZGFyRm9ybWF0ID0gZ2V0Q2FsZW5kYXJGb3JtYXQ7CiAgaG9va3MucHJvdG90eXBlID0gcHJvdG87IC8vIGN1cnJlbnRseSBIVE1MNSBpbnB1dCB0eXBlIG9ubHkgc3VwcG9ydHMgMjQtaG91ciBmb3JtYXRzCgogIGhvb2tzLkhUTUw1X0ZNVCA9IHsKICAgIERBVEVUSU1FX0xPQ0FMOiAnWVlZWS1NTS1ERFRISDptbScsCiAgICAvLyA8aW5wdXQgdHlwZT0iZGF0ZXRpbWUtbG9jYWwiIC8+CiAgICBEQVRFVElNRV9MT0NBTF9TRUNPTkRTOiAnWVlZWS1NTS1ERFRISDptbTpzcycsCiAgICAvLyA8aW5wdXQgdHlwZT0iZGF0ZXRpbWUtbG9jYWwiIHN0ZXA9IjEiIC8+CiAgICBEQVRFVElNRV9MT0NBTF9NUzogJ1lZWVktTU0tRERUSEg6bW06c3MuU1NTJywKICAgIC8vIDxpbnB1dCB0eXBlPSJkYXRldGltZS1sb2NhbCIgc3RlcD0iMC4wMDEiIC8+CiAgICBEQVRFOiAnWVlZWS1NTS1ERCcsCiAgICAvLyA8aW5wdXQgdHlwZT0iZGF0ZSIgLz4KICAgIFRJTUU6ICdISDptbScsCiAgICAvLyA8aW5wdXQgdHlwZT0idGltZSIgLz4KICAgIFRJTUVfU0VDT05EUzogJ0hIOm1tOnNzJywKICAgIC8vIDxpbnB1dCB0eXBlPSJ0aW1lIiBzdGVwPSIxIiAvPgogICAgVElNRV9NUzogJ0hIOm1tOnNzLlNTUycsCiAgICAvLyA8aW5wdXQgdHlwZT0idGltZSIgc3RlcD0iMC4wMDEiIC8+CiAgICBXRUVLOiAnR0dHRy1bV11XVycsCiAgICAvLyA8aW5wdXQgdHlwZT0id2VlayIgLz4KICAgIE1PTlRIOiAnWVlZWS1NTScgLy8gPGlucHV0IHR5cGU9Im1vbnRoIiAvPgoKICB9OwogIHJldHVybiBob29rczsKfSk7"},null]}